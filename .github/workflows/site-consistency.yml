name: Site Consistency Check

on:
  push:
    branches: [ main, master ]
    paths:
      - 'tools/**/*.html'
      - 'index.html'
      - '*.html'
      - 'config/**'
      - 'templates/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'tools/**/*.html'
      - 'index.html'
      - '*.html'
      - 'config/**'
      - 'templates/**'

jobs:
  validate-consistency:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install PowerShell Core
      run: |
        sudo apt-get update
        sudo apt-get install -y wget apt-transport-https software-properties-common
        wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb
        sudo dpkg -i packages-microsoft-prod.deb
        sudo apt-get update
        sudo apt-get install -y powershell
        
    - name: Validate site consistency
      run: |
        pwsh -Command "& './scripts/simple-consistency.ps1' -action validate"
        
    - name: Check HTML validation
      run: |
        # HTMLの基本的な構文チェック
        for file in tools/*.html *.html; do
          if [ -f "$file" ]; then
            echo "Checking $file..."
            # 基本的なHTMLタグの対応チェック
            if ! grep -q "</html>" "$file"; then
              echo "❌ $file: Missing closing </html> tag"
              exit 1
            fi
            if ! grep -q "</body>" "$file"; then
              echo "❌ $file: Missing closing </body> tag"
              exit 1
            fi
            echo "✅ $file: Basic structure OK"
          fi
        done
        
    - name: Check security headers
      run: |
        # セキュリティヘッダーの存在チェック
        for file in tools/*.html *.html; do
          if [ -f "$file" ]; then
            echo "Checking security headers in $file..."
            if ! grep -q "Content-Security-Policy" "$file"; then
              echo "❌ $file: Missing Content-Security-Policy"
              exit 1
            fi
            if ! grep -q "X-Content-Type-Options" "$file"; then
              echo "❌ $file: Missing X-Content-Type-Options"
              exit 1
            fi
            echo "✅ $file: Security headers OK"
          fi
        done
        
    - name: Generate consistency report
      if: always()
      run: |
        echo "## 🔍 Site Consistency Report" > consistency-report.md
        echo "" >> consistency-report.md
        echo "### Files checked:" >> consistency-report.md
        ls -la tools/*.html *.html | grep -v "^d" >> consistency-report.md
        echo "" >> consistency-report.md
        echo "### Validation result:" >> consistency-report.md
        pwsh -Command "& './scripts/simple-consistency.ps1' -action validate" >> consistency-report.md 2>&1 || true
        
    - name: Upload consistency report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: consistency-report
        path: consistency-report.md
        retention-days: 30
