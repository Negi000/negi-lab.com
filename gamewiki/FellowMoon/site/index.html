<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>新月同行 Wiki</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="theme-color" content="#0d1216" />
<!-- Tailwind for shared header/footer styles -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" crossorigin="anonymous" />
<script src="https://cdn.tailwindcss.com"></script>
<script>window.tailwind=window.tailwind||{};window.tailwind.config={theme:{extend:{colors:{accent:'#4ADE80'},fontFamily:{inter:['Inter','sans-serif']}}}};</script>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;margin:0;background:#0d1216;color:#e6edf3;line-height:1.5;-webkit-font-smoothing:antialiased}
:root{--c-accent:#3a8bff;--c-bgcard:#161e26;--c-border:#24303b;--c-soft:#1c2731;--w-wrap:1280px}
/* legacy header styles removed in favor of Tailwind version */
main{max-width:var(--w-wrap);margin:auto;padding:1.2rem .9rem 3rem}
/* ===== 新 Wiki ヒーローヘッダー / メガナビ (スマホファースト) ===== */
.wiki-hero{margin:0 0 1.4rem;position:relative}
.wiki-hero-bar{display:flex;align-items:center;gap:.75rem;background:linear-gradient(135deg,#14212b,#1b2d38 55%,#14212b);border:1px solid #253542;padding:.85rem .95rem;border-radius:16px;position:relative;overflow:hidden}
.wiki-hero-bar:before{content:"";position:absolute;inset:0;background:radial-gradient(circle at 75% 20%,rgba(99,183,255,.25),transparent 60%);pointer-events:none}
.wiki-hero-title{font-size:clamp(1.35rem,5.3vw,2.1rem);line-height:1.05;font-weight:800;letter-spacing:.5px;background:linear-gradient(92deg,#63b7ff,#9ad8ff 45%,#63b7ff);-webkit-background-clip:text;color:transparent;filter:drop-shadow(0 2px 6px rgba(60,130,190,.25))}
.wiki-hero-sub{display:none}
.wiki-search{margin-left:auto;display:flex;align-items:center;min-width:0;position:relative}
.wiki-search input{background:#0f161c;border:1px solid #29404e;color:#d9edff;font-size:.75rem;padding:.55rem .75rem;border-radius:10px;width:170px;transition:.25s}
.wiki-search input:focus{outline:none;border-color:#3a8bff;box-shadow:0 0 0 3px rgba(58,139,255,.25)}
@media(min-width:520px){.wiki-search input{width:220px}}
@media(min-width:900px){.wiki-search input{width:260px}}
.wiki-cat-bar-wrapper{margin-top:.65rem}
.wiki-cat-bar{display:flex;gap:.55rem;overflow-x:auto;padding:.4rem .15rem .15rem;scrollbar-width:none;-ms-overflow-style:none}
.wiki-cat-bar::-webkit-scrollbar{display:none}
.wiki-cat-btn{flex:0 0 auto;position:relative;background:#18232d;border:1px solid #243744;color:#cfe2ff;font-weight:600;font-size:.68rem;letter-spacing:.5px;padding:.55rem .85rem;border-radius:11px;cursor:pointer;display:inline-flex;align-items:center;gap:.45rem;transition:.25s}
.wiki-cat-btn:hover{background:#20303a;border-color:#335063}
.wiki-cat-btn[aria-expanded="true"]{background:#254052;border-color:#3a627b;box-shadow:0 0 0 2px rgba(58,139,255,.25)}
.wiki-cat-btn:after{content:"";width:8px;height:8px;border-right:2px solid #7fbef5;border-bottom:2px solid #7fbef5;transform:rotate(45deg);margin-left:2px;transition:.3s}
.wiki-cat-btn[aria-expanded="true"]:after{transform:rotate(-135deg) translateY(2px)}
.wiki-acc-panels{position:relative;margin-top:.4rem}
.wiki-acc-panel{border:1px solid #2e4250;background:#101a22;border-radius:14px;padding:.9rem .95rem;display:none;animation:accFade .35s ease;box-shadow:0 6px 22px -8px #000a}
.wiki-acc-panel.open{display:block}
@keyframes accFade{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.wiki-acc-grid{display:grid;gap:.65rem;grid-template-columns:repeat(auto-fit,minmax(130px,1fr))}
.wiki-acc-grid a{display:flex;flex-direction:column;gap:.3rem;text-decoration:none;background:#16222b;border:1px solid #243744;padding:.65rem .7rem;border-radius:10px;font-size:.64rem;font-weight:600;color:#c3e6ff;letter-spacing:.4px;position:relative;overflow:hidden}
.wiki-acc-grid a:before{content:"";position:absolute;inset:0;background:linear-gradient(140deg,rgba(99,183,255,.12),transparent 55%);opacity:0;transition:.35s}
.wiki-acc-grid a:hover{background:#1d2d37;border-color:#335063}
.wiki-acc-grid a:hover:before{opacity:1}
.wiki-acc-badge{display:inline-block;background:#254052;color:#9ed8ff;font-size:.55rem;padding:2px 6px;border-radius:8px;margin-left:auto;font-weight:600}
.wiki-note-pending{color:#6c90a5;font-size:.55rem;font-weight:500;margin-top:.25rem}
/* モバイル用: カテゴリ行の下余白を詰める */
@media(min-width:760px){.wiki-acc-grid a{font-size:.62rem}}
/* 旧 quick-grid 削除に伴う調整 */
/* ===== /新ヒーローヘッダー ===== */
.ad-slot{background:#10171d;border:1px dashed #2a3a46;border-radius:10px;min-height:90px;display:flex;align-items:center;justify-content:center;font-size:.6rem;color:#567}
.section{margin:0 0 1.9rem}
.section h2{font-size:clamp(.9rem,3.5vw,1rem);margin:0 0 .9rem;border-left:4px solid var(--c-accent);padding-left:.55rem;line-height:1.1}
.flex-row{display:flex;flex-direction:column;gap:1rem}
@media(min-width:1020px){.flex-row{flex-direction:row}.flex-row > .col{flex:1}}
.card{background:var(--c-bgcard);border:1px solid var(--c-border);border-radius:12px;padding:.85rem .85rem;position:relative}
@media(min-width:760px){.card{padding:1rem .95rem}}
.card h3{margin:.1rem 0 .6rem;font-size:.8rem;letter-spacing:.5px;color:#cfe4ff}
.small{font-size:.65rem;color:#8aa0b1}
.list-plain{list-style:none;margin:0;padding:0;font-size:.68rem}
.list-plain li{padding:.35rem 0;border-bottom:1px solid #1f2a33}
.list-plain li:last-child{border-bottom:none}
.inline-count{background:#243546;padding:2px 6px;font-size:.55rem;border-radius:999px;margin-left:.4rem;color:#9ec5ff}
.stats-bar{height:6px;background:#132028;border-radius:4px;overflow:hidden;margin-top:.4rem}
.stats-bar span{display:block;height:100%;background:linear-gradient(90deg,#3a8bff,#63b7ff)}
.badge{display:inline-block;background:#24313c;border:1px solid #2e3d49;padding:2px 6px;font-size:.55rem;border-radius:7px;margin:.15rem .35rem .15rem 0;color:#8fc4ff;letter-spacing:.5px}
.countdown{font-size:.7rem;font-weight:600;color:#ffe28d}
/* 壁紙背景 + オーバーレイ */
body.has-wallpaper{background:#0d1216 center/cover no-repeat fixed;transition:background-image 0.6s ease;position:relative}
body.has-wallpaper:before{content:"";position:fixed;inset:0;background:rgba(8,12,16,.56);backdrop-filter:blur(2px);z-index:0;pointer-events:none}
header,main,footer{position:relative;z-index:1}
footer{background:#0f161c;border-top:1px solid #1a242d;padding:1.2rem .9rem;margin-top:2rem;font-size:.6rem;color:#7d94a5}
footer .inner{max-width:var(--w-wrap);margin:auto;display:flex;flex-direction:column;gap:.6rem}
/* ディスプレイギャラリー */
.display-area{position:relative;background:rgba(15,22,28,.55);backdrop-filter:blur(4px);border:1px solid #23313c;border-radius:14px;padding:1rem;margin:1.4rem 0}
.display-stage{position:relative;overflow:hidden;border-radius:10px;aspect-ratio:16/9;background:#0b1014;border:1px solid #1f2b34}
.display-stage img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .6s ease}
.display-stage img.active{opacity:1}
.display-controls{display:flex;justify-content:space-between;margin-top:.6rem;gap:.6rem}
.display-btn{flex:1;background:#20303a;color:#cfe2ff;border:1px solid #324754;border-radius:8px;padding:.5rem .8rem;font-size:.65rem;cursor:pointer;letter-spacing:.5px}
.display-btn:hover{background:#2a3f4b}
.display-indicators{display:flex;flex-wrap:wrap;gap:4px;margin-top:.5rem}
.display-indicators span{width:8px;height:8px;border-radius:50%;background:#2a3b46;transition:.3s}
.display-indicators span.active{background:#63b7ff;box-shadow:0 0 4px #63b7ff}
</style>
</head>
<body>
<!-- Header (mobile-first) -->
<header class="wiki-header shadow-md sticky top-0 z-50 font-inter">
  <div class="max-w-7xl mx-auto flex items-center px-3 sm:px-4 py-3 gap-4">
    <a href="/" class="text-xl sm:text-2xl font-extrabold tracking-tight hover:opacity-80 transition" style="color:#63b7ff">negi-lab.com</a>
    <button id="menuToggle" class="ml-auto inline-flex items-center justify-center w-9 h-9 rounded-md border border-[#24303b] bg-[#18232d] text-[#cfe2ff] sm:hidden" aria-label="メニュー" aria-expanded="false">≡</button>
    <nav id="mainNav" class="ml-auto hidden sm:block">
      <ul class="flex flex-col sm:flex-row gap-3 sm:gap-6 font-medium text-base items-start sm:items-center py-3 sm:py-0" data-nav-list>
        <li><a href="/#tools" class="nav-link">ツール</a></li>
        <li><a href="index.html" class="nav-link">新月同行Wiki</a></li>
        <li><a href="chars/index.html" class="nav-link">キャラ一覧</a></li>
      </ul>
    </nav>
  </div>
</header>
<style>
.wiki-header{background:#0f161c;border-bottom:1px solid #18222c}
.wiki-header .nav-link{color:#cfe2ff;transition:color .25s}
.wiki-header .nav-link:hover{color:#63b7ff}
.wiki-header.open #mainNav{display:block}
.wiki-header #mainNav{animation:navFade .25s ease}
@keyframes navFade{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
</style>
<main>
  <section class="wiki-hero" data-wiki-header>
    <div class="wiki-hero-bar">
      <h1 class="wiki-hero-title" aria-label="新月同行 Wiki メインタイトル">新月同行 Wiki</h1>
      <form class="wiki-search" role="search" onsubmit="return window.__wikiSearchSubmit && window.__wikiSearchSubmit(event)">
        <input id="wikiSearchInput" type="search" placeholder="Wiki内検索..." aria-label="Wiki内検索" />
      </form>
    </div>
    <div class="wiki-cat-bar-wrapper">
      <div class="wiki-cat-bar" role="tablist" aria-label="Wiki カテゴリ">
        <button class="wiki-cat-btn" data-panel="panel-dex" aria-expanded="false" role="tab">図鑑</button>
        <button class="wiki-cat-btn" data-panel="panel-tools" aria-expanded="false" role="tab">ツール</button>
        <button class="wiki-cat-btn" data-panel="panel-guides" aria-expanded="false" role="tab">ガイド</button>
        <button class="wiki-cat-btn" data-panel="panel-modes" aria-expanded="false" role="tab">ゲームモード</button>
      </div>
      <div class="wiki-acc-panels">
        <div id="panel-dex" class="wiki-acc-panel" role="tabpanel" aria-hidden="true">
          <div class="wiki-acc-grid">
            <a href="chars/index.html"><span>キャラ図鑑</span><span class="wiki-acc-badge">LIVE</span></a>
            <a href="#" aria-disabled="true" onclick="return false"><span>ロム図鑑</span><span class="wiki-acc-badge">準備中</span></a>
            <a href="#" aria-disabled="true" onclick="return false"><span>スキン図鑑</span><span class="wiki-acc-badge">準備中</span></a>
          </div>
        </div>
        <div id="panel-tools" class="wiki-acc-panel" role="tabpanel" aria-hidden="true">
          <div class="wiki-acc-grid">
            <a href="#" aria-disabled="true" onclick="return false"><span>ダメージ計算ツール</span><span class="wiki-acc-badge">予定</span></a>
            <a href="#today"><span>誕生日カレンダー</span><span class="wiki-acc-badge">予定</span></a>
            <a href="#" aria-disabled="true" onclick="return false"><span>キャラ所持チェッカー</span><span class="wiki-acc-badge">予定</span></a>
          </div>
        </div>
        <div id="panel-guides" class="wiki-acc-panel" role="tabpanel" aria-hidden="true">
          <div class="wiki-acc-grid">
            <a href="#" aria-disabled="true" onclick="return false"><span>ビルドガイド</span><span class="wiki-acc-badge">準備中</span></a>
            <a href="#" aria-disabled="true" onclick="return false"><span>ロム活用法</span><span class="wiki-acc-badge">準備中</span></a>
          </div>
        </div>
        <div id="panel-modes" class="wiki-acc-panel" role="tabpanel" aria-hidden="true">
          <div class="wiki-acc-grid">
            <a href="#" aria-disabled="true" onclick="return false"><span>イベント一覧</span><span class="wiki-acc-badge">準備中</span></a>
            <a href="#" aria-disabled="true" onclick="return false"><span>PvP/高難度</span><span class="wiki-acc-badge">準備中</span></a>
          </div>
        </div>
      </div>
    </div>
  </section>
  <section class="section" id="display-gallery">
    <h2>ディスプレイ</h2>
    <!-- data-interval(ms), data-fade(ms), data-initial(初期ロード枚数) -->
    <div class="display-area" data-interval="8000" data-fade="800" data-initial="8">
      <div class="display-stage" id="displayStage"></div>
      <div class="display-controls">
        <button class="display-btn" id="displayPrev" aria-label="前へ">◀ 前</button>
        <button class="display-btn" id="displayNext" aria-label="次へ">次 ▶</button>
      </div>
      <div class="display-indicators" id="displayIndicators" aria-label="表示中画像インジケータ"></div>
    </div>
  </section>

  <section class="section" id="today">
    <h2>今日と近日</h2>
    <div class="flex-row">
      <div class="col card" style="min-width:260px">
        <h3>今日の誕生日</h3>
        <div id="birthday-today" class="small">読み込み中...</div>
        <div style="margin-top:.7rem"></div>
        <h3>7日以内の誕生日</h3>
        <ul id="birthday-upcoming" class="list-plain"></ul>
      </div>
      <div class="col card" style="min-width:260px">
        <h3>進行中イベント</h3>
        <div id="events-running" class="small">(未実装)</div>
        <h3 style="margin-top:1rem">カウントダウン</h3>
        <div id="event-countdowns" class="small">(未実装)</div>
      </div>
      <div class="col card" style="min-width:220px">
        <h3>統計スナップショット</h3>
        <div id="stats-attrs" class="small">属性分布 読み込み中...</div>
        <div id="stats-types" class="small" style="margin-top:.6rem">タイプ分布 読み込み中...</div>
      </div>
    </div>
  </section>

  <section class="section" id="updates">
    <h2>更新・履歴</h2>
    <div class="flex-row">
      <div class="col card" style="min-width:300px">
        <h3>最新アップデート</h3>
        <div class="small" id="latest-update">(未実装)</div>
      </div>
      <div class="col card" style="min-width:300px">
        <h3>最新ガチャ</h3>
        <div class="small" id="latest-gacha">(未実装)</div>
      </div>
      <div class="col card" style="min-width:240px">
        <h3>最近追加/修正キャラ</h3>
        <ul id="recent-chars" class="list-plain"></ul>
      </div>
    </div>
  </section>

  <section class="section" id="skins">
    <h2>スキンハイライト (準備中)</h2>
    <div class="card small">まだデータソースが揃っていないためプレースホルダです。</div>
  </section>

  <section class="section" id="tools">
    <h2>ツール (予定)</h2>
    <div class="flex-row">
      <div class="col card"><h3>ダメージ計算</h3><div class="small">キャラ基礎ステとスキル係数から期待ダメージを算出。</div></div>
      <div class="col card"><h3>誕生日カレンダー</h3><div class="small">キャラ JSON から日付集計して月表示。</div></div>
      <div class="col card"><h3>ロム構成シミュレータ</h3><div class="small">2セット+4セット効果を組合せ比較 (構想)。</div></div>
    </div>
  </section>

  <section class="section" id="ads-middle">
    <div class="ad-slot">Ad / Middle</div>
  </section>
</main>
<footer class="bg-gray-800 text-gray-300 py-10 text-center text-sm font-inter mt-10">
  <nav class="mb-3">
    <a href="/privacy-policy-unified.html" class="underline hover:text-accent mx-2">プライバシーポリシー</a>
    <a href="/terms.html" class="underline hover:text-accent mx-2">利用規約</a>
    <a href="/about.html" class="underline hover:text-accent mx-2">運営者情報</a>
    <a href="mailto:negilab.com@gmail.com" class="underline hover:text-accent mx-2">お問い合わせ</a>
    <a href="/sitemap.xml" class="underline hover:text-accent mx-2">サイトマップ</a>
  </nav>
  <div class="text-xs text-gray-400 mb-2">新月同行 Wiki (仮) - Data oriented fan project (Unofficial)</div>
  <div id="build-meta" class="text-xs">Build: 2025-08-30T17:16:20</div>
  <div class="mt-2">&copy; 2025 negi-lab.com</div>
</footer>
<script>
// 埋め込みデータ (ビルド時に置換想定)
window.__CHAR_BIRTHDAYS__ = JSON.parse('[]');
window.__ATTR_STATS__ = JSON.parse('[{"name": "情", "count": 18}, {"name": "理", "count": 16}, {"name": "信", "count": 13}, {"name": "奇", "count": 10}, {"name": "正", "count": 7}]');
window.__TYPE_STATS__ = JSON.parse('[{"name": "特攻型", "count": 16}, {"name": "防御型", "count": 13}, {"name": "補助型", "count": 13}, {"name": "強攻型", "count": 12}, {"name": "突撃型", "count": 10}]');
window.__RECENT_CHARS__ = JSON.parse('[{"ID": "088", "名前": "セイケイ"}, {"ID": "087", "名前": "ボウワク"}, {"ID": "086", "名前": ""}, {"ID": "085", "名前": "ウジン"}, {"ID": "084", "名前": "ヤヌス"}, {"ID": "083", "名前": "アヌビス"}, {"ID": "082", "名前": "マンデー"}, {"ID": "081", "名前": "スイビン"}, {"ID": "080", "名前": "ボウコ"}, {"ID": "079", "名前": "インカ"}, {"ID": "078", "名前": "コウシュ"}, {"ID": "077", "名前": "アレフ"}]');
window.__WALLPAPERS__ = JSON.parse('["assets/wallpapers/Gallery_banner_17.jpg", "assets/wallpapers/Gallery_banner_19.jpg", "assets/wallpapers/Gallery_banner_6.jpg"]');
window.__DISPLAYS__ = JSON.parse('["assets/displays/Gallery_banner_10.webp", "assets/displays/Gallery_banner_11.webp", "assets/displays/Gallery_banner_12.webp", "assets/displays/Gallery_banner_13.webp", "assets/displays/Gallery_banner_14.webp", "assets/displays/Gallery_banner_15.webp", "assets/displays/Gallery_banner_16.webp", "assets/displays/Gallery_banner_18.webp", "assets/displays/Gallery_banner_1_1.webp", "assets/displays/Gallery_banner_1_10.webp", "assets/displays/Gallery_banner_1_11.webp", "assets/displays/Gallery_banner_1_12.webp", "assets/displays/Gallery_banner_1_13.webp", "assets/displays/Gallery_banner_1_14.webp", "assets/displays/Gallery_banner_1_16.webp", "assets/displays/Gallery_banner_1_17.webp", "assets/displays/Gallery_banner_1_18.webp", "assets/displays/Gallery_banner_1_19.webp", "assets/displays/Gallery_banner_1_2.webp", "assets/displays/Gallery_banner_1_3.webp", "assets/displays/Gallery_banner_1_4.webp", "assets/displays/Gallery_banner_1_5.webp", "assets/displays/Gallery_banner_1_7.webp", "assets/displays/Gallery_banner_1_8.webp", "assets/displays/Gallery_banner_1_9.webp", "assets/displays/Gallery_banner_20.webp", "assets/displays/Gallery_banner_21.webp", "assets/displays/Gallery_banner_22.webp", "assets/displays/Gallery_banner_23.webp", "assets/displays/Gallery_banner_24.webp", "assets/displays/Gallery_banner_25.webp", "assets/displays/Gallery_banner_26.webp", "assets/displays/Gallery_banner_4.webp", "assets/displays/Gallery_banner_5.webp", "assets/displays/Gallery_banner_7.webp", "assets/displays/Gallery_banner_8.webp", "assets/displays/Gallery_banner_9.webp"]');
(function(){
  const todayEl=document.getElementById('birthday-today');
  const upcomingEl=document.getElementById('birthday-upcoming');
  const now=new Date();
  const todayKey = ('0'+(now.getMonth()+1)).slice(-2)+'-'+('0'+now.getDate()).slice(-2);
  const list=window.__CHAR_BIRTHDAYS__||[];
  const today = list.filter(c=>c.md===todayKey);
  if(today.length){
    todayEl.textContent = today.map(c=>c.name).join(' / ');
  }else{
    todayEl.textContent = '誕生日キャラなし';
  }
  // 7日以内
  for(const c of list){
    const d=new Date(now.getFullYear(), c.m-1, c.d);
    let diff=(d - now)/(1000*60*60*24);
    if(diff < -1){ // 年末繰越 (年跨ぎ簡易)
      const next=new Date(now.getFullYear()+1, c.m-1, c.d);
      diff=(next-now)/(1000*60*60*24);
    }
    if(diff>=0 && diff<=7 && c.md!==todayKey){
      const li=document.createElement('li');
      li.textContent = c.name + ' ('+c.md+')';
      upcomingEl.appendChild(li);
    }
  }
  if(!upcomingEl.children.length){
    const li=document.createElement('li');li.textContent='該当なし';upcomingEl.appendChild(li);
  }
  // 簡易統計バー表示
  function renderSimple(id, stats){
    const el=document.getElementById(id);if(!el||!stats)return;
    el.innerHTML='';
    const total=stats.reduce((a,b)=>a+b.count,0)||1;
    stats.forEach(s=>{
      const row=document.createElement('div');
      row.textContent=s.name+' '+s.count;
      row.style.marginTop='.3rem';
      const bar=document.createElement('div');bar.className='stats-bar';
      const span=document.createElement('span');span.style.width=(s.count/total*100).toFixed(1)+'%';
      bar.appendChild(span);row.appendChild(bar);el.appendChild(row);
    });
  }
  renderSimple('stats-attrs', window.__ATTR_STATS__);
  renderSimple('stats-types', window.__TYPE_STATS__);
  // 最近キャラ
  const rc=window.__RECENT_CHARS__||[];const rcEl=document.getElementById('recent-chars');
  rc.slice(0,6).forEach(c=>{const li=document.createElement('li');li.textContent=c.ID+' '+c.名前;rcEl.appendChild(li);});
  // 壁紙: ランダム適用
  (function(){
    const arr = window.__WALLPAPERS__||[]; if(!arr.length) return;
    const pick = arr[Math.floor(Math.random()*arr.length)];
    document.body.classList.add('has-wallpaper');
    document.body.style.backgroundImage = `url(${pick})`;
  })();
  // ディスプレイギャラリー
  (function(){
    const arr = window.__DISPLAYS__||[]; if(!arr.length) return;
    const area = document.querySelector('.display-area');
    const interval = parseInt(area.dataset.interval)||6000;
    const fade = parseInt(area.dataset.fade)||600; // ms
  let initial = parseInt(area.dataset.initial)||8;
  if(window.innerWidth < 640) initial = Math.min(initial,4);
    const stage = document.getElementById('displayStage');
    const indicators = document.getElementById('displayIndicators');
    let idx = 0; let timer = null;
    // 初期ロード & 遅延用プレースホルダ
    arr.forEach((src,i)=>{
      const img=document.createElement('img');
      if(i < initial){
        img.src=src;
      }else{
        img.dataset.src=src;
      }
      img.alt='display '+(i+1);
      if(i===0) img.classList.add('active');
      img.style.transition='opacity '+(fade/1000)+'s ease';
      stage.appendChild(img);
      const dot=document.createElement('span');if(i===0) dot.classList.add('active');indicators.appendChild(dot);
    });
    const imgs=[...stage.querySelectorAll('img')]; const dots=[...indicators.children];
    function ensureLoaded(i){
      const im=imgs[i]; if(im && !im.src){ im.src=im.dataset.src; }
    }
    function show(n){
      idx=(n+imgs.length)%imgs.length; ensureLoaded(idx);
      imgs.forEach((im,i)=>im.classList.toggle('active',i===idx));
      dots.forEach((d,i)=>d.classList.toggle('active',i===idx));
    }
    function next(){show(idx+1);} function prev(){show(idx-1);} 
    function loop(){clearInterval(timer);timer=setInterval(()=>{next();},interval);} loop();
    document.getElementById('displayNext').addEventListener('click',()=>{next();loop();});
    document.getElementById('displayPrev').addEventListener('click',()=>{prev();loop();});
    // インジケータクリック
    dots.forEach((d,i)=>d.addEventListener('click',()=>{show(i);loop();}));
  })();
  // モバイルナビ制御
  (function(){
    const header=document.querySelector('.wiki-header');
    const btn=document.getElementById('menuToggle');
    const nav=document.getElementById('mainNav');
    if(!btn||!nav) return;
    btn.addEventListener('click',()=>{
      const open=header.classList.toggle('open');
      btn.setAttribute('aria-expanded',open?'true':'false');
      if(open){ nav.classList.remove('hidden'); } else if(window.innerWidth < 640){ nav.classList.add('hidden'); }
    });
    window.addEventListener('resize',()=>{
      if(window.innerWidth >= 640){ nav.classList.remove('hidden'); header.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
      else if(!header.classList.contains('open')){ nav.classList.add('hidden'); }
    });
  })();
  // アコーディオンカテゴリ (デフォルト閉)
  (function(){
    const buttons=[...document.querySelectorAll('.wiki-cat-btn')];
    const panels={};
    buttons.forEach(b=>{const id=b.dataset.panel; if(id){ panels[id]=document.getElementById(id); }});
    function toggle(btn){
      const id=btn.dataset.panel; const panel=panels[id]; if(!panel) return;
      const open = btn.getAttribute('aria-expanded')==='true';
      // すべて閉じる
      buttons.forEach(x=>x.setAttribute('aria-expanded','false'));
      Object.values(panels).forEach(p=>{p.classList.remove('open');p.setAttribute('aria-hidden','true');});
      if(!open){
        btn.setAttribute('aria-expanded','true');
        panel.classList.add('open');
        panel.setAttribute('aria-hidden','false');
      }
    }
    buttons.forEach(btn=>btn.addEventListener('click',()=>toggle(btn)));
    // キーボード操作
    document.addEventListener('keydown',e=>{
      if(!['ArrowLeft','ArrowRight','Home','End'].includes(e.key)) return;
      const idx=buttons.indexOf(document.activeElement);
      if(idx<0) return; e.preventDefault();
      let ni=idx;
      if(e.key==='ArrowRight') ni=(idx+1)%buttons.length; else if(e.key==='ArrowLeft') ni=(idx-1+buttons.length)%buttons.length; else if(e.key==='Home') ni=0; else if(e.key==='End') ni=buttons.length-1;
      buttons[ni].focus();
    });
  })();
  // 簡易Wiki内検索 (今は chars ページへクエリ転送想定)
  window.__wikiSearchSubmit=function(ev){
    ev.preventDefault();
    const q=document.getElementById('wikiSearchInput').value.trim();
    if(!q){return false;}
    // 本格検索ページへ遷移
    location.href='/gamewiki/FellowMoon/search.html?q='+encodeURIComponent(q);
    return false;
  };
  // パネル状態保持 (hash優先 -> localStorage)
  (function(){
    const STORAGE_KEY='fellowmoon_wiki_panel';
    function openById(id){
      const btn=document.querySelector('.wiki-cat-btn[data-panel="'+id+'"]');
      if(btn){ btn.click(); }
    }
    // ハッシュを監視 (#panel-tools など)
    function fromHash(){
      const h=location.hash.replace('#','');
      if(h && /^panel-/.test(h)){ openById(h); return true; }
      return false;
    }
    if(!fromHash()){
      const saved=localStorage.getItem(STORAGE_KEY);
      if(saved){ openById(saved); }
    }
    window.addEventListener('hashchange',fromHash);
    // クリック時に保存
    document.querySelectorAll('.wiki-cat-btn').forEach(b=>{
      b.addEventListener('click',()=>{
        if(b.getAttribute('aria-expanded')==='true'){
          localStorage.setItem(STORAGE_KEY,b.dataset.panel);
          // ハッシュも同期
          history.replaceState(null,'','#'+b.dataset.panel);
        }else{
          // 閉じたときはハッシュ除去
          if(location.hash) history.replaceState(null,'',location.pathname+location.search);
        }
      });
    });
  })();
})();
</script>
</body>
</html>
