<!DOCTYPE html>
<html lang="ja" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-translate-key="imageConverter.pageTitle">画像変換ツール - negi-lab.com</title>
  <meta name="description" data-translate-key="imageConverter.metaDescription" content="画像のフォーマットを変換（JPEG, PNG, WebPなど）したり、品質やサイズ変更ができるツール。" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            negi: "#65c155",
            accent: "#4ADE80"
          },
          fontFamily: { inter: ["Inter", "sans-serif"] }
        }
      }
    }
    window.pageTitleTranslationKey = "imageConverter.pageTitle";
    window.metaDescriptionTranslationKey = "imageConverter.metaDescription";
  </script>
  <style>
    .form-select, .form-input, .form-button, .form-range {
      padding: 0.5rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      transition: box-shadow 0.2s;
    }
    .form-select:focus, .form-input:focus, .form-button:focus, .form-range:focus {
      outline: none;
      box-shadow: 0 0 0 2px #4ADE80;
      border-color: #4ADE80;
    }
    .form-button {
      background: #4ADE80;
      color: #fff;
      transition: background 0.15s, color 0.15s;
    }
    .form-button:hover:not(:disabled) {
      background: #10b981;
    }
    .form-button:disabled {
      background: #d1d5db;
      color: #fff;
      cursor: not-allowed;
    }
    .drop-area {
      border: 2px dashed #d1d5db;
      border-radius: 0.5rem;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
    }
    .drop-area.dragover {
      border-color: #4ADE80;
      background: rgba(74, 222, 128, 0.1);
    }
    .preview-image {
      max-width: 100%;
      max-height: 16rem;
      border-radius: 0.375rem;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    }
  </style>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1835873052239386" crossorigin="anonymous"></script>
</head>
<body class="bg-gray-50 text-gray-800 font-inter min-h-screen flex flex-col">

  <!-- Google Analytics（gtag.js）全ページ用 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-N9X3N0RY0H"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-N9X3N0RY0H');
  </script>

  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex justify-between items-center px-4 py-4">
      <a href="/" class="text-2xl font-extrabold text-accent tracking-tight hover:opacity-80 transition">negi-lab.com</a>
      <nav>
        <ul class="flex gap-6 font-medium text-base items-center">
          <li><a href="/#tools" class="hover:text-accent transition" data-translate-key="header.nav.tools">ツール</a></li>
          <li><a href="/#wikis" class="hover:text-accent transition" data-translate-key="header.nav.wikis">ゲームWiki</a></li>
          <li>
            <select id="lang-switch" class="rounded border border-gray-300 px-2 py-1 text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-accent transition">
              <option value="ja" data-translate-key="option.ja">日本語</option>
              <option value="en" data-translate-key="option.en">English</option>
            </select>
          </li>
          <li>
            <button id="guide-btn" class="rounded border border-accent px-3 py-1 text-accent text-sm font-semibold bg-white hover:bg-accent/10 focus:outline-none focus:ring-2 focus:ring-accent transition" aria-haspopup="dialog" aria-controls="guide-modal" data-translate-key="header.guide">ガイド</button>
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="flex-grow py-12">
    <div class="max-w-2xl mx-auto px-4">
      <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-900 mb-10" data-translate-key="imageConverter.mainTitle">画像変換ツール</h1>
      
      <!-- ツール上部：アドセンス（レスポンシブ） -->
      <div class="max-w-2xl mx-auto my-6">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-xxxxxxxxxxxxxxxx"
             data-ad-slot="1234567890"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
      </div>

      <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg space-y-6">
        <div>
          <label for="imageUploadArea" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="imageConverter.uploadLabel">画像ファイルをアップロード:</label>
          <div id="imageUploadArea" class="drop-area" aria-label="画像ファイルアップロードエリア">
            <input type="file" id="imageFile" accept="image/jpeg, image/png, image/webp, image/gif" class="hidden" aria-describedby="fileHelp">
            <p id="dropInstructions" data-translate-html-key="imageConverter.dropInstructions" aria-label="ファイルのドラッグ＆ドロップまたはクリックして選択">ここにファイルをドラッグ＆ドロップ<br>またはクリックして選択</p>
          </div>
          <p id="fileName" class="text-sm text-gray-500 mt-1" aria-label="選択されたファイル名"></p>
        </div>

        <div id="previewContainer" class="mt-4 text-center hidden" aria-hidden="true">
            <img id="imagePreview" src="#" alt="Image Preview" class="preview-image inline-block" data-translate-key-alt="imageConverter.previewAlt" aria-label="アップロードされた画像のプレビュー"/>
        </div>

        <div>
          <label for="outputFormat" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="imageConverter.outputFormatLabel">出力フォーマット:</label>
          <select id="outputFormat" class="form-select w-full" aria-label="出力フォーマット選択">
            <option value="image/jpeg" data-translate-key="imageConverter.formatJPEG">JPEG</option>
            <option value="image/png" data-translate-key="imageConverter.formatPNG">PNG</option>
            <option value="image/webp" data-translate-key="imageConverter.formatWebP">WebP</option>
          </select>
        </div>

        <div id="qualityControlContainer" class="hidden" aria-hidden="true">
            <label for="qualityRange" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="imageConverter.qualityLabel">品質 (JPEG/WebP):</label>
            <div class="flex items-center gap-2">
                <input type="range" id="qualityRange" min="0.1" max="1" step="0.05" value="0.9" class="form-range w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" aria-label="画像品質調整">
                <span id="qualityValue" class="text-sm text-gray-600 w-10 text-right" aria-label="現在の品質値">0.90</span>
            </div>
        </div>
        
        <div>
            <p class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="imageConverter.maxDimensionsLabel">最大寸法 (任意):</p>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="maxWidthInput" class="block text-xs font-medium text-gray-600" data-translate-key="imageConverter.maxWidthLabel">最大幅 (px):</label>
                    <input type="number" id="maxWidthInput" min="1" class="form-input w-full mt-1" placeholder="例: 1920" aria-label="最大幅入力フィールド">
                </div>
                <div>
                    <label for="maxHeightInput" class="block text-xs font-medium text-gray-600" data-translate-key="imageConverter.maxHeightLabel">最大高さ (px):</label>
                    <input type="number" id="maxHeightInput" min="1" class="form-input w-full mt-1" placeholder="例: 1080" aria-label="最大高さ入力フィールド">
                </div>
            </div>
        </div>
        
        <button id="convertButton" class="form-button w-full py-2.5" disabled data-translate-key="imageConverter.convertButton" aria-label="画像変換実行ボタン">変換する</button>
        
        <div id="resultContainer" class="mt-4 text-center hidden space-y-3" aria-hidden="true">
            <h3 class="text-lg font-medium text-gray-800" data-translate-key="unitConverter.resultLabel">結果:</h3>
            <img id="convertedImagePreview" src="#" alt="Converted Image Preview" class="preview-image inline-block" data-translate-key-alt="imageConverter.previewAlt" aria-label="変換後画像のプレビュー"/>
            <a id="downloadLink" href="#" download="converted_image.png" class="form-button inline-block py-2 px-4" data-translate-key="imageConverter.downloadButton" aria-label="変換後画像ダウンロードリンク">ダウンロード</a>
        </div>

        <div id="messageArea" class="text-sm mt-2">
            <p id="statusMessage" class="text-gray-600"></p>
            <p id="errorMessage" class="text-red-600"></p>
        </div>

      </div>

      <!-- スポンサーリンクラベル（広告直前） -->
      <div class="text-xs text-gray-500 mb-1" aria-label="スポンサーリンク">スポンサーリンク</div>
      <!-- ここに広告コード（例: AdSense）を挿入 -->

      <!-- ツール下部：Amazon・楽天バナー → ネイティブ/モーションウィジェット動的表示に置換 -->
      <div id="smart-ads" class="flex justify-center my-8"></div>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          if (window.renderSmartAds) window.renderSmartAds('smart-ads');
        });
      </script>

    </div>
  </main>

  <section class="mt-12 mb-8 text-sm text-gray-700 bg-white rounded-lg p-4 border border-gray-200 max-w-xl mx-auto" aria-label="このツールについて">
    <h2 class="font-bold text-base mb-2">negi-lab.comの独自性・運営方針・免責事項</h2>
    <ul class="list-disc ml-5 mb-2">
      <li>本ツールはnegi-lab.comが独自開発・運営しています。</li>
      <li>広告・アフィリエイトを含みますが、ユーザー体験を最優先しています。</li>
      <li>正確性・安全性には万全を期していますが、利用は自己責任でお願いします。</li>
    </ul>
    <p class="text-xs text-gray-500">&copy; 2025 negi-lab.com</p>
  </section>

  <footer class="bg-gray-800 text-gray-300 py-8 text-center text-sm">
    <nav class="mb-2">
      <a href="/privacy-policy-unified.html" class="underline hover:text-accent mx-2">プライバシーポリシー</a>
      <a href="/terms.html" class="underline hover:text-accent mx-2">利用規約</a>
      <a href="/about.html" class="underline hover:text-accent mx-2">運営者情報</a>
      <a href="mailto:negilab.com@gmail.com" class="underline hover:text-accent mx-2">お問い合わせ</a>
      <a href="/sitemap.xml" class="underline hover:text-accent mx-2">サイトマップ</a>
    </nav>
    <div>&copy; 2025 negi-lab.com</div>
  </footer>

  <!-- Guide Modal Popup -->
  <div id="guide-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 hidden" role="dialog" aria-modal="true" aria-labelledby="guide-modal-title">
    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full p-6 relative">
      <button id="guide-close" class="absolute top-2 right-2 text-gray-400 hover:text-accent text-2xl font-bold" aria-label="閉じる">&times;</button>
      <div id="guide-modal-content"></div>
    </div>
  </div>

  <script type="module" src="../index.js" defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const imageFile = document.getElementById('imageFile');
        const imageUploadArea = document.getElementById('imageUploadArea');
        const dropInstructions = document.getElementById('dropInstructions');
        const fileNameDisplay = document.getElementById('fileName');
        const outputFormatSelect = document.getElementById('outputFormat');
        const qualityControlContainer = document.getElementById('qualityControlContainer');
        const qualityRange = document.getElementById('qualityRange');
        const qualityValue = document.getElementById('qualityValue');
        const maxWidthInput = document.getElementById('maxWidthInput');
        const maxHeightInput = document.getElementById('maxHeightInput');
        const convertButton = document.getElementById('convertButton');
        const imagePreview = document.getElementById('imagePreview');
        const previewContainer = document.getElementById('previewContainer');
        const convertedImagePreview = document.getElementById('convertedImagePreview');
        const downloadLink = document.getElementById('downloadLink');
        const resultContainer = document.getElementById('resultContainer');
        const statusMessage = document.getElementById('statusMessage');
        const errorMessage = document.getElementById('errorMessage');

        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10 MB
        let currentFile = null;
        let originalFileName = 'image';

        function getLang() {
            return document.documentElement.lang || 'ja';
        }

        function translate(key, type = 'text') {
            const lang = getLang();
            if (window.translations && window.translations[lang] && window.translations[lang][key]) {
                return window.translations[lang][key];
            }
            // Fallbacks from provided translations or keys themselves
            const fallbacks = {
                'imageConverter.convertingMessage': 'Converting...',
                'imageConverter.noImageSelected': 'Please select an image to convert.',
                'imageConverter.error.fileType': 'Unsupported file type.',
                'imageConverter.error.generic': 'Conversion error.',
                'imageConverter.imageTooLarge': 'File is too large.',
                'imageConverter.error.invalidDimensions': 'Invalid dimensions. Please enter positive numbers.',
                'imageConverter.dropInstructions': "Drag & drop your file here<br>or click to select"
            };
            return fallbacks[key] || key;
        }
        
        function updateQualityVisibility() {
            const format = outputFormatSelect.value;
            if (format === 'image/jpeg' || format === 'image/webp') {
                qualityControlContainer.classList.remove('hidden');
            } else {
                qualityControlContainer.classList.add('hidden');
            }
        }

        outputFormatSelect.addEventListener('change', updateQualityVisibility);
        qualityRange.addEventListener('input', () => {
            qualityValue.textContent = parseFloat(qualityRange.value).toFixed(2);
        });


        imageUploadArea.addEventListener('click', () => imageFile.click());
        imageUploadArea.addEventListener('dragover', (event) => {
            event.preventDefault();
            imageUploadArea.classList.add('dragover');
        });
        imageUploadArea.addEventListener('dragleave', () => {
            imageUploadArea.classList.remove('dragover');
        });
        imageUploadArea.addEventListener('drop', (event) => {
            event.preventDefault();
            imageUploadArea.classList.remove('dragover');
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        imageFile.addEventListener('change', (event) => {
            if (event.target.files.length > 0) {
                handleFile(event.target.files[0]);
            }
        });

        function handleFile(file) {
            clearMessages();
            resultContainer.classList.add('hidden');
            
            if (file.size > MAX_FILE_SIZE) {
                errorMessage.textContent = translate('imageConverter.imageTooLarge');
                resetFileState();
                return;
            }

            const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                errorMessage.textContent = translate('imageConverter.error.fileType');
                resetFileState();
                return;
            }

            currentFile = file;
            originalFileName = file.name.substring(0, file.name.lastIndexOf('.')) || 'image';
            fileNameDisplay.textContent = file.name;
            dropInstructions.classList.add('hidden');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                previewContainer.classList.remove('hidden');
            }
            reader.readAsDataURL(file);
            convertButton.disabled = false;
        }
        
        function resetFileState() {
            currentFile = null;
            imageFile.value = ''; 
            fileNameDisplay.textContent = '';
            dropInstructions.classList.remove('hidden');
            previewContainer.classList.add('hidden');
            imagePreview.src = '#';
            convertButton.disabled = true;
            resultContainer.classList.add('hidden');
            maxWidthInput.value = '';
            maxHeightInput.value = '';
        }

        function clearMessages() {
            statusMessage.textContent = '';
            errorMessage.textContent = '';
        }

        convertButton.addEventListener('click', async () => {
            if (!currentFile) {
                errorMessage.textContent = translate('imageConverter.noImageSelected');
                return;
            }
            clearMessages();
            statusMessage.textContent = translate('imageConverter.convertingMessage');
            convertButton.disabled = true;
            resultContainer.classList.add('hidden');

            const pMaxWidth = parseInt(maxWidthInput.value);
            const pMaxHeight = parseInt(maxHeightInput.value);

            if ((maxWidthInput.value && (isNaN(pMaxWidth) || pMaxWidth <=0)) || (maxHeightInput.value && (isNaN(pMaxHeight) || pMaxHeight <=0))) {
                errorMessage.textContent = translate('imageConverter.error.invalidDimensions');
                statusMessage.textContent = '';
                convertButton.disabled = false;
                return;
            }


            try {
                const outputMimeType = outputFormatSelect.value;
                const image = new Image();
                const reader = new FileReader();

                reader.onload = (event) => {
                    image.onload = () => {
                        const canvas = document.createElement('canvas');
                        let { naturalWidth: width, naturalHeight: height } = image;

                        const userMaxWidth = pMaxWidth || 0;
                        const userMaxHeight = pMaxHeight || 0;

                        if (userMaxWidth > 0 || userMaxHeight > 0) {
                            if (userMaxWidth > 0 && userMaxHeight > 0) {
                                const ratio = Math.min(userMaxWidth / width, userMaxHeight / height);
                                width = Math.round(width * ratio);
                                height = Math.round(height * ratio);
                            } else if (userMaxWidth > 0) {
                                const ratio = userMaxWidth / width;
                                width = userMaxWidth;
                                height = Math.round(height * ratio);
                            } else if (userMaxHeight > 0) { // only maxHeight is set
                                const ratio = userMaxHeight / height;
                                height = userMaxHeight;
                                width = Math.round(width * ratio);
                            }
                        }
                        
                        canvas.width = width > 0 ? width : 1; // Ensure canvas dimensions are positive
                        canvas.height = height > 0 ? height : 1;

                        const ctx = canvas.getContext('2d');
                        
                        if (currentFile.type === 'image/gif' && outputMimeType !== 'image/gif') {
                             ctx.fillStyle = '#FFFFFF'; 
                             ctx.fillRect(0, 0, canvas.width, canvas.height);
                        }
                        ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

                        let quality = parseFloat(qualityRange.value);
                        if (outputMimeType === 'image/png') { // PNG doesn't use quality in toBlob like jpeg/webp
                           canvas.toBlob((blob) => {
                                processBlob(blob, outputMimeType);
                           }, outputMimeType);
                        } else { // JPEG or WebP
                           canvas.toBlob((blob) => {
                                processBlob(blob, outputMimeType);
                           }, outputMimeType, quality);
                        }
                    };
                    image.onerror = () => {
                        errorMessage.textContent = translate('imageConverter.error.generic');
                        statusMessage.textContent = '';
                        convertButton.disabled = false;
                    };
                    image.src = event.target.result;
                };
                reader.onerror = () => {
                     errorMessage.textContent = translate('imageConverter.error.generic');
                     statusMessage.textContent = '';
                     convertButton.disabled = false;
                };
                reader.readAsDataURL(currentFile);

            } catch (error) {
                console.error("Conversion error:", error);
                errorMessage.textContent = translate('imageConverter.error.generic');
                statusMessage.textContent = '';
                convertButton.disabled = false;
            }
        });
        
        function processBlob(blob, mimeType) {
            if (!blob) {
                errorMessage.textContent = translate('imageConverter.error.generic') + " (blob creation failed)";
                statusMessage.textContent = '';
                convertButton.disabled = false;
                return;
            }
            const convertedUrl = URL.createObjectURL(blob);
            convertedImagePreview.src = convertedUrl;
            
            const fileExtension = mimeType.split('/')[1];
            downloadLink.href = convertedUrl;
            downloadLink.download = `${originalFileName}_converted.${fileExtension}`;
            
            resultContainer.classList.remove('hidden');
            statusMessage.textContent = '';
            convertButton.disabled = false;
        }
        
        const langSwitchObserver = new MutationObserver(() => {
            const dropText = translate('imageConverter.dropInstructions', 'html');
            if (dropInstructions.innerHTML !== dropText) {
                 dropInstructions.innerHTML = dropText;
            }
            // Re-translate error message if visible
            if (errorMessage.textContent) {
                const currentErrorKey = Object.keys(window.translations[getLang()] || {}).find(key => window.translations[getLang()][key] === errorMessage.textContent);
                if (currentErrorKey) errorMessage.textContent = translate(currentErrorKey);
            }
        });
        langSwitchObserver.observe(document.documentElement, { attributes: true, attributeFilter: ['lang'] });
        
        // Initial setup
        updateQualityVisibility();
        dropInstructions.innerHTML = translate('imageConverter.dropInstructions', 'html');
    });
  </script>
  <script>
    // ガイドモーダルの表示/非表示制御
    document.addEventListener('DOMContentLoaded', function() {
      const guideBtn = document.getElementById('guide-btn');
      const guideModal = document.getElementById('guide-modal');
      const guideClose = document.getElementById('guide-close');
      const guideContent = document.getElementById('guide-modal-content');
      // 多言語ガイドデータ
      const guides = {
        ja: {
          title: '画像変換ツールの使い方',
          list: [
            '画像ファイル（JPEG, PNG, WebP等）をアップロード',
            '出力形式や品質・サイズを選択',
            '変換ボタンを押すと新しい画像をダウンロード',
            '右上メニューで日本語・英語切替可能'
          ],
          tipsTitle: '活用例・ヒント',
          tips: [
            'PNG→JPEGでファイルサイズ削減',
            'SNSやWeb用に画像をリサイズ'
          ]
        },
        en: {
          title: 'How to Use the Image Converter',
          list: [
            'Upload an image file (JPEG, PNG, WebP, etc.).',
            'Select the output format and adjust quality/size if needed.',
            'Click the convert button to download the new image.',
            'Switch language from the top menu. All features are available in English and Japanese.'
          ],
          tipsTitle: 'Tips & Examples',
          tips: [
            'Convert PNG to JPEG to reduce file size.',
            'Resize images for social media or web use.'
          ]
        }
      };
      function renderGuide(lang) {
        const g = guides[lang] || guides.ja;
        let html = `<h2 class='text-xl font-bold mb-3'>${g.title}</h2>`;
        html += '<ul class="list-disc ml-5 mb-4 text-gray-700">' + g.list.map(x=>`<li>${x}</li>`).join('') + '</ul>';
        html += `<h3 class='font-bold text-base mt-6 mb-2'>${g.tipsTitle}</h3><ul class='list-disc ml-5 text-gray-700'>` + g.tips.map(x=>`<li>${x}</li>`).join('') + '</ul>';
        guideContent.innerHTML = html;
      }
      if(guideBtn && guideModal && guideClose && guideContent) {
        guideBtn.addEventListener('click', function() {
          const lang = document.documentElement.lang || localStorage.getItem('selectedLanguage') || 'ja';
          renderGuide(lang);
          guideModal.classList.remove('hidden');
        });
        guideClose.addEventListener('click', function() {
          guideModal.classList.add('hidden');
        });
        guideModal.addEventListener('click', function(e) {
          if(e.target === guideModal) guideModal.classList.add('hidden');
        });
      }
    });
  </script>
</body>
</html>
