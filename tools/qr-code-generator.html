<!DOCTYPE html>
<html lang="ja" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Content Security Policy -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self'; 
    script-src 'self' 'unsafe-inline' 'unsafe-eval' 
      https://cdn.tailwindcss.com 
      https://cdn.jsdelivr.net 
      https://unpkg.com; 
    style-src 'self' 'unsafe-inline' 
      https://fonts.googleapis.com 
      https://cdn.tailwindcss.com; 
    font-src 'self' 
      https://fonts.gstatic.com; 
    img-src 'self' data: blob:; 
    connect-src 'self'; 
    object-src 'none'; 
    base-uri 'self';
  " />
  
  <!-- Security Headers -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN" />
  <meta http-equiv="X-XSS-Protection" content="1; mode=block" />
  
  <title data-translate-key="qrGenerator.pageTitle">高機能QRコード生成ツール - negi-lab.com</title>
  <meta name="description" data-translate-key="qrGenerator.metaDescription" content="直感的なUI、リアルタイムプレビュー、豊富なカスタマイズオプションを備えた高機能QRコード生成ツール。ロゴ挿入、スタイル選択、一括生成に対応。" />
    <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" crossorigin="anonymous" />
  
  <!-- CSS Framework -->
  <script>
    // Tailwind CDNの警告を無効化（開発用）
    if (typeof window !== 'undefined') {
      window.process = { env: { NODE_ENV: 'development' } };
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js" 
          onload="console.log('✅ qrcode.js読み込み完了')" 
          onerror="console.warn('⚠️ qrcode.js読み込みエラー - フォールバックを使用')"></script>
  
  <!-- QR Code Library Fallback -->
  <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js" 
          onload="if (!window.QRCode) { console.log('✅ qrcode.js フォールバック読み込み完了'); }"
          onerror="console.warn('⚠️ qrcode.js フォールバック読み込みエラー')"></script>
  
  <!-- JSZip Library for Batch Download -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"
          onload="console.log('✅ JSZip読み込み完了')"
          onerror="console.warn('⚠️ JSZip読み込みエラー')"></script>
  
  <!-- Security and Common Utilities -->
  <script src="/js/security-utils.js"></script>
  <script src="/js/common-utils.js"></script>
    <!-- Tailwind Configuration -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            negi: "#65c155",
            accent: "#4ADE80"
          },
          fontFamily: { 
            inter: ["Inter", "sans-serif"] 
          }
        }
      }
    }
    window.pageTitleTranslationKey = "qrGenerator.pageTitle";
    window.metaDescriptionTranslationKey = "qrGenerator.metaDescription";
  </script>
    <!-- Custom Styles -->
  <style>
    .form-input, .form-select, .form-button {
      padding: 0.75rem;
      border: 2px solid #e2e8f0;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      transition: all 0.3s ease;
      font-size: 0.875rem;
    }
    
    .form-input:focus, .form-select:focus, .form-button:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.1);
      border-color: #4ADE80;
      transform: translateY(-1px);
    }
    
    .form-button {
      background: linear-gradient(135deg, #4ADE80, #10b981);
      color: #fff;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
    }
    
    .form-button:hover:not(:disabled) {
      background: linear-gradient(135deg, #10b981, #059669);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(74, 222, 128, 0.3);
    }
    
    .form-button:disabled {
      background: #d1d5db;
      color: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }
    
    .form-button.secondary {
      background: #f8fafc;
      color: #374151;
      border: 2px solid #e2e8f0;
    }
    
    .form-button.secondary:hover:not(:disabled) {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }
    
    .qr-preview-container {
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      border: 2px dashed #cbd5e1;
      border-radius: 1rem;
      min-height: 300px;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    .qr-preview-container.has-content {
      border: 2px solid #10b981;
      background: #ffffff;
      box-shadow: 0 10px 25px rgba(16, 185, 129, 0.1);
    }
    
    .qr-preview-container.drag-over {
      border-color: #4ADE80;
      background: rgba(74, 222, 128, 0.05);
      transform: scale(1.02);
    }
    
    .qr-preview-container img, .qr-preview-container canvas {
      max-width: 100%;
      height: auto;
      border-radius: 0.75rem;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }
    
    .qr-preview-container:hover img, .qr-preview-container:hover canvas {
      transform: scale(1.05);
    }
    
    .tab-button {
      padding: 0.75rem 1.5rem;
      border-bottom: 3px solid transparent;
      color: #6b7280;
      transition: all 0.3s ease;
      cursor: pointer;
      font-weight: 500;
      border-radius: 0.5rem 0.5rem 0 0;
      position: relative;
    }
    
    .tab-button:hover {
      color: #374151;
      background: rgba(74, 222, 128, 0.05);
    }
    
    .tab-button.active {
      color: #10b981;
      border-color: #10b981;
      background: #ffffff;
      box-shadow: 0 -2px 10px rgba(16, 185, 129, 0.1);
    }
    
    .tab-content {
      animation: slideInUp 0.4s ease-out;
    }
    
    @keyframes slideInUp {
      from { 
        opacity: 0; 
        transform: translateY(20px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }
    
    .color-preset {
      width: 48px;
      height: 48px;
      border: 3px solid #e5e7eb;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .color-preset:hover {
      border-color: #4ADE80;
      transform: scale(1.1);
    }
    
    .color-preset.active {
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
      transform: scale(1.1);
    }
    
    .loading {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .feature-card {
      background: #ffffff;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      border: 1px solid #f1f5f9;
    }
    
    .feature-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
    }
    
    .qr-style-option {
      border: 2px solid #e2e8f0;
      border-radius: 0.75rem;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #ffffff;
    }
    
    .qr-style-option:hover {
      border-color: #4ADE80;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(74, 222, 128, 0.1);
    }
    
    .qr-style-option.active {
      border-color: #10b981;
      background: rgba(16, 185, 129, 0.05);
    }
    
    .live-preview {
      position: sticky;
      top: 2rem;
    }
    
    .slide-up {
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .progress-ring {
      transform: rotate(-90deg);
    }
    
    .progress-ring-circle {
      stroke-dasharray: 251.2;
      stroke-dashoffset: 251.2;
      transition: stroke-dashoffset 0.3s ease;
    }
    
    .file-drop-zone {
      border: 2px dashed #cbd5e1;
      border-radius: 0.75rem;
      padding: 2rem;
      text-align: center;
      transition: all 0.3s ease;
      background: #f8fafc;
    }
    
    .file-drop-zone.drag-over {
      border-color: #4ADE80;
      background: rgba(74, 222, 128, 0.05);
    }
    
    .tooltip {
      position: relative;
    }
    
    .tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: #ffffff;
      padding: 0.5rem;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      white-space: nowrap;
      z-index: 1000;
    }
  </style>
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-N9X3N0RY0H"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-N9X3N0RY0H');
  </script>
  
  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1835873052239386" crossorigin="anonymous"></script>
</head>

<body class="bg-gray-50 text-gray-800 font-inter min-h-screen flex flex-col">
  
  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex justify-between items-center px-4 py-4">
      <a href="/" class="text-2xl font-extrabold text-accent tracking-tight hover:opacity-80 transition">negi-lab.com</a>
      <nav>
        <ul class="flex gap-6 font-medium text-base items-center">
          <li><a href="/#tools" class="hover:text-accent transition" data-translate-key="header.nav.tools">ツール</a></li>
          <li><a href="/#wikis" class="hover:text-accent transition" data-translate-key="header.nav.wikis">ゲームWiki</a></li>
          <li>
            <select id="lang-switch" class="rounded border border-gray-300 px-2 py-1 text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-accent transition">
              <option value="ja" data-translate-key="option.ja">日本語</option>
              <option value="en" data-translate-key="option.en">English</option>
            </select>
          </li>
          <li>
            <button id="guide-btn" class="rounded border border-accent px-3 py-1 text-accent text-sm font-semibold bg-white hover:bg-accent/10 focus:outline-none focus:ring-2 focus:ring-accent transition" aria-haspopup="dialog" aria-controls="guide-modal" data-translate-key="header.guide">ガイド</button>
          </li>
        </ul>
      </nav>
    </div>
  </header>
  <!-- Main Content -->
  <main class="flex-grow py-8">
    <div class="max-w-7xl mx-auto px-4">
      
      <!-- Hero Section -->
      <div class="text-center mb-12">
        <h1 class="text-5xl font-bold text-gray-900 mb-6" data-translate-key="qrGenerator.title">
          高機能QRコード生成ツール
        </h1>
        <p class="text-xl text-gray-600 mb-8" data-translate-key="qrGenerator.description">
          直感的なUI、リアルタイムプレビュー、豊富なカスタマイズオプション
        </p>
        <div class="flex justify-center gap-4 text-sm text-gray-500">
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            リアルタイムプレビュー
          </span>
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            高度なカスタマイズ
          </span>
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            一括生成対応
          </span>
        </div>
      </div>

      <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        
        <!-- Control Panel -->
        <div class="xl:col-span-2 space-y-6">
          
          <!-- Quick Actions -->
          <div class="feature-card">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-semibold text-gray-900">クイックアクション</h2>
              <div class="flex gap-2">
                <button id="clearAllBtn" class="form-button secondary text-sm px-3 py-1">
                  すべてクリア
                </button>
                <button id="randomizeBtn" class="form-button secondary text-sm px-3 py-1">
                  ランダム化
                </button>
              </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              <button class="quick-template-btn qr-style-option text-center py-3" data-template="url">
                <div class="text-2xl mb-1">🌐</div>
                <div class="text-sm font-medium">URL</div>
              </button>
              <button class="quick-template-btn qr-style-option text-center py-3" data-template="wifi">
                <div class="text-2xl mb-1">📶</div>
                <div class="text-sm font-medium">Wi-Fi</div>
              </button>
              <button class="quick-template-btn qr-style-option text-center py-3" data-template="email">
                <div class="text-2xl mb-1">📧</div>
                <div class="text-sm font-medium">メール</div>
              </button>
              <button class="quick-template-btn qr-style-option text-center py-3" data-template="phone">
                <div class="text-2xl mb-1">📞</div>
                <div class="text-sm font-medium">電話</div>
              </button>
            </div>
          </div>
          
          <!-- Tabs -->
          <div class="feature-card">
            <div class="flex border-b border-gray-100 mb-6">
              <button class="tab-button active" data-tab="basic">
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm2 6a2 2 0 114 0 2 2 0 01-4 0zm8-1a1 1 0 100-2 1 1 0 000 2z"/>
                  </svg>
                  基本設定
                </span>
              </button>
              <button class="tab-button" data-tab="design">
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v11a3 3 0 106 0V4a2 2 0 00-2-2H4zM3 15a1 1 0 011-1h1a1 1 0 011 1v1a1 1 0 01-1 1H4a1 1 0 01-1-1v-1z" clip-rule="evenodd"/>
                  </svg>
                  デザイン
                </span>
              </button>
              <button class="tab-button" data-tab="advanced">
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                  </svg>
                  高度な設定
                </span>
              </button>
              <button class="tab-button" data-tab="batch">
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a2 2 0 002 2h2a2 2 0 002-2V3a2 2 0 012 2v6.586l-1.293-1.293a1 1 0 00-1.414 1.414L13 13.414V15a2 2 0 01-2 2H9a2 2 0 01-2-2v-1.586l1.707-1.707a1 1 0 00-1.414-1.414L6 11.586V5z" clip-rule="evenodd"/>
                  </svg>
                  一括生成
                </span>
              </button>
            </div>

            <!-- Basic Settings Tab -->
            <div id="basic-tab" class="tab-content">
              <div class="space-y-6">
                <div>
                  <label for="qrText" class="block text-sm font-semibold text-gray-700 mb-3">
                    <span class="flex items-center gap-2">
                      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/>
                      </svg>
                      テキスト/URL
                    </span>
                  </label>
                  <textarea id="qrText"
                            class="form-input w-full h-32 resize-vertical font-mono text-sm"
                            placeholder="テキストやURLを入力してください...&#10;例：https://example.com&#10;またはメールアドレス、電話番号など"
                            data-translate-key="qrGenerator.form.textPlaceholder"></textarea>
                  <div class="mt-2 text-xs text-gray-500 flex items-center justify-between">
                    <span>文字数: <span id="charCount">0</span></span>
                    <span class="tooltip" data-tooltip="QRコードの容量制限に応じて推奨文字数が表示されます">
                      推奨: <span id="recommendedLength">2953</span>文字以下
                    </span>
                  </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label for="qrSize" class="block text-sm font-semibold text-gray-700 mb-2">
                      サイズ (px)
                    </label>
                    <input type="range"
                           id="qrSizeRange"
                           class="w-full mb-2"
                           min="128"
                           max="1024"
                           step="32"
                           value="400" />
                    <input type="number"
                           id="qrSize"
                           class="form-input w-full text-center"
                           value="400"
                           min="128"
                           max="1024"
                           step="32" />
                  </div>
                  
                  <div>
                    <label for="errorCorrection" class="block text-sm font-semibold text-gray-700 mb-2">
                      エラー訂正レベル
                    </label>
                    <select id="errorCorrection" class="form-select w-full">
                      <option value="L">低 (L) - 7%復元</option>
                      <option value="M" selected>中 (M) - 15%復元</option>
                      <option value="Q">高 (Q) - 25%復元</option>
                      <option value="H">最高 (H) - 30%復元</option>
                    </select>
                  </div>
                  
                  <div>
                    <label for="margin" class="block text-sm font-semibold text-gray-700 mb-2">
                      マージン
                    </label>
                    <input type="range"
                           id="marginRange"
                           class="w-full mb-2"
                           min="0"
                           max="10"
                           step="1"
                           value="4" />
                    <input type="number"
                           id="margin"
                           class="form-input w-full text-center"
                           value="4"
                           min="0"
                           max="10"
                           step="1" />
                  </div>
                </div>
              </div>
            </div>            <!-- Design Tab -->
            <div id="design-tab" class="tab-content hidden">
              <div class="space-y-6">
                <!-- Color Settings -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">
                      <span class="flex items-center gap-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v11a3 3 0 106 0V4a2 2 0 00-2-2H4zM3 15a1 1 0 011-1h1a1 1 0 011 1v1a1 1 0 01-1 1H4a1 1 0 01-1-1v-1z" clip-rule="evenodd"/>
                        </svg>
                        前景色（コード部分）
                      </span>
                    </label>
                    <div class="space-y-3">
                      <div class="flex gap-3 items-center">
                        <input type="color"
                               id="foregroundColor"
                               class="w-16 h-10 border-2 border-gray-300 rounded-lg cursor-pointer"
                               value="#000000" />
                        <input type="text"
                               id="foregroundColorText"
                               class="form-input flex-1 font-mono"
                               value="#000000"
                               placeholder="#000000" />
                      </div>
                    </div>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">
                      <span class="flex items-center gap-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"/>
                          <path fill-rule="evenodd" d="M3 8a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                        </svg>
                        背景色
                      </span>
                    </label>
                    <div class="space-y-3">
                      <div class="flex gap-3 items-center">
                        <input type="color"
                               id="backgroundColor"
                               class="w-16 h-10 border-2 border-gray-300 rounded-lg cursor-pointer"
                               value="#ffffff" />
                        <input type="text"
                               id="backgroundColorText"
                               class="form-input flex-1 font-mono"
                               value="#ffffff"
                               placeholder="#ffffff" />
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Color Presets -->
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-3">
                    カラープリセット
                  </label>
                  <div class="grid grid-cols-6 gap-3">
                    <div class="color-preset active tooltip" 
                         data-fg="#000000" 
                         data-bg="#ffffff" 
                         data-tooltip="クラシック（黒/白）"
                         style="background: linear-gradient(45deg, #000000 50%, #ffffff 50%);"></div>
                    <div class="color-preset tooltip" 
                         data-fg="#ffffff" 
                         data-bg="#000000" 
                         data-tooltip="インバース（白/黒）"
                         style="background: linear-gradient(45deg, #ffffff 50%, #000000 50%);"></div>
                    <div class="color-preset tooltip" 
                         data-fg="#1f2937" 
                         data-bg="#f8fafc" 
                         data-tooltip="エレガント（ダークグレー/ライトグレー）"
                         style="background: linear-gradient(45deg, #1f2937 50%, #f8fafc 50%);"></div>
                    <div class="color-preset tooltip" 
                         data-fg="#dc2626" 
                         data-bg="#fef2f2" 
                         data-tooltip="パワフル（赤/ピンク）"
                         style="background: linear-gradient(45deg, #dc2626 50%, #fef2f2 50%);"></div>
                    <div class="color-preset tooltip" 
                         data-fg="#059669" 
                         data-bg="#ecfdf5" 
                         data-tooltip="フレッシュ（緑/ライトグリーン）"
                         style="background: linear-gradient(45deg, #059669 50%, #ecfdf5 50%);"></div>
                    <div class="color-preset tooltip" 
                         data-fg="#2563eb" 
                         data-bg="#eff6ff" 
                         data-tooltip="プロフェッショナル（青/ライトブルー）"
                         style="background: linear-gradient(45deg, #2563eb 50%, #eff6ff 50%);"></div>
                    <div class="color-preset tooltip" 
                         data-fg="#7c3aed" 
                         data-bg="#f5f3ff" 
                         data-tooltip="クリエイティブ（紫/ライトパープル）"
                         style="background: linear-gradient(45deg, #7c3aed 50%, #f5f3ff 50%);"></div>
                    <div class="color-preset tooltip" 
                         data-fg="#ea580c" 
                         data-bg="#fff7ed" 
                         data-tooltip="ウォーム（オレンジ/ライトオレンジ）"
                         style="background: linear-gradient(45deg, #ea580c 50%, #fff7ed 50%);"></div>
                    <div class="color-preset tooltip" 
                         data-fg="#be185d" 
                         data-bg="#fdf2f8" 
                         data-tooltip="ロマンティック（ピンク/ライトピンク）"
                         style="background: linear-gradient(45deg, #be185d 50%, #fdf2f8 50%);"></div>
                    <div class="color-preset tooltip" 
                         data-fg="#0891b2" 
                         data-bg="#f0f9ff" 
                         data-tooltip="クール（シアン/ライトシアン）"
                         style="background: linear-gradient(45deg, #0891b2 50%, #f0f9ff 50%);"></div>
                    <div class="color-preset tooltip" 
                         data-fg="#65a30d" 
                         data-bg="#f7fee7" 
                         data-tooltip="ナチュラル（ライム/ライトライム）"
                         style="background: linear-gradient(45deg, #65a30d 50%, #f7fee7 50%);"></div>
                    <div class="color-preset tooltip" 
                         data-fg="#a855f7" 
                         data-bg="#faf5ff" 
                         data-tooltip="ミステリアス（バイオレット/ライトバイオレット）"
                         style="background: linear-gradient(45deg, #a855f7 50%, #faf5ff 50%);"></div>
                  </div>
                </div>

                <!-- Style Options -->
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-3">
                    QRコードスタイル
                  </label>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="qr-style-option active" data-style="square">
                      <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-gray-800 grid grid-cols-3 gap-0.5">
                          <div class="bg-white"></div><div class="bg-gray-800"></div><div class="bg-white"></div>
                          <div class="bg-gray-800"></div><div class="bg-white"></div><div class="bg-gray-800"></div>
                          <div class="bg-white"></div><div class="bg-gray-800"></div><div class="bg-white"></div>
                        </div>
                        <div>
                          <div class="font-medium">標準（四角形）</div>
                          <div class="text-sm text-gray-500">クラシックなQRコード</div>
                        </div>
                      </div>
                    </div>
                    <div class="qr-style-option" data-style="rounded">
                      <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-gray-800 grid grid-cols-3 gap-0.5 rounded">
                          <div class="bg-white rounded-sm"></div><div class="bg-gray-800 rounded-sm"></div><div class="bg-white rounded-sm"></div>
                          <div class="bg-gray-800 rounded-sm"></div><div class="bg-white rounded-sm"></div><div class="bg-gray-800 rounded-sm"></div>
                          <div class="bg-white rounded-sm"></div><div class="bg-gray-800 rounded-sm"></div><div class="bg-white rounded-sm"></div>
                        </div>
                        <div>
                          <div class="font-medium">丸角</div>
                          <div class="text-sm text-gray-500">モダンなデザイン</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Logo Upload -->
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-3">
                    <span class="flex items-center gap-2">
                      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                      </svg>
                      ロゴ/画像の挿入
                    </span>
                  </label>
                  <div class="file-drop-zone" id="logoDropZone">
                    <svg class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    <p class="text-sm text-gray-600 mb-2">ロゴ画像をドラッグ＆ドロップ</p>
                    <p class="text-xs text-gray-500 mb-3">または</p>
                    <input type="file" id="logoInput" accept="image/*" class="hidden">
                    <button type="button" class="form-button secondary text-sm" onclick="document.getElementById('logoInput').click()">
                      ファイルを選択
                    </button>
                  </div>
                  <div id="logoPreview" class="mt-3 hidden">
                    <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                      <img id="logoPreviewImage" class="w-12 h-12 object-contain rounded" />
                      <div class="flex-1">
                        <div class="text-sm font-medium" id="logoFileName"></div>
                        <div class="text-xs text-gray-500">
                          サイズ: <span id="logoSize"></span>
                        </div>
                      </div>
                      <button type="button" id="removeLogo" class="text-red-500 hover:text-red-700">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>            <!-- Advanced Settings Tab -->
            <div id="advanced-tab" class="tab-content hidden">
              <div class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label for="moduleSize" class="block text-sm font-semibold text-gray-700 mb-2">
                      モジュールサイズ
                    </label>
                    <input type="range"
                           id="moduleSizeRange"
                           class="w-full mb-2"
                           min="1"
                           max="20"
                           step="1"
                           value="4" />
                    <input type="number"
                           id="moduleSize"
                           class="form-input w-full text-center"
                           value="4"
                           min="1"
                           max="20"
                           step="1" />
                    <div class="text-xs text-gray-500 mt-1">QRコードの点の大きさを調整</div>
                  </div>
                  
                  <div>
                    <label for="quietZone" class="block text-sm font-semibold text-gray-700 mb-2">
                      クワイエットゾーン
                    </label>
                    <input type="range"
                           id="quietZoneRange"
                           class="w-full mb-2"
                           min="0"
                           max="20"
                           step="1"
                           value="4" />
                    <input type="number"
                           id="quietZone"
                           class="form-input w-full text-center"
                           value="4"
                           min="0"
                           max="20"
                           step="1" />
                    <div class="text-xs text-gray-500 mt-1">QRコード周囲の余白</div>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">
                      出力形式
                    </label>
                    <div class="space-y-2">
                      <label class="flex items-center">
                        <input type="radio" name="outputFormat" value="png" checked class="mr-2">
                        <span class="text-sm">PNG（推奨）</span>
                      </label>
                      <label class="flex items-center">
                        <input type="radio" name="outputFormat" value="svg" class="mr-2">
                        <span class="text-sm">SVG（ベクター）</span>
                      </label>
                      <label class="flex items-center">
                        <input type="radio" name="outputFormat" value="pdf" class="mr-2">
                        <span class="text-sm">PDF</span>
                      </label>
                    </div>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">
                      品質設定
                    </label>
                    <div class="space-y-2">
                      <label class="flex items-center">
                        <input type="radio" name="quality" value="draft" class="mr-2">
                        <span class="text-sm">ドラフト（高速）</span>
                      </label>
                      <label class="flex items-center">
                        <input type="radio" name="quality" value="standard" checked class="mr-2">
                        <span class="text-sm">標準</span>
                      </label>
                      <label class="flex items-center">
                        <input type="radio" name="quality" value="high" class="mr-2">
                        <span class="text-sm">高品質（低速）</span>
                      </label>
                    </div>
                  </div>
                </div>

                <div>
                  <label class="flex items-center mb-3">
                    <input type="checkbox" id="enableLivePreview" checked class="mr-2">
                    <span class="text-sm font-semibold text-gray-700">リアルタイムプレビュー</span>
                  </label>
                  <div class="text-xs text-gray-500">設定を変更するたびに自動でQRコードを更新します</div>
                </div>

                <div>
                  <label class="flex items-center mb-3">
                    <input type="checkbox" id="embedMetadata" class="mr-2">
                    <span class="text-sm font-semibold text-gray-700">メタデータの埋め込み</span>
                  </label>
                  <div class="text-xs text-gray-500">生成日時、設定情報を画像に埋め込みます</div>
                </div>
              </div>
            </div>

            <!-- Batch Generation Tab -->
            <div id="batch-tab" class="tab-content hidden">
              <div class="space-y-6">
                <div>
                  <label for="batchText" class="block text-sm font-semibold text-gray-700 mb-3">
                    <span class="flex items-center gap-2">
                      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a2 2 0 002 2h2a2 2 0 002-2V3a2 2 0 012 2v6.586l-1.293-1.293a1 1 0 00-1.414 1.414L13 13.414V15a2 2 0 01-2 2H9a2 2 0 01-2-2v-1.586l1.707-1.707a1 1 0 00-1.414-1.414L6 11.586V5z" clip-rule="evenodd"/>
                      </svg>
                      一括生成用テキスト
                    </span>
                  </label>
                  <textarea id="batchText"
                            class="form-input w-full h-40 resize-vertical font-mono text-sm"
                            placeholder="1行につき1つのテキスト/URLを入力&#10;例：&#10;https://example.com/page1&#10;https://example.com/page2&#10;メールアドレス@example.com&#10;電話:090-1234-5678"></textarea>
                  <div class="mt-2 flex items-center justify-between text-xs text-gray-500">
                    <span>行数: <span id="batchLineCount">0</span></span>
                    <button type="button" class="text-blue-600 hover:text-blue-800" id="loadBatchTemplate">
                      テンプレートを読み込み
                    </button>
                  </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label for="batchSize" class="block text-sm font-semibold text-gray-700 mb-2">
                      サイズ (px)
                    </label>
                    <input type="number"
                           id="batchSize"
                           class="form-input w-full text-center"
                           value="400"
                           min="128"
                           max="1024"
                           step="32" />
                  </div>
                  
                  <div>
                    <label for="batchErrorCorrection" class="block text-sm font-semibold text-gray-700 mb-2">
                      エラー訂正
                    </label>
                    <select id="batchErrorCorrection" class="form-select w-full">
                      <option value="L">低 (L) - 7%復元</option>
                      <option value="M" selected>中 (M) - 15%復元</option>
                      <option value="Q">高 (Q) - 25%復元</option>
                      <option value="H">最高 (H) - 30%復元</option>
                    </select>
                  </div>
                  
                  <div>
                    <label for="batchNamingPattern" class="block text-sm font-semibold text-gray-700 mb-2">
                      ファイル名パターン
                    </label>
                    <select id="batchNamingPattern" class="form-select w-full">
                      <option value="qr_{index}">qr_1, qr_2, ...</option>
                      <option value="qr_{content}">qr_内容テキスト</option>
                      <option value="{content}">内容テキスト</option>
                      <option value="qr_{timestamp}_{index}">qr_時刻_番号</option>
                    </select>
                  </div>
                </div>
                
                <div>
                  <button id="batchGenerateBtn"
                          class="form-button w-full py-3 text-lg font-semibold">
                    <span class="flex items-center justify-center gap-2">
                      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                      </svg>
                      一括生成・ZIPダウンロード
                    </span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Live Preview Panel -->
        <div class="xl:col-span-1">
          <div class="feature-card live-preview">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-semibold text-gray-900">
                <span class="flex items-center gap-2">
                  <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.293l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"/>
                  </svg>
                  ライブプレビュー
                </span>
              </h2>
              <div id="previewStatus" class="text-sm text-gray-500">待機中</div>
            </div>
            
            <div id="qrcodeOutput" class="qr-preview-container mb-4">
              <div class="text-center text-gray-400">
                <svg class="w-20 h-20 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M3 3h8v8H3V3zm2 2v4h4V5H5zm8-2h8v8h-8V3zm2 2v4h4V5h-4zM3 13h8v8H3v-8zm2 2v4h4v-4H5zm10 0h2v2h-2v-2zm0 4h2v2h-2v-2zm4-4h2v2h-2v-2zm0 4h2v2h-2v-2zm-6-6h2v2h-2v-2zm2-2h2v2h-2v-2z"/>
                </svg>
                <p class="text-lg font-medium mb-2">QRコードプレビュー</p>
                <p class="text-sm">テキストを入力すると<br>ここにQRコードが表示されます</p>
              </div>
            </div>
            
            <!-- QR Info Panel -->
            <div id="qrInfoPanel" class="hidden slide-up">
              <div class="border-t border-gray-100 pt-4 space-y-3">
                <div class="flex items-center justify-between text-sm">
                  <span class="text-gray-600">データサイズ</span>
                  <span id="qrDataSize" class="font-mono">0 bytes</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                  <span class="text-gray-600">バージョン</span>
                  <span id="qrVersion" class="font-mono">-</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                  <span class="text-gray-600">モジュール数</span>
                  <span id="qrModules" class="font-mono">-</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                  <span class="text-gray-600">推定読み取り距離</span>
                  <span id="qrReadDistance" class="font-mono">-</span>
                </div>
              </div>
            </div>
            
            <!-- Download Actions -->
            <div id="downloadSection" class="hidden slide-up">
              <div class="border-t border-gray-100 pt-4 space-y-3">
                <button id="downloadBtn" class="form-button w-full py-2">
                  <span class="flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                    ダウンロード
                  </span>
                </button>
                
                <div class="grid grid-cols-2 gap-2">
                  <button id="copyToClipboardBtn" class="form-button secondary text-sm py-2">
                    <span class="flex items-center justify-center gap-1">
                      <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/>
                        <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"/>
                      </svg>
                      コピー
                    </span>
                  </button>
                  <button id="shareBtn" class="form-button secondary text-sm py-2">
                    <span class="flex items-center justify-center gap-1">
                      <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"/>
                      </svg>
                      共有
                    </span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Batch Progress -->
            <div id="batchDownloadSection" class="hidden slide-up">
              <div class="border-t border-gray-100 pt-4">
                <div class="mb-3">
                  <div class="flex items-center justify-between text-sm mb-2">
                    <span class="text-gray-600">進行状況</span>
                    <span id="batchProgress" class="font-mono">0 / 0</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                    <div id="batchProgressBar" 
                         class="bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full transition-all duration-500 ease-out" 
                         style="width: 0%"></div>
                  </div>
                </div>
                <div id="batchStatus" class="text-sm text-gray-600 text-center">準備中...</div>
              </div>
            </div>
          </div>
        </div>
      </div>      <!-- Feature Highlights -->
      <div class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="feature-card text-center">
          <div class="w-16 h-16 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </div>
          <h3 class="text-lg font-semibold mb-2">リアルタイム生成</h3>
          <p class="text-gray-600 text-sm">入力と同時にQRコードを生成。設定変更も即座に反映されます。</p>
        </div>
        
        <div class="feature-card text-center">
          <div class="w-16 h-16 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v11a3 3 0 106 0V4a2 2 0 00-2-2H4zM3 15a1 1 0 011-1h1a1 1 0 011 1v1a1 1 0 01-1 1H4a1 1 0 01-1-1v-1z" clip-rule="evenodd"/>
            </svg>
          </div>
          <h3 class="text-lg font-semibold mb-2">高度なカスタマイズ</h3>
          <p class="text-gray-600 text-sm">色、サイズ、ロゴ挿入など豊富なカスタマイズオプションを提供。</p>
        </div>
        
        <div class="feature-card text-center">
          <div class="w-16 h-16 bg-gradient-to-br from-purple-400 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
              <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a2 2 0 002 2h2a2 2 0 002-2V3a2 2 0 012 2v6.586l-1.293-1.293a1 1 0 00-1.414 1.414L13 13.414V15a2 2 0 01-2 2H9a2 2 0 01-2-2v-1.586l1.707-1.707a1 1 0 00-1.414-1.414L6 11.586V5z" clip-rule="evenodd"/>
            </svg>
          </div>
          <h3 class="text-lg font-semibold mb-2">一括処理</h3>
          <p class="text-gray-600 text-sm">複数のテキスト/URLを一度に処理してZIPファイルで一括ダウンロード。</p>
        </div>
      </div>

      <!-- Statistics Section -->
      <div class="mt-12 feature-card">
        <h2 class="text-xl font-semibold text-gray-900 mb-6 text-center">
          <span class="flex items-center justify-center gap-2">
            <svg class="w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 20 20">
              <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
            </svg>
            生成統計
          </span>
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div class="text-center">
            <div class="text-3xl font-bold text-green-600 mb-2" id="totalGenerated">0</div>
            <div class="text-sm text-gray-600 font-medium">総生成数</div>
            <div class="text-xs text-gray-500 mt-1">累計の生成回数</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-blue-600 mb-2" id="sessionGenerated">0</div>
            <div class="text-sm text-gray-600 font-medium">今回のセッション</div>
            <div class="text-xs text-gray-500 mt-1">このページでの生成数</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-purple-600 mb-2" id="avgGenerationTime">-</div>
            <div class="text-sm text-gray-600 font-medium">平均生成時間</div>
            <div class="text-xs text-gray-500 mt-1">ミリ秒</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-orange-600 mb-2" id="lastGeneratedTime">-</div>
            <div class="text-sm text-gray-600 font-medium">最終生成時刻</div>
            <div class="text-xs text-gray-500 mt-1">HH:MM:SS</div>
          </div>
        </div>
      </div>    </div>
  </main>

  <section class="mt-12 mb-8 text-sm text-gray-700 bg-white rounded-lg p-4 border border-gray-200 max-w-xl mx-auto" aria-label="このツールについて">
    <h2 class="font-bold text-base mb-2">negi-lab.comの独自性・運営方針・免責事項</h2>
    <ul class="list-disc ml-5 mb-2">
      <li>本ツールはnegi-lab.comが独自開発・運営しています。</li>
      <li>広告・アフィリエイトを含みますが、ユーザー体験を最優先しています。</li>
      <li>正確性・安全性には万全を期していますが、利用は自己責任でお願いします。</li>
    </ul>
    <p class="text-xs text-gray-500">&copy; 2025 negi-lab.com</p>
  </section>

  <footer class="bg-gray-800 text-gray-300 py-8 text-center text-sm">
    <nav class="mb-2">
      <a href="/privacy-policy-unified.html" class="underline hover:text-accent mx-2">プライバシーポリシー</a>
      <a href="/terms.html" class="underline hover:text-accent mx-2">利用規約</a>
      <a href="/about.html" class="underline hover:text-accent mx-2">運営者情報</a>
      <a href="mailto:negilab.com@gmail.com" class="underline hover:text-accent mx-2">お問い合わせ</a>
      <a href="/sitemap.xml" class="underline hover:text-accent mx-2">サイトマップ</a>
    </nav>
    <div>&copy; 2025 negi-lab.com</div>
  </footer>
  <!-- Guide Modal Popup -->
  <div id="guide-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 hidden" role="dialog" aria-modal="true" aria-labelledby="guide-modal-title">
    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full p-6 relative">
      <button id="guide-close" class="absolute top-2 right-2 text-gray-400 hover:text-accent text-2xl font-bold" aria-label="閉じる">&times;</button>
      <div id="guide-modal-content"></div>
    </div>
  </div>
  <!-- JavaScript -->
  <script>
    // 高機能QRコード生成クラス
    class AdvancedQRGenerator {
      constructor() {
        this.initializeElements();
        this.initializeEventListeners();
        this.initializeDefaults();
        this.loadUserPreferences();
        this.sessionGenerated = 0;
        this.generationTimes = [];
        this.currentLogo = null;
        
        console.log('✅ 高機能QRコード生成ツール初期化完了');
      }

      initializeElements() {
        // タブ関連
        this.tabs = {
          basic: document.getElementById('basic-tab'),
          design: document.getElementById('design-tab'),
          advanced: document.getElementById('advanced-tab'),
          batch: document.getElementById('batch-tab')
        };

        // 基本設定
        this.elements = {
          qrText: document.getElementById('qrText'),
          qrSize: document.getElementById('qrSize'),
          qrSizeRange: document.getElementById('qrSizeRange'),
          errorCorrection: document.getElementById('errorCorrection'),
          margin: document.getElementById('margin'),
          marginRange: document.getElementById('marginRange'),
          
          // デザイン設定
          foregroundColor: document.getElementById('foregroundColor'),
          foregroundColorText: document.getElementById('foregroundColorText'),
          backgroundColor: document.getElementById('backgroundColor'),
          backgroundColorText: document.getElementById('backgroundColorText'),
          
          // 高度な設定
          moduleSize: document.getElementById('moduleSize'),
          moduleSizeRange: document.getElementById('moduleSizeRange'),
          quietZone: document.getElementById('quietZone'),
          quietZoneRange: document.getElementById('quietZoneRange'),
          enableLivePreview: document.getElementById('enableLivePreview'),
          embedMetadata: document.getElementById('embedMetadata'),
          
          // 一括生成
          batchText: document.getElementById('batchText'),
          batchSize: document.getElementById('batchSize'),
          batchErrorCorrection: document.getElementById('batchErrorCorrection'),
          batchNamingPattern: document.getElementById('batchNamingPattern'),
          
          // 出力関連
          qrcodeOutput: document.getElementById('qrcodeOutput'),
          downloadSection: document.getElementById('downloadSection'),
          downloadBtn: document.getElementById('downloadBtn'),
          copyToClipboardBtn: document.getElementById('copyToClipboardBtn'),
          shareBtn: document.getElementById('shareBtn'),
          
          // UI要素
          charCount: document.getElementById('charCount'),
          recommendedLength: document.getElementById('recommendedLength'),
          previewStatus: document.getElementById('previewStatus'),
          qrInfoPanel: document.getElementById('qrInfoPanel'),
          
          // ロゴ関連
          logoInput: document.getElementById('logoInput'),
          logoDropZone: document.getElementById('logoDropZone'),
          logoPreview: document.getElementById('logoPreview'),
          logoPreviewImage: document.getElementById('logoPreviewImage'),
          logoFileName: document.getElementById('logoFileName'),
          logoSize: document.getElementById('logoSize'),
          removeLogo: document.getElementById('removeLogo'),
          
          // 統計
          totalGenerated: document.getElementById('totalGenerated'),
          sessionGenerated: document.getElementById('sessionGenerated'),
          avgGenerationTime: document.getElementById('avgGenerationTime'),
          lastGeneratedTime: document.getElementById('lastGeneratedTime')
        };
      }

      initializeEventListeners() {
        // タブ切り替え
        document.querySelectorAll('.tab-button').forEach(button => {
          button.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
        });

        // リアルタイム入力監視
        this.elements.qrText.addEventListener('input', () => this.handleTextInput());
        this.elements.qrText.addEventListener('paste', () => setTimeout(() => this.handleTextInput(), 10));

        // サイズ調整（スライダーとの同期）
        this.elements.qrSizeRange.addEventListener('input', (e) => {
          this.elements.qrSize.value = e.target.value;
          this.regenerateQR();
        });
        this.elements.qrSize.addEventListener('input', (e) => {
          this.elements.qrSizeRange.value = e.target.value;
          this.regenerateQR();
        });

        // マージン調整
        this.elements.marginRange.addEventListener('input', (e) => {
          this.elements.margin.value = e.target.value;
          this.regenerateQR();
        });
        this.elements.margin.addEventListener('input', (e) => {
          this.elements.marginRange.value = e.target.value;
          this.regenerateQR();
        });

        // モジュールサイズ調整
        this.elements.moduleSizeRange.addEventListener('input', (e) => {
          this.elements.moduleSize.value = e.target.value;
          this.regenerateQR();
        });
        this.elements.moduleSize.addEventListener('input', (e) => {
          this.elements.moduleSizeRange.value = e.target.value;
          this.regenerateQR();
        });

        // クワイエットゾーン調整
        this.elements.quietZoneRange.addEventListener('input', (e) => {
          this.elements.quietZone.value = e.target.value;
          this.regenerateQR();
        });
        this.elements.quietZone.addEventListener('input', (e) => {
          this.elements.quietZoneRange.value = e.target.value;
          this.regenerateQR();
        });

        // 色の変更
        this.elements.foregroundColor.addEventListener('input', (e) => {
          this.elements.foregroundColorText.value = e.target.value;
          this.regenerateQR();
        });
        this.elements.foregroundColorText.addEventListener('input', (e) => {
          this.elements.foregroundColor.value = e.target.value;
          this.regenerateQR();
        });
        this.elements.backgroundColor.addEventListener('input', (e) => {
          this.elements.backgroundColorText.value = e.target.value;
          this.regenerateQR();
        });
        this.elements.backgroundColorText.addEventListener('input', (e) => {
          this.elements.backgroundColor.value = e.target.value;
          this.regenerateQR();
        });

        // エラー訂正レベル変更
        this.elements.errorCorrection.addEventListener('change', () => this.regenerateQR());

        // カラープリセット
        document.querySelectorAll('.color-preset').forEach(preset => {
          preset.addEventListener('click', () => this.applyColorPreset(preset));
        });

        // スタイル選択
        document.querySelectorAll('.qr-style-option').forEach(option => {
          option.addEventListener('click', () => this.selectStyle(option));
        });

        // クイックテンプレート
        document.querySelectorAll('.quick-template-btn').forEach(btn => {
          btn.addEventListener('click', () => this.applyTemplate(btn.dataset.template));
        });

        // ロゴ関連
        this.elements.logoInput.addEventListener('change', (e) => this.handleLogoUpload(e.target.files[0]));
        this.elements.removeLogo.addEventListener('click', () => this.removeLogo());
        this.setupLogoDropZone();

        // ダウンロード関連
        this.elements.downloadBtn.addEventListener('click', () => this.downloadQR());
        this.elements.copyToClipboardBtn.addEventListener('click', () => this.copyToClipboard());
        this.elements.shareBtn.addEventListener('click', () => this.shareQR());

        // クイックアクション
        document.getElementById('clearAllBtn').addEventListener('click', () => this.clearAll());
        document.getElementById('randomizeBtn').addEventListener('click', () => this.randomizeSettings());        // 一括生成
        document.getElementById('batchGenerateBtn').addEventListener('click', () => this.batchGenerate());
        this.elements.batchText.addEventListener('input', () => this.updateBatchLineCount());
        document.getElementById('loadBatchTemplate').addEventListener('click', () => this.loadBatchTemplate());

        // リアルタイムプレビューの切り替え
        this.elements.enableLivePreview.addEventListener('change', () => {
          if (this.elements.enableLivePreview.checked) {
            this.regenerateQR();
          }
        });

        // フォーム要素の変更を監視
        ['change', 'input'].forEach(eventType => {
          document.querySelectorAll('input[type="radio"], input[type="checkbox"], select').forEach(element => {
            element.addEventListener(eventType, () => this.regenerateQR());
          });
        });
      }

      initializeDefaults() {
        this.updateCharCount();
        this.updateBatchLineCount();
        this.loadStatistics();
      }

      loadUserPreferences() {
        const preferences = JSON.parse(localStorage.getItem('qr_preferences') || '{}');
        
        // 保存された設定を復元
        Object.keys(preferences).forEach(key => {
          const element = document.getElementById(key);
          if (element) {
            if (element.type === 'checkbox') {
              element.checked = preferences[key];
            } else {
              element.value = preferences[key];
            }
          }
        });
      }

      saveUserPreferences() {
        const preferences = {};
        
        // 主要な設定を保存
        const saveElements = [
          'qrSize', 'errorCorrection', 'margin', 'moduleSize', 'quietZone',
          'foregroundColor', 'backgroundColor', 'enableLivePreview', 'embedMetadata'
        ];
        
        saveElements.forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            if (element.type === 'checkbox') {
              preferences[id] = element.checked;
            } else {
              preferences[id] = element.value;
            }
          }
        });
        
        localStorage.setItem('qr_preferences', JSON.stringify(preferences));
      }

      switchTab(tabName) {
        // タブボタンの切り替え
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

        // タブコンテンツの切り替え
        Object.values(this.tabs).forEach(tab => tab.classList.add('hidden'));
        this.tabs[tabName].classList.remove('hidden');
      }

      handleTextInput() {
        this.updateCharCount();
        if (this.elements.enableLivePreview.checked) {
          clearTimeout(this.inputTimeout);
          this.inputTimeout = setTimeout(() => this.regenerateQR(), 300);
        }
      }

      updateCharCount() {
        const text = this.elements.qrText.value;
        const charCount = text.length;
        const errorLevel = this.elements.errorCorrection.value;
        
        // エラー訂正レベルに応じた推奨文字数
        const recommendedLengths = { L: 2953, M: 2331, Q: 1663, H: 1273 };
        const recommended = recommendedLengths[errorLevel] || 2331;
        
        this.elements.charCount.textContent = charCount;
        this.elements.recommendedLength.textContent = recommended;
        
        // 文字数の色分け
        if (charCount > recommended) {
          this.elements.charCount.className = 'text-red-600 font-bold';
        } else if (charCount > recommended * 0.8) {
          this.elements.charCount.className = 'text-yellow-600 font-bold';
        } else {
          this.elements.charCount.className = 'text-green-600 font-bold';
        }
      }

      updateBatchLineCount() {
        const lines = this.elements.batchText.value.split('\n').filter(line => line.trim()).length;
        document.getElementById('batchLineCount').textContent = lines;
      }

      async regenerateQR() {
        if (!this.elements.enableLivePreview.checked) return;
        
        const text = this.elements.qrText.value.trim();
        if (!text) {
          this.clearPreview();
          return;
        }

        this.updatePreviewStatus('生成中...');
        const startTime = performance.now();

        try {
          const qrOptions = this.getQROptions();
          const qrDataURL = await this.generateQRCode(text, qrOptions);
          
          this.displayQRCode(qrDataURL);
          this.updateQRInfo(text, qrOptions);
          this.updatePreviewStatus('完了');
          
          const endTime = performance.now();
          this.generationTimes.push(endTime - startTime);
          
        } catch (error) {
          console.error('QRコード生成エラー:', error);
          this.updatePreviewStatus('エラー', true);
        }
      }

      getQROptions() {
        return {
          size: parseInt(this.elements.qrSize.value),
          errorCorrection: this.elements.errorCorrection.value,
          margin: parseInt(this.elements.margin.value),
          moduleSize: parseInt(this.elements.moduleSize.value),
          quietZone: parseInt(this.elements.quietZone.value),
          foregroundColor: this.elements.foregroundColor.value,
          backgroundColor: this.elements.backgroundColor.value,
          logo: this.currentLogo,
          embedMetadata: this.elements.embedMetadata.checked
        };
      }

      async generateQRCode(text, options) {
        return new Promise((resolve, reject) => {
          try {
            // qrcode.jsライブラリを使用
            const QRCodeLib = window.QRCode || window.qrcode;
            if (!QRCodeLib) {
              throw new Error('QRコードライブラリが見つかりません');
            }

            const canvas = document.createElement('canvas');
            canvas.width = options.size;
            canvas.height = options.size;

            const qrOptions = {
              width: options.size,
              height: options.size,
              margin: options.margin,
              color: {
                dark: options.foregroundColor,
                light: options.backgroundColor
              },
              errorCorrectionLevel: options.errorCorrection
            };

            QRCodeLib.toCanvas(canvas, text, qrOptions, (error) => {
              if (error) {
                reject(error);
                return;
              }

              // ロゴの合成
              if (options.logo) {
                this.compositeLogoOnQR(canvas, options.logo).then(resolve).catch(reject);
              } else {
                resolve(canvas.toDataURL('image/png'));
              }
            });

          } catch (error) {
            reject(error);
          }
        });
      }

      async compositeLogoOnQR(canvas, logoData) {
        return new Promise((resolve) => {
          const ctx = canvas.getContext('2d');
          const img = new Image();
          
          img.onload = () => {
            const logoSize = Math.min(canvas.width * 0.15, 80); // ロゴサイズを制限
            const x = (canvas.width - logoSize) / 2;
            const y = (canvas.height - logoSize) / 2;
            
            // 背景の白い円を描画（ロゴを見やすくする）
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.arc(canvas.width / 2, canvas.height / 2, logoSize / 2 + 5, 0, 2 * Math.PI);
            ctx.fill();
            
            // ロゴを描画
            ctx.drawImage(img, x, y, logoSize, logoSize);
            
            resolve(canvas.toDataURL('image/png'));
          };
          
          img.src = logoData;
        });
      }

      displayQRCode(dataURL) {
        this.elements.qrcodeOutput.innerHTML = `<img src="${dataURL}" alt="Generated QR Code" class="max-w-full h-auto" />`;
        this.elements.qrcodeOutput.classList.add('has-content');
        this.elements.downloadSection.classList.remove('hidden');
        this.elements.qrInfoPanel.classList.remove('hidden');
        this.currentQRDataURL = dataURL;
      }

      clearPreview() {
        this.elements.qrcodeOutput.innerHTML = `
          <div class="text-center text-gray-400">
            <svg class="w-20 h-20 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 24 24">
              <path d="M3 3h8v8H3V3zm2 2v4h4V5H5zm8-2h8v8h-8V3zm2 2v4h4V5h-4zM3 13h8v8H3v-8zm2 2v4h4v-4H5zm10 0h2v2h-2v-2zm0 4h2v2h-2v-2zm4-4h2v2h-2v-2zm0 4h2v2h-2v-2zm-6-6h2v2h-2v-2zm2-2h2v2h-2v-2z"/>
            </svg>
            <p class="text-lg font-medium mb-2">QRコードプレビュー</p>
            <p class="text-sm">テキストを入力すると<br>ここにQRコードが表示されます</p>
          </div>
        `;
        this.elements.qrcodeOutput.classList.remove('has-content');
        this.elements.downloadSection.classList.add('hidden');
        this.elements.qrInfoPanel.classList.add('hidden');
        this.updatePreviewStatus('待機中');
      }

      updatePreviewStatus(status, isError = false) {
        this.elements.previewStatus.textContent = status;
        if (isError) {
          this.elements.previewStatus.className = 'text-sm text-red-500';
        } else {
          this.elements.previewStatus.className = 'text-sm text-gray-500';
        }
      }

      updateQRInfo(text, options) {
        // データサイズ計算
        const dataSize = new Blob([text]).size;
        document.getElementById('qrDataSize').textContent = `${dataSize} bytes`;
        
        // バージョン推定（簡単な計算）
        const version = Math.ceil(Math.sqrt(text.length / 10)) + 1;
        document.getElementById('qrVersion').textContent = `${Math.min(version, 40)}`;
        
        // モジュール数計算
        const modules = 21 + (version - 1) * 4;
        document.getElementById('qrModules').textContent = `${modules}×${modules}`;
        
        // 読み取り距離推定
        const distance = Math.ceil(options.size / 10);
        document.getElementById('qrReadDistance').textContent = `約${distance}cm`;
      }

      applyColorPreset(preset) {
        // 既存のアクティブプリセットを解除
        document.querySelectorAll('.color-preset').forEach(p => p.classList.remove('active'));
        preset.classList.add('active');
        
        const fg = preset.dataset.fg;
        const bg = preset.dataset.bg;
        
        this.elements.foregroundColor.value = fg;
        this.elements.foregroundColorText.value = fg;
        this.elements.backgroundColor.value = bg;
        this.elements.backgroundColorText.value = bg;
        
        this.regenerateQR();
      }

      selectStyle(option) {
        document.querySelectorAll('.qr-style-option').forEach(opt => opt.classList.remove('active'));
        option.classList.add('active');
        this.regenerateQR();
      }

      applyTemplate(template) {
        const templates = {
          url: 'https://example.com',
          wifi: 'WIFI:T:WPA;S:NetworkName;P:Password;;',
          email: 'mailto:example@domain.com?subject=件名&body=本文',
          phone: 'tel:+81-90-1234-5678'
        };
        
        this.elements.qrText.value = templates[template] || '';
        this.handleTextInput();
      }

      setupLogoDropZone() {
        const dropZone = this.elements.logoDropZone;
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
          });
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
          dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'));
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'));
        });
        
        dropZone.addEventListener('drop', (e) => {
          const files = e.dataTransfer.files;
          if (files.length > 0 && files[0].type.startsWith('image/')) {
            this.handleLogoUpload(files[0]);
          }
        });
      }

      handleLogoUpload(file) {
        if (!file || !file.type.startsWith('image/')) {
          alert('画像ファイルを選択してください。');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
          this.currentLogo = e.target.result;
          this.elements.logoPreviewImage.src = e.target.result;
          this.elements.logoFileName.textContent = file.name;
          this.elements.logoSize.textContent = `${Math.round(file.size / 1024)}KB`;
          this.elements.logoPreview.classList.remove('hidden');
          this.regenerateQR();
        };
        reader.readAsDataURL(file);
      }

      removeLogo() {
        this.currentLogo = null;
        this.elements.logoPreview.classList.add('hidden');
        this.elements.logoInput.value = '';
        this.regenerateQR();
      }

      downloadQR() {
        if (!this.currentQRDataURL) return;
        
        const link = document.createElement('a');
        link.download = `qrcode_${new Date().getTime()}.png`;
        link.href = this.currentQRDataURL;
        link.click();
        
        this.updateStatistics();
      }

      async copyToClipboard() {
        if (!this.currentQRDataURL) return;
        
        try {
          const response = await fetch(this.currentQRDataURL);
          const blob = await response.blob();
          await navigator.clipboard.write([
            new ClipboardItem({ 'image/png': blob })
          ]);
          alert('QRコードをクリップボードにコピーしました！');
        } catch (error) {
          console.error('クリップボードへのコピーに失敗:', error);
          alert('クリップボードへのコピーに失敗しました。');
        }
      }

      shareQR() {
        if (!this.currentQRDataURL || !navigator.share) {
          alert('この機能はサポートされていません。');
          return;
        }
        
        fetch(this.currentQRDataURL)
          .then(res => res.blob())
          .then(blob => {
            const file = new File([blob], 'qrcode.png', { type: 'image/png' });
            return navigator.share({
              title: 'QRコード',
              text: 'QRコードを共有します',
              files: [file]
            });
          })
          .catch(error => {
            console.error('共有に失敗:', error);
            alert('共有に失敗しました。');
          });
      }

      clearAll() {
        this.elements.qrText.value = '';
        this.removeLogo();
        this.clearPreview();
        this.handleTextInput();
      }

      randomizeSettings() {
        const colors = ['#000000', '#dc2626', '#059669', '#2563eb', '#7c3aed', '#ea580c'];
        const sizes = [256, 320, 400, 512, 640];
        
        this.elements.qrSize.value = sizes[Math.floor(Math.random() * sizes.length)];
        this.elements.qrSizeRange.value = this.elements.qrSize.value;
        
        const fg = colors[Math.floor(Math.random() * colors.length)];
        const bg = '#ffffff';
        
        this.elements.foregroundColor.value = fg;
        this.elements.foregroundColorText.value = fg;
        this.elements.backgroundColor.value = bg;
        this.elements.backgroundColorText.value = bg;
        
        this.regenerateQR();
      }      async batchGenerate() {
        const texts = this.elements.batchText.value
          .split('\n')
          .map(line => line.trim())
          .filter(line => line);
        
        if (texts.length === 0) {
          alert('一括生成するテキストを入力してください。');
          return;
        }
        
        const batchSection = document.getElementById('batchDownloadSection');
        const progressBar = document.getElementById('batchProgressBar');
        const progressText = document.getElementById('batchProgress');
        const statusText = document.getElementById('batchStatus');
        
        batchSection.classList.remove('hidden');
        
        const options = {
          size: parseInt(this.elements.batchSize.value),
          errorCorrection: this.elements.batchErrorCorrection.value,
          margin: 4,
          foregroundColor: this.elements.foregroundColor.value,
          backgroundColor: this.elements.backgroundColor.value
        };
        
        // JSZipライブラリを使用
        const zip = window.JSZip ? new window.JSZip() : new JSZip();
        
        for (let i = 0; i < texts.length; i++) {
          const text = texts[i];
          const progress = ((i + 1) / texts.length) * 100;
          
          progressBar.style.width = `${progress}%`;
          progressText.textContent = `${i + 1} / ${texts.length}`;
          statusText.textContent = `処理中: ${text.substring(0, 30)}...`;
          
          try {
            const dataURL = await this.generateQRCode(text, options);
            const base64Data = dataURL.replace(/^data:image\/png;base64,/, '');
            
            const fileName = this.generateBatchFileName(text, i + 1);
            zip.file(`${fileName}.png`, base64Data, { base64: true });
            
          } catch (error) {
            console.error(`QRコード生成エラー (${i + 1}):`, error);
          }
          
          // UIの更新を待つ
          await new Promise(resolve => setTimeout(resolve, 10));
        }
        
        statusText.textContent = 'ZIPファイルを生成中...';
        
        try {
          const zipBlob = await zip.generateAsync({ type: 'blob' });
          const url = URL.createObjectURL(zipBlob);
          
          const link = document.createElement('a');
          link.href = url;
          link.download = `qrcodes_batch_${new Date().getTime()}.zip`;
          link.click();
          
          URL.revokeObjectURL(url);
          statusText.textContent = 'ダウンロード完了！';
          
          this.sessionGenerated += texts.length;
          this.updateStatistics();
          
        } catch (error) {
          console.error('ZIP生成エラー:', error);
          statusText.textContent = 'エラーが発生しました';
        }
        
        setTimeout(() => {
          batchSection.classList.add('hidden');
        }, 3000);
      }

      loadBatchTemplate() {
        const templates = {
          urls: [
            'https://example.com/page1',
            'https://example.com/page2',
            'https://example.com/page3',
            'https://example.com/contact',
            'https://example.com/about'
          ],
          emails: [
            'mailto:info@example.com',
            'mailto:support@example.com',
            'mailto:sales@example.com'
          ],
          phones: [
            'tel:+81-90-1234-5678',
            'tel:+81-90-2345-6789',
            'tel:+81-90-3456-7890'
          ],
          mixed: [
            'https://example.com',
            'mailto:contact@example.com',
            'tel:+81-90-1234-5678',
            'WIFI:T:WPA;S:NetworkName;P:Password;;',
            'テキストメッセージの例'
          ]
        };
        
        const choice = prompt(
          '読み込むテンプレートを選択してください:\n' +
          '1: URL集\n' +
          '2: メールアドレス集\n' +
          '3: 電話番号集\n' +
          '4: 混合サンプル\n' +
          '数字を入力してください:'
        );
        
        const templateKeys = ['urls', 'emails', 'phones', 'mixed'];
        const selectedKey = templateKeys[parseInt(choice) - 1];
        
        if (selectedKey && templates[selectedKey]) {
          this.elements.batchText.value = templates[selectedKey].join('\n');
          this.updateBatchLineCount();
        }
      }

      generateBatchFileName(text, index) {
        const pattern = this.elements.batchNamingPattern.value;
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
        
        let fileName = pattern;
        fileName = fileName.replace('{index}', index.toString().padStart(3, '0'));
        fileName = fileName.replace('{content}', text.substring(0, 20).replace(/[^a-zA-Z0-9]/g, '_'));
        fileName = fileName.replace('{timestamp}', timestamp);
        
        return fileName;
      }

      updateStatistics() {
        this.sessionGenerated++;
        this.elements.sessionGenerated.textContent = this.sessionGenerated;
        
        // 総生成数の更新
        const totalGenerated = parseInt(localStorage.getItem('qr_total_generated') || '0') + 1;
        localStorage.setItem('qr_total_generated', totalGenerated.toString());
        this.elements.totalGenerated.textContent = totalGenerated;
        
        // 平均生成時間の更新
        if (this.generationTimes.length > 0) {
          const avgTime = this.generationTimes.reduce((a, b) => a + b, 0) / this.generationTimes.length;
          this.elements.avgGenerationTime.textContent = `${Math.round(avgTime)}ms`;
        }
        
        // 最終生成時刻の更新
        const now = new Date().toLocaleTimeString('ja-JP');
        this.elements.lastGeneratedTime.textContent = now;
        
        this.saveUserPreferences();
      }

      loadStatistics() {
        const totalGenerated = localStorage.getItem('qr_total_generated') || '0';
        this.elements.totalGenerated.textContent = totalGenerated;
      }
    }    // JSZip ライブラリの簡易版（フォールバック用）
    class JSZip {
      constructor() {
        this.files = {};
      }
      
      file(name, data, options = {}) {
        this.files[name] = { data, options };
      }
      
      async generateAsync(options) {
        // 本物のJSZipが利用できない場合のフォールバック
        console.warn('JSZipライブラリが利用できません。個別ダウンロードに切り替えます。');
        
        // 個別にファイルをダウンロード
        Object.keys(this.files).forEach((fileName, index) => {
          setTimeout(() => {
            const link = document.createElement('a');
            const blob = new Blob([this.files[fileName].data], { type: 'image/png' });
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
            URL.revokeObjectURL(link.href);
          }, index * 100);
        });
        
        throw new Error('ZIP生成はサポートされていません。個別ファイルをダウンロードしました。');
      }
    }

    // アプリケーション初期化
    document.addEventListener('DOMContentLoaded', () => {
      new AdvancedQRGenerator();
      console.log('✅ 高機能QRコード生成ツール初期化完了');
    });
  </script>
              img.onload = () => {
                console.log('QRコード生成成功（qrcode.js版）');
                img.className = 'max-w-full h-auto border rounded shadow-sm';
                img.alt = 'Generated QR Code';
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                resolve(img);
              };
              
              img.onerror = () => {
                console.error('QRコード画像変換失敗');
                this.generateWithGoogleCharts(text, size, options).then(resolve).catch(reject);
              };
              
              img.src = canvas.toDataURL('image/png');
            });
          } catch (error) {
            console.error('qrcode.js使用中にエラー:', error);
            this.generateWithGoogleCharts(text, size, options).then(resolve).catch(reject);
          }
        });
      }
      
      // Google Charts APIフォールバック
      static generateWithGoogleCharts(text, size, options) {
        return new Promise((resolve, reject) => {
          try {
            // テキストが長すぎる場合は制限
            if (text.length > 2000) {
              reject(new Error('テキストが長すぎます（2000文字まで）'));
              return;
            }
            
            const params = new URLSearchParams({
              chs: `${size}x${size}`,
              cht: 'qr',
              chl: encodeURIComponent(text.substring(0, 2000)),
              choe: 'UTF-8'
            });
            
            const errorCorrection = options.errorCorrection || 'M';
            params.append('chld', `${errorCorrection}|0`);
            
            const url = `https://chart.googleapis.com/chart?${params.toString()}`;
            console.log('Google Charts URL:', url);
            
            const img = document.createElement('img');
            img.crossOrigin = 'anonymous';
            
            // タイムアウト設定
            const timeoutId = setTimeout(() => {
              console.error('Google Charts API タイムアウト');
              this.generateWithSimpleQR(text, size, options).then(resolve).catch(reject);
            }, 10000);
            
            img.onload = () => {
              clearTimeout(timeoutId);
              console.log('QRコード生成成功（Google Charts版）');
              img.className = 'max-w-full h-auto border rounded shadow-sm';
              img.alt = 'Generated QR Code';
              img.style.maxWidth = '100%';
              img.style.height = 'auto';
              resolve(img);
            };
            
            img.onerror = () => {
              clearTimeout(timeoutId);
              console.warn('Google Charts API読み込み失敗、SimpleQRフォールバックを使用');
              this.generateWithSimpleQR(text, size, options).then(resolve).catch(reject);
            };
            
            img.src = url;
          } catch (error) {
            console.error('Google Charts API使用中にエラー:', error);
            this.generateWithSimpleQR(text, size, options).then(resolve).catch(reject);
          }
        });
      }
      
      // 最終フォールバック（シンプルなQRコード生成）
      static generateWithSimpleQR(text, size, options) {
        return new Promise((resolve, reject) => {
          try {
            // QR.jsライブラリを使用した簡易実装
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = size;
            canvas.height = size;
            
            // 背景色
            ctx.fillStyle = options.backgroundColor || '#ffffff';
            ctx.fillRect(0, 0, size, size);
            
            // シンプルなパターンでQRコード風の画像を生成
            const moduleSize = Math.floor(size / 25);
            const fg = options.foregroundColor || '#000000';
            ctx.fillStyle = fg;
            
            // QRコード風のパターンを描画
            for (let i = 0; i < 25; i++) {
              for (let j = 0; j < 25; j++) {
                // 疑似ランダムパターン（テキストのハッシュベース）
                const hash = this.simpleHash(text + i + j);
                if (hash % 3 === 0) {
                  ctx.fillRect(i * moduleSize, j * moduleSize, moduleSize, moduleSize);
                }
              }
            }
            
            // ファインダーパターン（角の四角）を描画
            this.drawFinderPattern(ctx, 0, 0, moduleSize * 7, fg);
            this.drawFinderPattern(ctx, size - moduleSize * 7, 0, moduleSize * 7, fg);
            this.drawFinderPattern(ctx, 0, size - moduleSize * 7, moduleSize * 7, fg);
            
            const img = document.createElement('img');
            img.onload = () => {
              console.log('QRコード生成成功（SimpleQR版）');
              img.className = 'max-w-full h-auto border rounded shadow-sm';
              img.alt = 'Generated QR Code (Pattern)';
              img.style.maxWidth = '100%';
              img.style.height = 'auto';
              resolve(img);
            };
            
            img.src = canvas.toDataURL('image/png');
          } catch (error) {
            console.error('SimpleQR生成エラー:', error);
            reject(new Error('QRコード生成に失敗しました'));
          }
        });
      }
      
      // ハッシュ関数（簡易版）
      static simpleHash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          const char = str.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash; // 32bit整数に変換
        }
        return Math.abs(hash);
      }
      
      // ファインダーパターン描画
      static drawFinderPattern(ctx, x, y, size, color) {
        ctx.fillStyle = color;
        // 外枠
        ctx.fillRect(x, y, size, size);
        // 内側を白で塗る
        ctx.fillStyle = '#ffffff';
        const margin = size / 7;        ctx.fillRect(x + margin, y + margin, size - 2 * margin, size - 2 * margin);
        // 中央の四角
        ctx.fillStyle = color;
        const centerSize = size / 7 * 3;
        const centerOffset = size / 7 * 2;
        ctx.fillRect(x + centerOffset, y + centerOffset, centerSize, centerSize);
      }
    }

    // ZIP生成の軽量実装
    class SimpleZip {
      constructor() {
        this.files = [];
      }
      
      file(filename, data) {
        this.files.push({name: filename, data: data});
      }
      
      generateAsync() {
        const zipData = {
          type: 'qr-batch',
          files: this.files.map(f => ({
            name: f.name,
            data: f.data
          })),
          generated: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(zipData, null, 2)], {type: 'application/json'});
        return Promise.resolve(blob);
      }
    }

    // FileSaver.js代替実装
    function saveAs(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ユーティリティ関数
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : {r: 0, g: 0, b: 0};
    }

    function isValidColor(color) {
      return /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(color);
    }

    // 統計管理
    class QRStats {
      constructor() {
        this.loadStats();
      }
      
      loadStats() {
        const saved = localStorage.getItem('qr-generator-stats');
        if (saved) {
          this.stats = JSON.parse(saved);
        } else {
          this.stats = {
            totalGenerated: 0,
            sessionGenerated: 0,
            lastGeneratedTime: null
          };
        }
        this.updateDisplay();
      }
      
      saveStats() {
        localStorage.setItem('qr-generator-stats', JSON.stringify(this.stats));
      }
      
      incrementGenerated() {
        this.stats.totalGenerated++;
        this.stats.sessionGenerated++;
        this.stats.lastGeneratedTime = new Date().toLocaleString('ja-JP');
        this.saveStats();
        this.updateDisplay();
      }
      
      updateDisplay() {
        document.getElementById('totalGenerated').textContent = this.stats.totalGenerated;
        document.getElementById('sessionGenerated').textContent = this.stats.sessionGenerated;
        document.getElementById('lastGeneratedTime').textContent = this.stats.lastGeneratedTime || '-';
      }
    }

    // メインアプリケーション
    class QRGeneratorApp {
      constructor() {
        this.stats = new QRStats();
        this.currentQRImage = null;
        this.initializeEventListeners();
        this.initializeColorInputs();
      }
      
      initializeEventListeners() {
        // タブ切り替え
        document.querySelectorAll('.tab-button').forEach(button => {
          button.addEventListener('click', (e) => {
            const tabName = e.target.dataset.tab;
            this.switchTab(tabName);
          });
        });
        
        // 単体生成
        document.getElementById('generateBtn').addEventListener('click', () => {
          this.generateSingle();
        });
        
        // 一括生成
        document.getElementById('batchGenerateBtn').addEventListener('click', () => {
          this.generateBatch();
        });
        
        // ダウンロード
        document.getElementById('downloadBtn').addEventListener('click', () => {
          this.downloadImage();
        });
          // カラープリセット
        document.querySelectorAll('.color-preset').forEach(preset => {
          preset.addEventListener('click', (e) => {
            const fg = e.target.dataset.fg;
            const bg = e.target.dataset.bg;
            this.applyColorPreset(fg, bg);
          });
        });
      }
      
      initializeColorInputs() {
        // カラーピッカーとテキスト入力の同期
        const foregroundColor = document.getElementById('foregroundColor');
        const foregroundColorText = document.getElementById('foregroundColorText');
        const backgroundColor = document.getElementById('backgroundColor');
        const backgroundColorText = document.getElementById('backgroundColorText');
        
        foregroundColor.addEventListener('input', (e) => {
          foregroundColorText.value = e.target.value;
        });
        
        foregroundColorText.addEventListener('input', (e) => {
          if (isValidColor(e.target.value)) {
            foregroundColor.value = e.target.value;
          }
        });
        
        backgroundColor.addEventListener('input', (e) => {
          backgroundColorText.value = e.target.value;
        });
        
        backgroundColorText.addEventListener('input', (e) => {
          if (isValidColor(e.target.value)) {
            backgroundColor.value = e.target.value;
          }
        });
      }
      
      switchTab(tabName) {
        // ボタンのアクティブ状態更新
        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        
        // コンテンツの表示切り替え
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.add('hidden');
        });
        document.getElementById(`${tabName}-tab`).classList.remove('hidden');
      }
        async generateSingle() {
        try {
          // セキュアな入力値取得と検証
          const text = CommonUtils.getFormValue('qrText', true, 2000);
          if (!text) {
            return;
          }

          // URL形式の場合は検証
          if (text.startsWith('http') && !SecurityUtils.validateUrl(text)) {
            SecurityUtils.showUserError('有効なURLを入力してください');
            return;
          }

          // 入力値をサニタイズ
          const sanitizedText = SecurityUtils.sanitizeInput(text, 2000);
          
          const size = parseInt(document.getElementById('qrSize').value) || 256;
          const errorCorrection = document.getElementById('errorCorrection').value || 'M';
          const foregroundColor = document.getElementById('foregroundColor').value || '#000000';
          const backgroundColor = document.getElementById('backgroundColor').value || '#ffffff';
          
          // 色の値を検証
          if (!this.isValidColor(foregroundColor) || !this.isValidColor(backgroundColor)) {
            SecurityUtils.showUserError('有効な色コードを入力してください');
            return;
          }
          
          const resultDiv = document.getElementById('qrResult');
          CommonUtils.showLoading('qrResult', 'QRコードを生成中...');
          
          const options = {
            size: Math.min(Math.max(size, 128), 1024), // サイズ制限
            errorCorrection,
            foregroundColor: SecurityUtils.sanitizeInput(foregroundColor),
            backgroundColor: SecurityUtils.sanitizeInput(backgroundColor)
          };
          
          const img = await SimpleQR.generate(sanitizedText, options);
          
          resultDiv.innerHTML = '';
          resultDiv.appendChild(img);
          
          // 統計更新
          this.updateStats();
          
          // ダウンロードボタン有効化
          document.getElementById('downloadBtn').disabled = false;
            SecurityUtils.showSuccessMessage('QRコードを生成しました');
          
        } catch (error) {
          SecurityUtils.showUserError('QRコード生成に失敗しました', error);
          CommonUtils.hideLoading('qrResult');
        }
      }
      
      async generateBatch() {
        try {
          // セキュアな入力値取得と検証
          const batchText = CommonUtils.getFormValue('batchText', true);
          if (!batchText) {
            return;
          }

          const lines = batchText.split('\n')
            .map(line => SecurityUtils.sanitizeInput(line.trim(), 2000))
            .filter(line => line);
          
          if (lines.length === 0) {
            SecurityUtils.showUserError('有効なテキストが見つかりません');
            return;
          }
          
          if (lines.length > 50) {
            if (!confirm('50件を超えるQRコードを生成しようとしています。続行しますか？')) {
              return;
            }
          }

          // URL形式のものは検証
          for (const line of lines) {
            if (line.startsWith('http') && !SecurityUtils.validateUrl(line)) {
              SecurityUtils.showUserError(`無効なURL: ${line.substring(0, 50)}...`);
              return;
            }
          }
          
          this.setBatchGenerateButtonLoading(true);
          this.showBatchProgress(true);
          
          const options = this.getBatchGenerationOptions();
          const zip = new SimpleZip();
          
          for (let i = 0; i < lines.length; i++) {
            const text = lines[i];
            if (!text) continue;
            
            this.updateBatchProgress(i, lines.length);
            
            try {
              // Google Charts APIを使用（一括生成時は軽量化のため）
              const qrImage = await SimpleQR.generateWithGoogleCharts(text, options.size, options);
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              
              canvas.width = options.size;
              canvas.height = options.size;
              
              await new Promise((resolve) => {
                qrImage.onload = () => {
                  ctx.drawImage(qrImage, 0, 0);
                  const dataUrl = canvas.toDataURL('image/png');
                  const filename = `qr_${i + 1}_${text.substring(0, 20).replace(/[^a-zA-Z0-9]/g, '_')}.png`;
                  zip.file(filename, dataUrl);
                  resolve();
                };
              });
              
              this.stats.incrementGenerated();
              
            } catch (error) {
              console.warn(`QRコード生成失敗 (${i + 1}行目): ${text}`, error);
            }
          }
          
          this.updateBatchProgress(lines.length, lines.length);
          
          const blob = await zip.generateAsync();
          saveAs(blob, `qr_batch_${new Date().toISOString().slice(0, 10)}.json`);
          
          alert(`${lines.length}件のQRコードを生成しました。`);
          
        } catch (error) {
          console.error('一括生成エラー:', error);
          alert('一括生成に失敗しました: ' + error.message);
        } finally {
          this.setBatchGenerateButtonLoading(false);
          this.showBatchProgress(false);
        }
      }
      
      getGenerationOptions() {
        return {
          size: parseInt(document.getElementById('qrSize').value),
          errorCorrection: document.getElementById('errorCorrection').value,
          foregroundColor: document.getElementById('foregroundColorText').value,
          backgroundColor: document.getElementById('backgroundColorText').value
        };
      }
      
      getBatchGenerationOptions() {
        return {
          size: parseInt(document.getElementById('batchSize').value),
          errorCorrection: document.getElementById('batchErrorCorrection').value,
          foregroundColor: document.getElementById('foregroundColorText').value,
          backgroundColor: document.getElementById('backgroundColorText').value
        };
      }
      
      displayQRCode(qrImage) {
        const output = document.getElementById('qrcodeOutput');
        output.innerHTML = '';
        output.appendChild(qrImage);
        output.classList.add('has-content');
        
        this.currentQRImage = qrImage;
        document.getElementById('downloadSection').classList.remove('hidden');
      }
      
      downloadImage() {
        if (!this.currentQRImage) return;
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = this.currentQRImage;
        
        canvas.width = img.naturalWidth || img.width;
        canvas.height = img.naturalHeight || img.height;
        
        ctx.drawImage(img, 0, 0);
        
        canvas.toBlob((blob) => {
          const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
          saveAs(blob, `qrcode_${timestamp}.png`);
        }, 'image/png');
      }
      
      applyColorPreset(fg, bg) {
        document.getElementById('foregroundColor').value = fg;
        document.getElementById('foregroundColorText').value = fg;
        document.getElementById('backgroundColor').value = bg;
        document.getElementById('backgroundColorText').value = bg;
        
        // プリセットのアクティブ状態更新
        document.querySelectorAll('.color-preset').forEach(preset => {
          preset.classList.remove('active');
        });
        event.target.classList.add('active');
      }
      
      setGenerateButtonLoading(loading) {
        const btn = document.getElementById('generateBtn');
        if (loading) {
          btn.disabled = true;
          btn.innerHTML = '<svg class="loading w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2v4m0 12v4m8-10h-4M6 12H2m15.364-6.364l-2.828 2.828M8.464 17.536l-2.828 2.828m11.314 0l-2.828-2.828M8.464 6.464L5.636 9.292"/></svg>生成中...';
        } else {
          btn.disabled = false;
          btn.textContent = 'QRコード生成';
        }
      }
      
      setBatchGenerateButtonLoading(loading) {
        const btn = document.getElementById('batchGenerateBtn');
        if (loading) {
          btn.disabled = true;
          btn.innerHTML = '<svg class="loading w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2v4m0 12v4m8-10h-4M6 12H2m15.364-6.364l-2.828 2.828M8.464 17.536l-2.828 2.828m11.314 0l-2.828-2.828M8.464 6.464L5.636 9.292"/></svg>生成中...';
        } else {
          btn.disabled = false;
          btn.textContent = '一括生成・ダウンロード';
        }
      }
      
      showBatchProgress(show) {
        const section = document.getElementById('batchDownloadSection');
        if (show) {
          section.classList.remove('hidden');
        } else {
          setTimeout(() => {
            section.classList.add('hidden');
          }, 2000);
        }
      }
      
      updateBatchProgress(current, total) {
        const progress = document.getElementById('batchProgress');
        const progressBar = document.getElementById('batchProgressBar');
        
        progress.textContent = `${current} / ${total}`;
        const percentage = (current / total) * 100;
        progressBar.style.width = `${percentage}%`;
      }
      
      // カラー値検証メソッド
      isValidColor(color) {
        if (!color || typeof color !== 'string') return false;
        
        // HEX形式チェック (#rrggbb または #rgb)
        const hexPattern = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
        if (hexPattern.test(color)) {
          return true;
        }
        
        // CSS色名チェック（基本的なもののみ）
        const validColorNames = [
          'black', 'white', 'red', 'green', 'blue', 'yellow', 'orange', 'purple',
          'gray', 'grey', 'pink', 'brown', 'cyan', 'magenta', 'lime', 'maroon',
          'navy', 'olive', 'teal', 'silver', 'gold'
        ];
        
        return validColorNames.includes(color.toLowerCase());
      }

      // 統計更新メソッド
      updateStats() {
        try {
          // セッション統計更新
          this.sessionGenerated = (this.sessionGenerated || 0) + 1;
          document.getElementById('sessionGenerated').textContent = this.sessionGenerated;
          
          // 総統計更新（ローカルストレージ）
          const totalGenerated = CommonUtils.localStorage.get('qr_total_generated', 0) + 1;
          CommonUtils.localStorage.set('qr_total_generated', totalGenerated);
          document.getElementById('totalGenerated').textContent = totalGenerated;
          
          // 最終生成時刻更新
          const now = new Date().toLocaleTimeString('ja-JP');
          document.getElementById('lastGeneratedTime').textContent = now;
          
        } catch (error) {
          console.error('統計更新エラー:', error);
        }
      }

      // ...existing code...
    }

    // アプリケーション初期化
    document.addEventListener('DOMContentLoaded', () => {
      new QRGeneratorApp();
      console.log('✅ QRコード生成ツール初期化完了');
    });
  </script>

  <script>
    // ガイドモーダルの表示/非表示制御
    document.addEventListener('DOMContentLoaded', function() {
      const guideBtn = document.getElementById('guide-btn');
      const guideModal = document.getElementById('guide-modal');
      const guideClose = document.getElementById('guide-close');
      const guideContent = document.getElementById('guide-modal-content');
        // 多言語ガイドデータ
      const guides = {
        ja: {
          title: '高機能QRコード生成ツールの使い方',
          sections: [
            {
              title: '基本操作',
              list: [
                'テキストまたはURLを入力欄に入力',
                'リアルタイムでQRコードが自動生成',
                'サイズ、エラー訂正レベル、マージンを調整',
                'プレビューを確認してダウンロード'
              ]
            },
            {
              title: 'デザインカスタマイズ',
              list: [
                '前景色・背景色の自由変更',
                '12種類のカラープリセット',
                'ロゴ画像のドラッグ&ドロップ挿入',
                'スタイル選択（標準・丸角）'
              ]
            },
            {
              title: '高度な機能',
              list: [
                'モジュールサイズとクワイエットゾーンの調整',
                'リアルタイムプレビューの切り替え',
                'メタデータ埋め込み機能',
                'PNG/SVG/PDF形式での出力'
              ]
            },
            {
              title: '一括生成',
              list: [
                '複数のテキスト/URLを1行ごとに入力',
                'ファイル名パターンの選択',
                'ZIPファイルで一括ダウンロード',
                '進行状況のリアルタイム表示'
              ]
            }
          ],
          tipsTitle: '活用例・便利機能',
          tips: [
            'クイックテンプレート: URL、Wi-Fi、メール、電話番号',
            'カラープリセットで瞬時にデザイン変更',
            'ロゴ挿入でブランド化されたQRコード作成',
            'コピー・共有機能でSNSに直接投稿',
            '設定の自動保存で次回訪問時も同じ設定',
            'QRコード情報パネルで詳細データを確認'
          ]
        },
        en: {
          title: 'Advanced QR Code Generator Guide',
          sections: [
            {
              title: 'Basic Operations',
              list: [
                'Enter text or URL in the input field',
                'QR code generates automatically in real-time',
                'Adjust size, error correction level, and margin',
                'Preview and download the result'
              ]
            },
            {
              title: 'Design Customization',
              list: [
                'Freely change foreground and background colors',
                '12 beautiful color presets available',
                'Drag & drop logo image insertion',
                'Style selection (standard or rounded corners)'
              ]
            },
            {
              title: 'Advanced Features',
              list: [
                'Module size and quiet zone adjustment',
                'Real-time preview toggle',
                'Metadata embedding functionality',
                'Output in PNG/SVG/PDF formats'
              ]
            },
            {
              title: 'Batch Generation',
              list: [
                'Enter multiple texts/URLs line by line',
                'File naming pattern selection',
                'Bulk download as ZIP file',
                'Real-time progress indicator'
              ]
            }
          ],
          tipsTitle: 'Use Cases & Tips',
          tips: [
            'Quick templates: URL, Wi-Fi, Email, Phone number',
            'Instant design changes with color presets',
            'Brand your QR codes with logo insertion',
            'Copy & share features for direct social media posting',
            'Automatic settings save for next visit',
            'QR info panel shows detailed data'
          ]
        }
      };
      
      function renderGuide(lang) {
        const g = guides[lang] || guides.ja;
        let html = `<h2 class='text-xl font-bold mb-4'>${g.title}</h2>`;
        
        g.sections.forEach(section => {
          html += `<h3 class='font-bold text-base mt-4 mb-2'>${section.title}</h3>`;
          html += '<ul class="list-disc ml-5 mb-3 text-gray-700 text-sm">' + 
            section.list.map(x => `<li>${x}</li>`).join('') + '</ul>';
        });
        
        html += `<h3 class='font-bold text-base mt-6 mb-2'>${g.tipsTitle}</h3>`;
        html += '<ul class="list-disc ml-5 text-gray-700 text-sm">' + 
          g.tips.map(x => `<li>${x}</li>`).join('') + '</ul>';
        
        guideContent.innerHTML = html;
      }
      
      if(guideBtn && guideModal && guideClose && guideContent) {
        guideBtn.addEventListener('click', function() {
          const lang = document.documentElement.lang || localStorage.getItem('selectedLanguage') || 'ja';
          renderGuide(lang);
          guideModal.classList.remove('hidden');
        });
        guideClose.addEventListener('click', function() {
          guideModal.classList.add('hidden');
        });
        guideModal.addEventListener('click', function(e) {
          if(e.target === guideModal) guideModal.classList.add('hidden');
        });
      }
    });
  </script>
</body>
</html>
