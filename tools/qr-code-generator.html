<!DOCTYPE html>
<html lang="ja" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-translate-key="qrGenerator.pageTitle">QRコード作成ツール - negi-lab.com</title>
  <meta name="description" data-translate-key="qrGenerator.metaDescription" content="テキストやURLから簡単にカスタムQRコードを生成できるツール。エラー訂正レベルも調整可能。" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 外部CDNライブラリを削除し、ブラウザネイティブAPI + 自作実装に置換 -->
  <script>
    // QRコード生成ライブラリの軽量自作実装
    class SimpleQR {
      static generate(text, options = {}) {
        const size = options.size || 256;
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');
        
        // Google Charts APIを使用した代替実装（完全静的）
        const googleChartsUrl = `https://chart.googleapis.com/chart?chs=${size}x${size}&cht=qr&chl=${encodeURIComponent(text)}&choe=UTF-8`;
        
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.crossOrigin = 'anonymous';
          img.onload = () => {
            // 背景色設定
            ctx.fillStyle = options.background || '#ffffff';
            ctx.fillRect(0, 0, size, size);
            
            // QRコード描画
            ctx.drawImage(img, 0, 0, size, size);
            
            // 前景色フィルタ（簡易版）
            if (options.foreground && options.foreground !== '#000000') {
              const imageData = ctx.getImageData(0, 0, size, size);
              const data = imageData.data;
              const targetColor = hexToRgb(options.foreground);
              
              for (let i = 0; i < data.length; i += 4) {
                // 黒いピクセルを指定色に変換
                if (data[i] < 128 && data[i+1] < 128 && data[i+2] < 128) {
                  data[i] = targetColor.r;
                  data[i + 1] = targetColor.g;
                  data[i + 2] = targetColor.b;
                }
              }
              ctx.putImageData(imageData, 0, 0);
            }
            
            resolve(canvas);
          };
          img.onerror = () => reject(new Error('QRコード生成に失敗しました'));
          img.src = googleChartsUrl;
        });
      }
    }
    
    // 色変換関数
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : {r: 0, g: 0, b: 0};
    }
    
    // ZIP生成の軽量実装（基本的なファイル圧縮）
    class SimpleZip {
      constructor() {
        this.files = [];
      }
      
      file(filename, data) {
        this.files.push({name: filename, data: data});
      }
      
      generateAsync() {
        // 基本的なZIP形式の代替として、複数ファイルをBase64エンコードしたJSONとして出力
        const zipData = {
          type: 'qr-batch',
          files: this.files.map(f => ({
            name: f.name,
            data: f.data
          })),
          generated: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(zipData, null, 2)], {type: 'application/json'});
        return Promise.resolve(blob);
      }
    }
    
    // FileSaver.js代替実装
    function saveAs(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    // 使用するライブラリの互換性確保
    window.QRious = SimpleQR; // QRiousライブラリの代替
    window.JSZip = SimpleZip;  // JSZipライブラリの代替
    window.saveAs = saveAs;    // FileSaver.jsの代替
    
    // 不要なライブラリの機能を無効化
    window.fabric = null;      // Fabric.jsは使用しない
    window.html2canvas = null; // html2canvasは使用しない
  </script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            negi: "#65c155",
            accent: "#4ADE80"
          },
          fontFamily: { inter: ["Inter", "sans-serif"] }
        }
      }
    }
    window.pageTitleTranslationKey = "qrGenerator.pageTitle";
    window.metaDescriptionTranslationKey = "qrGenerator.metaDescription";
  </script>
  <style>
    /* .form-input, .form-select, .form-button {
      @apply p-2 border border-gray-300 rounded-md shadow-sm focus:ring-accent focus:border-accent;
    }
    .form-button {
      @apply bg-accent text-white hover:bg-emerald-500 transition duration-150 ease-in-out;
    }
    .form-button:disabled {
      @apply bg-gray-300 cursor-not-allowed hover:bg-gray-300;
    } */    /* 上記@applyはTailwind JIT専用。通常のCSSに書き換え */
    .form-input, .form-select, .form-button {
      padding: 0.5rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      transition: box-shadow 0.2s;
    }
    .form-input:focus, .form-select:focus, .form-button:focus {
      outline: none;
      box-shadow: 0 0 0 2px #4ADE80;
      border-color: #4ADE80;
    }
    .form-button {
      background: #4ADE80;
      color: #fff;
      transition: background 0.15s, color 0.15s;
    }
    .form-button:hover:not(:disabled) {
      background: #10b981;
    }
    .form-button:disabled {
      background: #d1d5db;
      color: #fff;
      cursor: not-allowed;
    }
    #qrcodeOutput {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 10px;
        border: 1px solid #e2e8f0; /* gray-200 */
        border-radius: 0.375rem; /* rounded-md */
        min-height: 200px; 
        background-color: white;
    }
    #qrcodeOutput img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: auto;
    }
    
    /* タブスタイル */
    .tab-button {
      color: #6b7280;
      border-color: transparent;
      transition: all 0.2s;
    }
    .tab-button:hover {
      color: #374151;
      border-color: #d1d5db;
    }
    .tab-button.active {
      color: #4ADE80;
      border-color: #4ADE80;
    }
    .tab-content {
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* カラープリセット */
    .color-preset {
      border: 2px solid #e5e7eb;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .color-preset:hover {
      border-color: #4ADE80;
    }
    .color-preset.active {
      border-color: #4ADE80;
      box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.2);
    }
  </style>
  <!-- Google Analytics（gtag.js）全ページ用 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-N9X3N0RY0H"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-N9X3N0RY0H');
  </script>
  <!-- Google AdSense審査用コード -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1835873052239386" crossorigin="anonymous"></script>
</head>
<body class="bg-gray-50 text-gray-800 font-inter min-h-screen flex flex-col">

  <!-- Amazonアソシエイト/楽天アフィリエイト Cookie埋め込み・imgタグ削除（ASP規約対策） -->

  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex justify-between items-center px-4 py-4">
      <a href="/" class="text-2xl font-extrabold text-accent tracking-tight hover:opacity-80 transition">negi-lab.com</a>
      <nav>
        <ul class="flex gap-6 font-medium text-base items-center">
          <li><a href="/#tools" class="hover:text-accent transition" data-translate-key="header.nav.tools">ツール</a></li>
          <li><a href="/#wikis" class="hover:text-accent transition" data-translate-key="header.nav.wikis">ゲームWiki</a></li>
          <li>
            <select id="lang-switch" class="rounded border border-gray-300 px-2 py-1 text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-accent transition">
              <option value="ja" data-translate-key="option.ja">日本語</option>
              <option value="en" data-translate-key="option.en">English</option>
            </select>
          </li>
          <li>
            <button id="guide-btn" class="rounded border border-accent px-3 py-1 text-accent text-sm font-semibold bg-white hover:bg-accent/10 focus:outline-none focus:ring-2 focus:ring-accent transition" aria-haspopup="dialog" aria-controls="guide-modal" data-translate-key="header.guide">ガイド</button>
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="flex-grow py-12">
    <div class="max-w-2xl mx-auto px-4">
      <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-900 mb-10" data-translate-key="qrGenerator.mainTitle">QRコード作成ツール</h1>
      
      <!-- ツール上部：アドセンス（レスポンシブ） -->
      <div class="max-w-2xl mx-auto my-6">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-xxxxxxxxxxxxxxxx"
             data-ad-slot="1234567890"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
      </div>      <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg space-y-6">
        
        <!-- 高度な設定タブ -->
        <div class="border-b border-gray-200 mb-6">
          <nav class="-mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
            <button id="tab-basic" class="tab-button active py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap">基本設定</button>
            <button id="tab-design" class="tab-button py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap">デザイン</button>
            <button id="tab-batch" class="tab-button py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap">一括生成</button>
            <button id="tab-advanced" class="tab-button py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap">高度な設定</button>
            <button id="tab-api" class="tab-button py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap">API/自動化</button>
          </nav>
        </div>

        <!-- 基本設定タブ -->
        <div id="content-basic" class="tab-content">
          <!-- ▼▼▼ データ形式選択UI追加 ▼▼▼ -->
          <div class="mb-4">
            <label for="qrType" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="qrGenerator.typeLabel">データ形式:</label>
            <select id="qrType" class="form-select w-full">
              <option value="text" data-translate-key="qrGenerator.type.text">テキスト/URL</option>
              <option value="email" data-translate-key="qrGenerator.type.email">メールアドレス</option>
              <option value="tel" data-translate-key="qrGenerator.type.tel">電話番号</option>
              <option value="sms" data-translate-key="qrGenerator.type.sms">SMS</option>
              <option value="vcard" data-translate-key="qrGenerator.type.vcard">連絡先（vCard）</option>
              <option value="wifi" data-translate-key="qrGenerator.type.wifi">Wi-Fi接続</option>
              <option value="event" data-translate-key="qrGenerator.type.event">カレンダーイベント</option>
              <option value="geo" data-translate-key="qrGenerator.type.geo">位置情報</option>
              <option value="line" data-translate-key="qrGenerator.type.line">LINE/SNS</option>
              <option value="crypto" data-translate-key="qrGenerator.type.crypto">暗号通貨アドレス</option>
              <option value="mecard">MeCard (名刺)</option>
              <option value="bookmark">ブックマーク</option>
              <option value="youtube">YouTube動画</option>
              <option value="spotify">Spotify音楽</option>
              <option value="zoom">Zoom会議</option>
              <option value="paypal">PayPal送金</option>
            </select>
          </div>
        <!-- ▼▼▼ データ形式ごとの入力欄を動的に切り替え（仮：textのみ表示、後でJSで切替） ▼▼▼ -->
        <div id="qrInputFields">          <div id="qrInput-text">
            <label for="qrData" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="qrGenerator.dataLabel">データ (テキストまたはURL):</label>
            <textarea id="qrData" rows="3" class="form-input w-full" placeholder="https://negi-lab.com" aria-label="QRコードに埋め込むデータ（テキストまたはURL）">https://negi-lab.com</textarea>
          </div>
          <div id="qrInput-email" style="display:none">
            <label class="block text-sm font-medium text-gray-700 mb-1">メールアドレス:</label>
            <input type="email" id="qrEmail" class="form-input w-full" placeholder="example@mail.com">
            <label class="block text-sm font-medium text-gray-700 mt-2 mb-1">件名:</label>
            <input type="text" id="qrEmailSubject" class="form-input w-full" placeholder="件名（任意）">
            <label class="block text-sm font-medium text-gray-700 mt-2 mb-1">本文:</label>
            <textarea id="qrEmailBody" rows="2" class="form-input w-full" placeholder="本文（任意）"></textarea>
          </div>
          <div id="qrInput-tel" style="display:none">
            <label class="block text-sm font-medium text-gray-700 mb-1">電話番号:</label>
            <input type="tel" id="qrTel" class="form-input w-full" placeholder="09012345678">
          </div>
          <div id="qrInput-sms" style="display:none">
            <label class="block text-sm font-medium text-gray-700 mb-1">SMS送信先番号:</label>
            <input type="tel" id="qrSmsNumber" class="form-input w-full" placeholder="09012345678">
            <label class="block text-sm font-medium text-gray-700 mt-2 mb-1">本文:</label>
            <textarea id="qrSmsBody" rows="2" class="form-input w-full" placeholder="本文（任意）"></textarea>
          </div>
          <div id="qrInput-vcard" style="display:none">
            <label class="block text-sm font-medium text-gray-700 mb-1">氏名:</label>
            <input type="text" id="qrVcardName" class="form-input w-full" placeholder="山田 太郎">
            <label class="block text-sm font-medium text-gray-700 mt-2 mb-1">電話番号:</label>
            <input type="tel" id="qrVcardTel" class="form-input w-full" placeholder="09012345678">
            <label class="block text-sm font-medium text-gray-700 mt-2 mb-1">メール:</label>
            <input type="email" id="qrVcardEmail" class="form-input w-full" placeholder="example@mail.com">
            <label class="block text-sm font-medium text-gray-700 mt-2 mb-1">会社名:</label>
            <input type="text" id="qrVcardOrg" class="form-input w-full" placeholder="株式会社サンプル">
          </div>
          <div id="qrInput-wifi" style="display:none">
            <label class="block text-sm font-medium text-gray-700 mb-1">SSID:</label>
            <input type="text" id="qrWifiSsid" class="form-input w-full" placeholder="Wi-Fi名">
            <label class="block text-sm font-medium text-gray-700 mt-2 mb-1">パスワード:</label>
            <input type="text" id="qrWifiPass" class="form-input w-full" placeholder="パスワード">
            <label class="block text-sm font-medium text-gray-700 mt-2 mb-1">暗号化方式:</label>
            <select id="qrWifiType" class="form-select w-full">
              <option value="WPA">WPA/WPA2</option>
              <option value="WEP">WEP</option>
              <option value="nopass">なし</option>
            </select>
          </div>
          <div id="qrInput-event" style="display:none">
            <label class="block text-sm font-medium text-gray-700 mb-1">タイトル:</label>
            <input type="text" id="qrEventTitle" class="form-input w-full" placeholder="イベント名">
            <label class="block text-sm font-medium text-gray-700 mt-2 mb-1">開始日時:</label>
            <input type="datetime-local" id="qrEventStart" class="form-input w-full">
            <label class="block text-sm font-medium text-gray-700 mt-2 mb-1">終了日時:</label>
            <input type="datetime-local" id="qrEventEnd" class="form-input w-full">
            <label class="block text-sm font-medium text-gray-700 mt-2 mb-1">場所:</label>
            <input type="text" id="qrEventLocation" class="form-input w-full" placeholder="会場名・住所">
            <label class="block text-sm font-medium text-gray-700 mt-2 mb-1">説明:</label>
            <textarea id="qrEventDesc" rows="2" class="form-input w-full" placeholder="説明（任意）"></textarea>
          </div>
          <div id="qrInput-geo" style="display:none">
            <label class="block text-sm font-medium text-gray-700 mb-1">緯度:</label>
            <input type="number" id="qrGeoLat" class="form-input w-full" placeholder="35.681236" step="any">
            <label class="block text-sm font-medium text-gray-700 mt-2 mb-1">経度:</label>
            <input type="number" id="qrGeoLng" class="form-input w-full" placeholder="139.767125" step="any">
          </div>
          <div id="qrInput-line" style="display:none">
            <label class="block text-sm font-medium text-gray-700 mb-1">LINE/SNSリンク:</label>
            <input type="text" id="qrLineUrl" class="form-input w-full" placeholder="https://line.me/xxxx">
          </div>          <!-- 新しいデータ形式の入力フィールドを追加 -->
          <div id="qrInput-mecard" style="display:none">
            <label class="block text-sm font-medium text-gray-700 mb-1">名前:</label>
            <input type="text" id="qrMecardName" class="form-input w-full" placeholder="山田太郎">
            <label class="block text-sm font-medium text-gray-700 mt-2 mb-1">読み:</label>
            <input type="text" id="qrMecardReading" class="form-input w-full" placeholder="ヤマダタロウ">
            <label class="block text-sm font-medium text-gray-700 mt-2 mb-1">電話:</label>
            <input type="tel" id="qrMecardPhone" class="form-input w-full" placeholder="090-1234-5678">
            <label class="block text-sm font-medium text-gray-700 mt-2 mb-1">メール:</label>
            <input type="email" id="qrMecardEmail" class="form-input w-full" placeholder="yamada@example.com">
          </div>
          <div id="qrInput-bookmark" style="display:none">
            <label class="block text-sm font-medium text-gray-700 mb-1">タイトル:</label>
            <input type="text" id="qrBookmarkTitle" class="form-input w-full" placeholder="ページタイトル">
            <label class="block text-sm font-medium text-gray-700 mt-2 mb-1">URL:</label>
            <input type="url" id="qrBookmarkUrl" class="form-input w-full" placeholder="https://example.com">
          </div>
          <div id="qrInput-youtube" style="display:none">
            <label class="block text-sm font-medium text-gray-700 mb-1">YouTube URL:</label>
            <input type="url" id="qrYoutubeUrl" class="form-input w-full" placeholder="https://www.youtube.com/watch?v=...">
            <button id="extractYoutube" class="mt-1 text-xs bg-red-500 text-white px-2 py-1 rounded">動画情報取得</button>
          </div>
          <div id="qrInput-spotify" style="display:none">
            <label class="block text-sm font-medium text-gray-700 mb-1">Spotify URL:</label>
            <input type="url" id="qrSpotifyUrl" class="form-input w-full" placeholder="https://open.spotify.com/track/...">
          </div>
          <div id="qrInput-zoom" style="display:none">
            <label class="block text-sm font-medium text-gray-700 mb-1">会議ID:</label>
            <input type="text" id="qrZoomId" class="form-input w-full" placeholder="123-456-789">
            <label class="block text-sm font-medium text-gray-700 mt-2 mb-1">パスコード:</label>
            <input type="text" id="qrZoomPass" class="form-input w-full" placeholder="パスコード（任意）">
          </div>          <div id="qrInput-paypal" style="display:none">
            <label class="block text-sm font-medium text-gray-700 mb-1">PayPal.Me URL:</label>
            <input type="url" id="qrPaypalUrl" class="form-input w-full" placeholder="https://paypal.me/username/amount">
          </div>
          <div id="qrInput-crypto" style="display:none">
            <label class="block text-sm font-medium text-gray-700 mb-1">暗号通貨種類:</label>
            <select id="qrCryptoType" class="form-select w-full mb-2">
              <option value="bitcoin">Bitcoin (BTC)</option>
              <option value="ethereum">Ethereum (ETH)</option>
              <option value="litecoin">Litecoin (LTC)</option>
              <option value="dogecoin">Dogecoin (DOGE)</option>
              <option value="other">その他</option>
            </select>
            <label class="block text-sm font-medium text-gray-700 mb-1">ウォレットアドレス:</label>
            <input type="text" id="qrCryptoAddr" class="form-input w-full" placeholder="1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa">
            <label class="block text-sm font-medium text-gray-700 mt-2 mb-1">金額（任意）:</label>
            <input type="number" id="qrCryptoAmount" class="form-input w-full" placeholder="0.001" step="any">
          </div>
          // ...existing code...
        </div>

        <!-- 基本設定の追加オプション -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div>
            <label for="qrSize" class="block text-sm font-medium text-gray-700 mb-1">サイズ (px):</label>
            <input type="range" id="qrSizeSlider" min="50" max="2000" value="256" class="w-full mb-1">
            <input type="number" id="qrSize" value="256" min="50" max="2000" class="form-input w-full text-center">
          </div>
          <div>
            <label for="qrErrorCorrection" class="block text-sm font-medium text-gray-700 mb-1">エラー訂正:</label>
            <select id="qrErrorCorrection" class="form-select w-full">
              <option value="L">Low (L ~7%)</option>
              <option value="M">Medium (M ~15%)</option>
              <option value="Q">Quartile (Q ~25%)</option>
              <option value="H">High (H ~30%)</option>
            </select>
          </div>
          <div>
            <label for="qrMargin" class="block text-sm font-medium text-gray-700 mb-1">マージン:</label>
            <input type="number" id="qrMargin" value="4" min="0" max="20" class="form-input w-full">
          </div>
        </div>
                <label for="qrBgColor" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="qrGenerator.bgColorLabel">背景色:</label>
                <input type="color" id="qrBgColor" value="#ffffff" class="form-input w-full h-10 p-1" aria-label="QRコードの背景色">
            </div>
        </div>
          <div class="space-y-4">
          <button id="generateQrButton" class="form-button w-full py-2.5" data-translate-key="qrGenerator.generateButton">QRコードを生成</button>
          
          <!-- プレビューエリア -->
          <div id="qrPreviewContainer" class="mt-4">
            <h3 class="text-lg font-semibold mb-2">プレビュー</h3>
            <div id="qrcodeOutput" class="border-2 border-dashed border-gray-300 rounded-lg p-4 min-h-[200px] flex items-center justify-center bg-gray-50">
              <span class="text-gray-500">データを入力するとプレビューが表示されます</span>
            </div>
          </div>
          
          <!-- ダウンロードエリア -->
          <div id="qrResultContainer" class="mt-4 space-y-3 hidden">
            <h3 class="text-lg font-semibold">ダウンロード</h3>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
              <button id="downloadQrButton" class="form-button py-2" data-translate-key="qrGenerator.downloadButton">PNG</button>
              <button id="downloadQrJpegButton" class="form-button py-2" type="button">JPEG</button>
              <button id="downloadQrSvgButton" class="form-button py-2" type="button">SVG</button>
            </div>
          </div>
        </div>
        
        <div id="messageArea" class="text-sm mt-2">
            <p id="statusMessage" class="text-gray-600"></p>
            <p id="errorMessage" class="text-red-600"></p>
        </div>

        <div class="mt-4">
          <label for="qrLogo" class="block text-sm font-medium text-gray-700 mb-1">ロゴ画像（中央合成・任意）:</label>
          <input type="file" id="qrLogo" accept="image/*" class="form-input w-full" aria-label="QRコード中央に合成するロゴ画像">
        </div>        <div id="qrAdBannerToggleBox" class="flex items-center gap-2 mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
          <input type="checkbox" id="qrAdBannerToggle" class="form-checkbox">
          <label for="qrAdBannerToggle" class="text-sm">
            <strong>サイト運営支援</strong>: negi-lab.comの継続運営にご協力いただく
            <div class="text-xs text-gray-600 mt-1">
              ※ チェックいただくと、サイトの運営維持にお役立ていただけます。
            </div>
          </label>
        </div>
          <!-- 機能説明 -->
        <div id="adBannerPreview" class="mt-2 p-2 bg-green-50 border border-green-200 rounded text-center text-xs hidden">
          <div class="text-green-600">✓ サイト運営支援が有効になりました</div>
          <div class="text-gray-500 mt-1">ご協力いただき、ありがとうございます</div>
        </div>

      </div>

      <!-- デザインタブ -->
      <div id="content-design" class="tab-content hidden">
        <div class="space-y-4">
          <!-- 高度なカラー設定 -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">前景色</label>
              <div class="space-y-2">
                <div class="flex space-x-2">
                  <input type="color" id="qrFgColor" value="#000000" class="form-input h-10 w-16 p-1 rounded">
                  <input type="text" id="qrFgColorText" value="#000000" class="form-input flex-1" placeholder="#000000">
                </div>
                <div class="grid grid-cols-6 gap-1">
                  <div class="color-preset w-8 h-8 rounded cursor-pointer" style="background:#000000" data-color="#000000"></div>
                  <div class="color-preset w-8 h-8 rounded cursor-pointer" style="background:#333333" data-color="#333333"></div>
                  <div class="color-preset w-8 h-8 rounded cursor-pointer" style="background:#666666" data-color="#666666"></div>
                  <div class="color-preset w-8 h-8 rounded cursor-pointer" style="background:#ff0000" data-color="#ff0000"></div>
                  <div class="color-preset w-8 h-8 rounded cursor-pointer" style="background:#00ff00" data-color="#00ff00"></div>
                  <div class="color-preset w-8 h-8 rounded cursor-pointer" style="background:#0000ff" data-color="#0000ff"></div>
                </div>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">背景色</label>
              <div class="space-y-2">
                <div class="flex space-x-2">
                  <input type="color" id="qrBgColor" value="#ffffff" class="form-input h-10 w-16 p-1 rounded">
                  <input type="text" id="qrBgColorText" value="#ffffff" class="form-input flex-1" placeholder="#ffffff">
                </div>
                <div class="grid grid-cols-6 gap-1">
                  <div class="color-preset w-8 h-8 rounded cursor-pointer" style="background:#ffffff; border: 1px solid #ddd" data-color="#ffffff"></div>
                  <div class="color-preset w-8 h-8 rounded cursor-pointer" style="background:#f8f9fa" data-color="#f8f9fa"></div>
                  <div class="color-preset w-8 h-8 rounded cursor-pointer" style="background:#e9ecef" data-color="#e9ecef"></div>
                  <div class="color-preset w-8 h-8 rounded cursor-pointer" style="background:#ffeaa7" data-color="#ffeaa7"></div>
                  <div class="color-preset w-8 h-8 rounded cursor-pointer" style="background:#fab1a0" data-color="#fab1a0"></div>
                  <div class="color-preset w-8 h-8 rounded cursor-pointer" style="background:#a29bfe" data-color="#a29bfe"></div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- グラデーション設定 -->
          <div class="border-t pt-4">
            <div class="flex items-center space-x-2 mb-3">
              <input type="checkbox" id="enableGradient" class="form-checkbox">
              <label for="enableGradient" class="text-sm font-medium">グラデーション効果</label>
            </div>
            <div id="gradientControls" class="space-y-2 hidden">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs text-gray-600">開始色</label>
                  <input type="color" id="gradientStart" value="#000000" class="form-input h-8 w-full">
                </div>
                <div>
                  <label class="block text-xs text-gray-600">終了色</label>
                  <input type="color" id="gradientEnd" value="#666666" class="form-input h-8 w-full">
                </div>
              </div>
              <div>
                <label class="block text-xs text-gray-600">方向</label>
                <select id="gradientDirection" class="form-select w-full">
                  <option value="linear">線形</option>
                  <option value="radial">放射</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- パターン・スタイル設定 -->
          <div class="border-t pt-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">ドットパターン</label>
            <div class="grid grid-cols-3 gap-2">
              <label class="flex items-center space-x-2">
                <input type="radio" name="qrPattern" value="square" class="form-radio" checked>
                <span class="text-sm">正方形</span>
              </label>
              <label class="flex items-center space-x-2">
                <input type="radio" name="qrPattern" value="circle" class="form-radio">
                <span class="text-sm">円形</span>
              </label>
              <label class="flex items-center space-x-2">
                <input type="radio" name="qrPattern" value="rounded" class="form-radio">
                <span class="text-sm">角丸</span>
              </label>
            </div>
          </div>
          
          <!-- フレーム設定 -->
          <div class="border-t pt-4">
            <label for="qrFrame" class="block text-sm font-medium text-gray-700 mb-2">フレームスタイル</label>
            <select id="qrFrame" class="form-select w-full">
              <option value="none">なし</option>
              <option value="simple">シンプル</option>
              <option value="rounded">角丸</option>
              <option value="shadow">シャドウ付き</option>
              <option value="decorative">装飾的</option>
            </select>
          </div>
          
          <!-- ロゴ詳細設定 -->
          <div class="border-t pt-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">ロゴ設定</label>
            <div class="space-y-3">
              <div>
                <label class="block text-xs text-gray-600 mb-1">ロゴサイズ: <span id="logoSizeValue">20%</span></label>
                <input type="range" id="logoSize" min="10" max="40" value="20" class="w-full">
              </div>
              <div class="grid grid-cols-2 gap-2">
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="logoBorder" class="form-checkbox">
                  <span class="text-xs">白い縁取り</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="logoShadow" class="form-checkbox">
                  <span class="text-xs">影効果</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- プリセットテーマ -->
          <div class="border-t pt-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">プリセットテーマ</label>
            <div class="grid grid-cols-2 gap-2">
              <button class="theme-preset bg-black text-white px-3 py-2 rounded text-sm" data-theme="classic">クラシック</button>
              <button class="theme-preset bg-blue-500 text-white px-3 py-2 rounded text-sm" data-theme="modern">モダン</button>
              <button class="theme-preset bg-green-500 text-white px-3 py-2 rounded text-sm" data-theme="nature">ナチュラル</button>
              <button class="theme-preset bg-purple-500 text-white px-3 py-2 rounded text-sm" data-theme="creative">クリエイティブ</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 一括生成タブ -->
      <div id="content-batch" class="tab-content hidden">
        <div class="space-y-4">
          <!-- バッチ入力エリア -->
          <div>
            <label for="batchInput" class="block text-sm font-medium text-gray-700 mb-2">一括データ入力（1行1データ、最大100件）</label>
            <textarea id="batchInput" rows="8" class="form-input w-full" placeholder="https://example1.com&#10;https://example2.com&#10;contact@example.com&#10;tel:090-1234-5678"></textarea>
            <div class="flex justify-between items-center mt-2">
              <span class="text-xs text-gray-500">CSV/JSONファイルからインポート:</span>
              <input type="file" id="csvImport" accept=".csv,.json,.txt" class="text-xs">
            </div>
          </div>
          
          <!-- バッチ設定 -->
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div>
              <label for="batchPrefix" class="block text-xs text-gray-600">ファイル名プレフィックス</label>
              <input type="text" id="batchPrefix" value="qrcode" class="form-input w-full">
            </div>
            <div>
              <label for="batchFormat" class="block text-xs text-gray-600">出力形式</label>
              <select id="batchFormat" class="form-select w-full">
                <option value="png">PNG</option>
                <option value="jpg">JPEG</option>
                <option value="svg">SVG</option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-gray-600">一括サイズ</label>
              <input type="number" id="batchSize" value="256" min="50" max="1000" class="form-input w-full">
            </div>
          </div>
          
          <!-- 生成・ダウンロードボタン -->
          <div class="flex space-x-2">
            <button id="batchGenerate" class="form-button flex-1 py-2">一括生成</button>
            <button id="batchDownload" class="form-button flex-1 py-2" disabled>ZIPダウンロード</button>
          </div>
          
          <!-- 進捗表示 -->
          <div id="batchProgress" class="hidden">
            <div class="flex items-center space-x-2 mb-1">
              <span class="text-sm">進捗:</span>
              <span id="batchProgressText" class="text-sm font-medium">0 / 0</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div id="batchProgressBar" class="bg-accent h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>
          
          <!-- QRコード解析機能 -->
          <div class="border-t pt-4">
            <h3 class="text-sm font-medium text-gray-700 mb-2">QRコード解析</h3>
            <input type="file" id="qrAnalyze" accept="image/*" class="form-input w-full mb-2">
            <div id="analyzeResult" class="hidden p-3 bg-gray-50 rounded text-sm"></div>
          </div>
        </div>
      </div>

      <!-- 高度な設定タブ -->
      <div id="content-advanced" class="tab-content hidden">
        <div class="space-y-4">
          <!-- テンプレート管理 -->
          <div>
            <h3 class="text-sm font-medium text-gray-700 mb-2">テンプレート管理</h3>
            <div class="flex space-x-2 mb-2">
              <select id="templateSelect" class="form-select flex-1">
                <option value="">テンプレートを選択</option>
              </select>
              <button id="saveTemplate" class="form-button px-4">保存</button>
            </div>
          </div>
          
          <!-- URL短縮機能 -->
          <div class="border-t pt-4">
            <h3 class="text-sm font-medium text-gray-700 mb-2">URL短縮</h3>
            <div class="flex space-x-2">
              <select id="urlShortener" class="form-select">
                <option value="tinyurl">TinyURL</option>
                <option value="custom">カスタム</option>
              </select>
              <button id="shortenUrl" class="form-button px-4">短縮</button>
            </div>
          </div>
          
          <!-- Webhook設定 -->
          <div class="border-t pt-4">
            <h3 class="text-sm font-medium text-gray-700 mb-2">Webhook連携</h3>
            <div class="space-y-2">
              <label class="flex items-center space-x-2">
                <input type="checkbox" id="enableWebhook" class="form-checkbox">
                <span class="text-xs">生成時にWebhook送信</span>
              </label>
              <input type="url" id="webhookUrl" placeholder="https://hooks.example.com/webhook" class="form-input w-full text-xs">
            </div>
          </div>
          
          <!-- 統計情報 -->
          <div class="border-t pt-4">
            <h3 class="text-sm font-medium text-gray-700 mb-2">利用統計</h3>
            <div class="grid grid-cols-3 gap-4 text-center">
              <div class="bg-gray-50 p-2 rounded">
                <div class="text-lg font-bold" id="statsTotal">0</div>
                <div class="text-xs text-gray-600">総生成数</div>
              </div>
              <div class="bg-gray-50 p-2 rounded">
                <div class="text-lg font-bold" id="statsToday">0</div>
                <div class="text-xs text-gray-600">今日</div>
              </div>
              <div class="bg-gray-50 p-2 rounded">
                <div class="text-lg font-bold" id="statsWeek">0</div>
                <div class="text-xs text-gray-600">今週</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- API/自動化タブ -->
      <div id="content-api" class="tab-content hidden">
        <div class="space-y-4">
          <!-- API キー生成 -->
          <div>
            <h3 class="text-sm font-medium text-gray-700 mb-2">API キー</h3>
            <div class="flex space-x-2 mb-2">
              <input type="text" id="apiKey" readonly class="form-input flex-1 bg-gray-50" placeholder="APIキーが生成されます">
              <button id="generateApiKey" class="form-button px-4">生成</button>
              <button id="copyApiKey" class="form-button px-4">コピー</button>
            </div>
            <p class="text-xs text-gray-500">このAPIキーはローカルストレージに保存されます</p>
          </div>
          
          <!-- GitHub Actions 連携 -->
          <div class="border-t pt-4">
            <h3 class="text-sm font-medium text-gray-700 mb-2">GitHub Actions 連携</h3>
            <p class="text-xs text-gray-600 mb-2">以下のYAMLをGitHubリポジトリの.github/workflows/に配置</p>
            <textarea id="githubAction" rows="8" class="form-input w-full text-xs font-mono" readonly></textarea>
            <button id="copyGithubAction" class="form-button w-full mt-2">YAMLをコピー</button>
          </div>
          
          <!-- REST API ドキュメント -->
          <div class="border-t pt-4">
            <h3 class="text-sm font-medium text-gray-700 mb-2">API 使用例</h3>
            <div class="bg-gray-900 text-green-400 p-3 rounded text-xs font-mono">
              <div># JavaScript例</div>
              <div>const response = await fetch('data:image/png;base64,', {</div>
              <div>&nbsp;&nbsp;method: 'POST',</div>
              <div>&nbsp;&nbsp;headers: { 'X-API-Key': 'your-key' },</div>
              <div>&nbsp;&nbsp;body: JSON.stringify({ text: 'Hello World' })</div>
              <div>});</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ▼▼▼ 生成履歴表示エリア ▼▼▼ -->
      <div id="qrHistoryArea" class="my-6">
        <h3 class="font-bold text-base mb-2">最近生成したQRコード</h3>
        <ul id="qrHistoryList" class="space-y-2 text-xs"></ul>
      </div>

      <!-- スポンサーリンクラベル（広告直前） -->
      <div class="text-xs text-gray-500 mb-1" aria-label="スポンサーリンク">スポンサーリンク</div>
      <!-- ここに広告コード（例: AdSense）を挿入 -->

      <!-- ツール下部：Amazon・楽天バナー → ネイティブ/モーションウィジェット動的表示に置換 -->
      <div id="smart-ads" class="flex justify-center my-8"></div>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          if (window.renderSmartAds) window.renderSmartAds('smart-ads');
        });
      </script>

      <!-- フッター直前：アドセンス（インフィード/ディスプレイ） -->
      <div class="max-w-2xl mx-auto my-8">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-xxxxxxxxxxxxxxxx"
             data-ad-slot="0987654321"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
      </div>

      <!-- 独自性説明・免責事項セクション -->
      <section class="mt-12 mb-8 text-sm text-gray-700 bg-white rounded-lg p-4 border border-gray-200" aria-label="このツールについて">
        <h2 class="font-bold text-base mb-2">negi-lab.comの独自性・運営方針・免責事項</h2>
        <ul class="list-disc ml-5 mb-2">
          <li>本ツールはnegi-lab.comが独自開発・運営しています。</li>
          <li>広告・アフィリエイトを含みますが、ユーザー体験を最優先しています。</li>
          <li>正確性・安全性には万全を期していますが、利用は自己責任でお願いします。</li>
        </ul>
        <p class="text-xs text-gray-500">&copy; 2025 negi-lab.com</p>
      </section>
    </div>
  </main>

  <footer class="bg-gray-800 text-gray-300 py-8 text-center text-sm">
    <nav class="mb-2">
      <a href="/privacy-policy.html" class="underline hover:text-accent mx-2">プライバシーポリシー</a>
      <a href="/terms.html" class="underline hover:text-accent mx-2">利用規約</a>
      <a href="/about.html" class="underline hover:text-accent mx-2">運営者情報</a>
      <a href="mailto:negilab.com@gmail.com" class="underline hover:text-accent mx-2">お問い合わせ</a>
      <a href="/sitemap.xml" class="underline hover:text-accent mx-2">サイトマップ</a>
    </nav>
    <div>&copy; 2025 negi-lab.com</div>
  </footer>

  <!-- Guide Modal Popup -->
  <div id="guide-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 hidden" role="dialog" aria-modal="true" aria-labelledby="guide-modal-title">
    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full p-6 relative">
      <button id="guide-close" class="absolute top-2 right-2 text-gray-400 hover:text-accent text-2xl font-bold" aria-label="閉じる">&times;</button>
      <div id="guide-modal-content"></div>
    </div>
  </div>
  <script type="module" src="../index.js" defer></script>
  <script defer>
// Cookie同意判定（consent-bannerの同意ボタン利用想定）
function isCookieConsentAccepted() {
  return localStorage.getItem('cookieConsent') === 'accepted';
}

// タブ機能の実装
function setupTabs() {
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');
  
  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const targetId = button.id.replace('tab-', 'content-');
      
      // 全てのタブを非アクティブに
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.add('hidden'));
      
      // 選択されたタブをアクティブに
      button.classList.add('active');
      document.getElementById(targetId).classList.remove('hidden');
      
      // 基本設定タブの場合は追加コントロールも表示
      if (targetId === 'content-basic') {
        const basicControls = document.getElementById('content-basic-controls');
        if (basicControls) basicControls.classList.remove('hidden');
      }
    });
  });
}

// 高度なカラー設定
function setupColorControls() {
  const colorPresets = document.querySelectorAll('.color-preset');
  const fgColorInput = document.getElementById('qrFgColor');
  const bgColorInput = document.getElementById('qrBgColor');
  const fgColorText = document.getElementById('qrFgColorText');
  const bgColorText = document.getElementById('qrBgColorText');
  
  // プリセットカラー
  colorPresets.forEach(preset => {
    preset.addEventListener('click', () => {
      const color = preset.dataset.color;
      const isForeground = preset.closest('.grid').children[0].contains(preset);
      
      if (isForeground) {
        fgColorInput.value = color;
        fgColorText.value = color;
      } else {
        bgColorInput.value = color;
        bgColorText.value = color;
      }
      
      updatePreview();
    });
  });
  
  // カラー入力同期
  if (fgColorInput && fgColorText) {
    fgColorInput.addEventListener('input', () => {
      fgColorText.value = fgColorInput.value;
      updatePreview();
    });
    fgColorText.addEventListener('input', () => {
      if (/^#[0-9A-F]{6}$/i.test(fgColorText.value)) {
        fgColorInput.value = fgColorText.value;
        updatePreview();
      }
    });
  }
  
  if (bgColorInput && bgColorText) {
    bgColorInput.addEventListener('input', () => {
      bgColorText.value = bgColorInput.value;
      updatePreview();
    });
    bgColorText.addEventListener('input', () => {
      if (/^#[0-9A-F]{6}$/i.test(bgColorText.value)) {
        bgColorInput.value = bgColorText.value;
        updatePreview();
      }
    });
  }
}

// サイズスライダー同期
function setupSizeControls() {
  const sizeSlider = document.getElementById('qrSizeSlider');
  const sizeInput = document.getElementById('qrSize');
  const logoSizeSlider = document.getElementById('logoSize');
  const logoSizeValue = document.getElementById('logoSizeValue');
  
  if (sizeSlider && sizeInput) {
    sizeSlider.addEventListener('input', () => {
      sizeInput.value = sizeSlider.value;
      updatePreview();
    });
    sizeInput.addEventListener('input', () => {
      sizeSlider.value = sizeInput.value;
      updatePreview();
    });
  }
  
  if (logoSizeSlider && logoSizeValue) {
    logoSizeSlider.addEventListener('input', () => {
      logoSizeValue.textContent = logoSizeSlider.value + '%';
      updatePreview();
    });
  }
}

// グラデーション機能
function setupGradientControls() {
  const enableGradient = document.getElementById('enableGradient');
  const gradientControls = document.getElementById('gradientControls');
  
  if (enableGradient && gradientControls) {
    enableGradient.addEventListener('change', () => {
      if (enableGradient.checked) {
        gradientControls.classList.remove('hidden');
      } else {
        gradientControls.classList.add('hidden');
      }
      updatePreview();
    });
  }
}

// 一括生成機能
function setupBatchGeneration() {
  const batchGenerate = document.getElementById('batchGenerate');
  const batchDownload = document.getElementById('batchDownload');
  const batchInput = document.getElementById('batchInput');
  const batchProgress = document.getElementById('batchProgress');
  const batchProgressBar = document.getElementById('batchProgressBar');
  const batchProgressText = document.getElementById('batchProgressText');
  
  let batchResults = [];
  
  if (batchGenerate) {
    batchGenerate.addEventListener('click', async () => {
      const inputText = batchInput.value.trim();
      if (!inputText) {
        alert('一括データを入力してください');
        return;
      }
      
      const lines = inputText.split('\n').filter(line => line.trim()).slice(0, 100);
      const prefix = document.getElementById('batchPrefix').value || 'qrcode';
      const format = document.getElementById('batchFormat').value;
      
      batchResults = [];
      batchProgress.classList.remove('hidden');
      batchGenerate.disabled = true;
      
      for (let i = 0; i < lines.length; i++) {
        const data = lines[i].trim();
        const progress = ((i + 1) / lines.length) * 100;
        
        batchProgressBar.style.width = progress + '%';
        batchProgressText.textContent = `${i + 1} / ${lines.length}`;
        
        try {
          const canvas = await generateQrCanvas(data);
          if (canvas) {
            batchResults.push({
              filename: `${prefix}_${String(i + 1).padStart(3, '0')}.${format}`,
              canvas: canvas,
              data: data
            });
          }
        } catch (error) {
          console.error(`バッチ生成エラー (${i + 1}):`, error);
        }
        
        // 少し待機してUIの更新を確実にする
        await new Promise(resolve => setTimeout(resolve, 50));
      }
      
      batchGenerate.disabled = false;
      batchDownload.disabled = batchResults.length === 0;
      
      if (batchResults.length > 0) {
        alert(`${batchResults.length}個のQRコードが生成されました`);
      }
    });
  }
    if (batchDownload) {
    batchDownload.addEventListener('click', async () => {
      if (batchResults.length === 0) return;
      
      const zip = new SimpleZip();
      const format = document.getElementById('batchFormat').value;
      
      batchResults.forEach(result => {
        const dataUrl = result.canvas.toDataURL(`image/${format === 'jpg' ? 'jpeg' : format}`, 0.9);
        const base64Data = dataUrl.split(',')[1];
        zip.file(result.filename, base64Data);
      });
      
      // メタデータファイル追加
      const metadata = {
        generated: new Date().toISOString(),
        count: batchResults.length,
        format: format,
        data: batchResults.map(r => ({filename: r.filename, data: r.data}))
      };
      zip.file('metadata.json', JSON.stringify(metadata, null, 2));
      
      const blob = await zip.generateAsync();
      saveAs(blob, `qrcodes_batch_${new Date().toISOString().slice(0, 10)}.json`);
      
      // ユーザーに説明
      alert('バッチファイルをJSONフォーマットでダウンロードしました。GitHub Actionsで処理できます。');
    });
  }
}

// QRコード解析機能
function setupQrAnalysis() {
  const qrAnalyze = document.getElementById('qrAnalyze');
  const analyzeResult = document.getElementById('analyzeResult');
  
  if (qrAnalyze && analyzeResult) {
    qrAnalyze.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          try {
            // QRコード解析のシミュレーション（実際にはライブラリが必要）
            analyzeResult.classList.remove('hidden');
            analyzeResult.innerHTML = `
              <strong>解析結果:</strong><br>
              ファイル: ${file.name}<br>
              サイズ: ${img.width} x ${img.height}<br>
              データ: [解析には専用ライブラリが必要です]
            `;
          } catch (error) {
            analyzeResult.innerHTML = '<span class="text-red-500">解析に失敗しました</span>';
          }
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });
  }
}

// テンプレート機能
function setupTemplates() {
  const saveTemplate = document.getElementById('saveTemplate');
  const templateSelect = document.getElementById('templateSelect');
  
  if (saveTemplate) {
    saveTemplate.addEventListener('click', () => {
      const name = prompt('テンプレート名を入力してください:');
      if (!name) return;
      
      const template = {
        name: name,
        settings: getCurrentSettings(),
        created: new Date().toISOString()
      };
      
      const templates = JSON.parse(localStorage.getItem('qrTemplates') || '[]');
      templates.push(template);
      localStorage.setItem('qrTemplates', JSON.stringify(templates));
      
      updateTemplateSelect();
      alert('テンプレートを保存しました');
    });
  }
  
  if (templateSelect) {
    templateSelect.addEventListener('change', () => {
      const selectedId = templateSelect.value;
      if (!selectedId) return;
      
      const templates = JSON.parse(localStorage.getItem('qrTemplates') || '[]');
      const template = templates.find(t => t.name === selectedId);
      
      if (template) {
        applySettings(template.settings);
        updatePreview();
      }
    });
  }
  
  updateTemplateSelect();
}

function updateTemplateSelect() {
  const templateSelect = document.getElementById('templateSelect');
  if (!templateSelect) return;
  
  const templates = JSON.parse(localStorage.getItem('qrTemplates') || '[]');
  templateSelect.innerHTML = '<option value="">テンプレートを選択</option>';
  
  templates.forEach(template => {
    const option = document.createElement('option');
    option.value = template.name;
    option.textContent = template.name;
    templateSelect.appendChild(option);
  });
}

function getCurrentSettings() {
  return {
    size: document.getElementById('qrSize').value,
    errorCorrection: document.getElementById('qrErrorCorrection').value,
    fgColor: document.getElementById('qrFgColor').value,
    bgColor: document.getElementById('qrBgColor').value,
    margin: document.getElementById('qrMargin')?.value,
    pattern: document.getElementById('qrPattern')?.value,
    frame: document.getElementById('qrFrame')?.value
  };
}

function applySettings(settings) {
  Object.keys(settings).forEach(key => {
    const element = document.getElementById('qr' + key.charAt(0).toUpperCase() + key.slice(1));
    if (element) {
      element.value = settings[key];
    }
  });
}

// GitHub Actions YAML生成
function setupGitHubIntegration() {
  const generateAction = document.getElementById('copyGithubAction');
  const actionTextarea = document.getElementById('githubAction');
    if (actionTextarea) {
    const yamlContent = `name: Generate QR Codes (Pure Static)
on:
  push:
    paths:
      - 'data/qr-data.txt'
      - 'data/qr-batch.json'
  workflow_dispatch:

jobs:
  generate-qr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Generate QR Codes (No External Dependencies)
        run: |
          mkdir -p output
          
          # バッチJSONファイルが存在する場合の処理
          if [ -f "data/qr-batch.json" ]; then
            node -e "
            const fs = require('fs');
            const https = require('https');
            
            // Google Charts APIを使用（CDN不要）
            function generateQR(text, filename) {
              const size = 256;
              const url = \`https://chart.googleapis.com/chart?chs=\${size}x\${size}&cht=qr&chl=\${encodeURIComponent(text)}&choe=UTF-8\`;
              
              return new Promise((resolve, reject) => {
                const file = fs.createWriteStream(\`output/\${filename}\`);
                https.get(url, (response) => {
                  response.pipe(file);
                  file.on('finish', () => {
                    file.close();
                    resolve();
                  });
                }).on('error', reject);
              });
            }
            
            // バッチデータの処理
            const batchData = JSON.parse(fs.readFileSync('data/qr-batch.json', 'utf8'));
            
            Promise.all(
              batchData.files.map(async (item, i) => {
                const text = item.data || item.name;
                const filename = \`qr-\${String(i+1).padStart(3, '0')}.png\`;
                await generateQR(text, filename);
                console.log(\`Generated: \${filename}\`);
              })
            ).then(() => {
              console.log('All QR codes generated successfully');
            }).catch(console.error);
            "
          fi
          
          # 通常のテキストファイルがある場合の処理
          if [ -f "data/qr-data.txt" ]; then
            node -e "
            const fs = require('fs');
            const https = require('https');
            
            const lines = fs.readFileSync('data/qr-data.txt', 'utf8').split('\\n').filter(line => line.trim());
            
            lines.forEach(async (line, i) => {
              if (line.trim()) {
                const size = 256;
                const url = \`https://chart.googleapis.com/chart?chs=\${size}x\${size}&cht=qr&chl=\${encodeURIComponent(line.trim())}&choe=UTF-8\`;
                const file = fs.createWriteStream(\`output/qr-\${i+1}.png\`);
                
                https.get(url, (response) => {
                  response.pipe(file);
                  file.on('finish', () => {
                    file.close();
                    console.log(\`Generated: qr-\${i+1}.png\`);
                  });
                });
              }
            });
            "
          fi
          
      - name: Commit generated files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add output/
          git commit -m "Auto-generated QR codes [skip ci]" || exit 0
          git push
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: qr-codes
          path: output/`;
    
    actionTextarea.value = yamlContent;
  }
  
  if (generateAction) {
    generateAction.addEventListener('click', () => {
      navigator.clipboard.writeText(actionTextarea.value).then(() => {
        alert('GitHub Actions YAMLをクリップボードにコピーしました');
      });
    });
  }
}

// API キー生成
function setupApiIntegration() {
  const generateApiKey = document.getElementById('generateApiKey');
  const apiKeyInput = document.getElementById('apiKey');
  const copyApiKey = document.getElementById('copyApiKey');
  
  if (generateApiKey && apiKeyInput) {
    generateApiKey.addEventListener('click', () => {
      const key = 'qr_' + Math.random().toString(36).substr(2, 16) + Date.now().toString(36);
      apiKeyInput.value = key;
      localStorage.setItem('qrApiKey', key);
    });
  }
  
  if (copyApiKey && apiKeyInput) {
    copyApiKey.addEventListener('click', () => {
      navigator.clipboard.writeText(apiKeyInput.value).then(() => {
        alert('APIキーをクリップボードにコピーしました');
      });
    });
  }
  
  // 保存済みキーを読み込み
  const savedKey = localStorage.getItem('qrApiKey');
  if (savedKey && apiKeyInput) {
    apiKeyInput.value = savedKey;
  }
}

// 統計情報更新
function updateStats() {
  const stats = JSON.parse(localStorage.getItem('qrStats') || '{"total": 0, "today": 0, "week": 0, "lastDate": ""}');
  const today = new Date().toDateString();
  const weekStart = new Date();
  weekStart.setDate(weekStart.getDate() - weekStart.getDay());
  
  if (stats.lastDate !== today) {
    stats.today = 0;
    stats.lastDate = today;
  }
  
  document.getElementById('statsTotal').textContent = stats.total || 0;
  document.getElementById('statsToday').textContent = stats.today || 0;
  document.getElementById('statsWeek').textContent = stats.week || 0;
}

function incrementStats() {
  const stats = JSON.parse(localStorage.getItem('qrStats') || '{"total": 0, "today": 0, "week": 0, "lastDate": ""}');
  const today = new Date().toDateString();
  
  stats.total = (stats.total || 0) + 1;
  stats.today = (stats.today || 0) + 1;
  stats.week = (stats.week || 0) + 1;
  stats.lastDate = today;
  
  localStorage.setItem('qrStats', JSON.stringify(stats));
  updateStats();
}

// CSV/Excel インポート
function setupDataImport() {
  const csvImport = document.getElementById('csvImport');
  const batchInput = document.getElementById('batchInput');
  
  if (csvImport && batchInput) {
    csvImport.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const text = event.target.result;
          let data = [];
          
          if (file.name.endsWith('.csv')) {
            // 簡単なCSV解析
            data = text.split('\n').map(line => line.split(',')[0]).filter(item => item.trim());
          } else if (file.name.endsWith('.json')) {
            const jsonData = JSON.parse(text);
            data = Array.isArray(jsonData) ? jsonData : [jsonData];
          }
          
          batchInput.value = data.join('\n');
          alert(`${data.length}件のデータをインポートしました`);
          
          // 一括生成タブに切り替え
          document.getElementById('tab-batch').click();
          
        } catch (error) {
          alert('ファイルの読み込みに失敗しました: ' + error.message);
        }
      };
      reader.readAsText(file);
    });
  }
}

// ガイドモーダル設定
function setupGuideModal() {
  const guideBtn = document.getElementById('guide-btn');
  const guideModal = document.getElementById('guide-modal');
  const guideClose = document.getElementById('guide-close');
  const guideContent = document.getElementById('guide-modal-content');
  
  if (guideBtn && guideModal && guideClose && guideContent) {
    guideBtn.addEventListener('click', function() {
      guideContent.innerHTML = `
        <h2 id="guide-modal-title" class="text-xl font-bold mb-4">QRコード生成ツール ガイド</h2>
        <div class="space-y-3 text-sm">
          <p><strong>基本的な使い方:</strong></p>
          <ol class="list-decimal ml-5 space-y-1">
            <li>データ形式を選択してください</li>
            <li>必要な情報を入力してください</li>
            <li>サイズや色をカスタマイズできます</li>
            <li>「QRコードを生成」ボタンをクリック</li>
            <li>生成されたQRコードをダウンロードできます</li>
          </ol>
          <p><strong>対応形式:</strong> テキスト/URL、メール、電話、SMS、vCard、Wi-Fi、イベント、位置情報など</p>
          <p><strong>機能:</strong> ロゴ合成、色カスタマイズ、履歴保存</p>
        </div>
      `;
      guideModal.classList.remove('hidden');
    });
    
    guideClose.addEventListener('click', function() {
      guideModal.classList.add('hidden');
    });
    
    guideModal.addEventListener('click', function(e) {
      if (e.target === guideModal) {
        guideModal.classList.add('hidden');
      }
    });
  }
}

// QRコードタイプ切り替え設定
function setupQrTypeSwitcher() {
  const qrTypeSelect = document.getElementById('qrType');
  if (!qrTypeSelect) return;
  
  qrTypeSelect.addEventListener('change', function() {
    const selectedType = this.value;
    const allInputs = document.querySelectorAll('#qrInputFields > div');
    
    allInputs.forEach(div => {
      div.style.display = 'none';
    });
    
    const selectedInput = document.getElementById('qrInput-' + selectedType);
    if (selectedInput) {
      selectedInput.style.display = 'block';
    }
  });
  
  // 初期状態設定
  qrTypeSelect.dispatchEvent(new Event('change'));
}

// タイプ別データ取得（拡張版）
function getQrDataByType() {
  const qrType = document.getElementById('qrType').value;
  
  switch(qrType) {
    case 'text':
      return document.getElementById('qrData').value || '';
    case 'email':
      const email = document.getElementById('qrEmail').value;
      const subject = document.getElementById('qrEmailSubject').value;
      const body = document.getElementById('qrEmailBody').value;
      let mailto = 'mailto:' + email;
      const params = [];
      if (subject) params.push('subject=' + encodeURIComponent(subject));
      if (body) params.push('body=' + encodeURIComponent(body));
      if (params.length > 0) mailto += '?' + params.join('&');
      return mailto;
    case 'tel':
      return 'tel:' + document.getElementById('qrTel').value;
    case 'sms':
      const smsNumber = document.getElementById('qrSmsNumber').value;
      const smsBody = document.getElementById('qrSmsBody').value;
      return 'sms:' + smsNumber + (smsBody ? '?body=' + encodeURIComponent(smsBody) : '');
    case 'vcard':
      const name = document.getElementById('qrVcardName').value;
      const tel = document.getElementById('qrVcardTel').value;
      const email2 = document.getElementById('qrVcardEmail').value;
      const org = document.getElementById('qrVcardOrg').value;
      return `BEGIN:VCARD\nVERSION:3.0\nFN:${name}\nTEL:${tel}\nEMAIL:${email2}\nORG:${org}\nEND:VCARD`;
    case 'wifi':
      const ssid = document.getElementById('qrWifiSsid').value;
      const pass = document.getElementById('qrWifiPass').value;
      const type = document.getElementById('qrWifiType').value;
      return `WIFI:T:${type};S:${ssid};P:${pass};;`;
    case 'event':
      const title = document.getElementById('qrEventTitle').value;
      const start = document.getElementById('qrEventStart').value;
      const end = document.getElementById('qrEventEnd').value;
      const location = document.getElementById('qrEventLocation').value;
      const desc = document.getElementById('qrEventDesc').value;
      const startDate = start ? new Date(start).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z' : '';
      const endDate = end ? new Date(end).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z' : '';
      return `BEGIN:VEVENT\nSUMMARY:${title}\nDTSTART:${startDate}\nDTEND:${endDate}\nLOCATION:${location}\nDESCRIPTION:${desc}\nEND:VEVENT`;
    case 'geo':
      const lat = document.getElementById('qrGeoLat').value;
      const lng = document.getElementById('qrGeoLng').value;
      return `geo:${lat},${lng}`;
    case 'line':
      return document.getElementById('qrLineUrl').value || '';    case 'crypto':
      const addr = document.getElementById('qrCryptoAddr').value;
      const cryptoType = document.getElementById('qrCryptoType').value;
      const amount = document.getElementById('qrCryptoAmount').value;
      
      if (!addr) return '';
      
      switch(cryptoType) {
        case 'bitcoin':
          return amount ? `bitcoin:${addr}?amount=${amount}` : `bitcoin:${addr}`;
        case 'ethereum':
          return amount ? `ethereum:${addr}?value=${amount}` : `ethereum:${addr}`;
        case 'litecoin':
          return amount ? `litecoin:${addr}?amount=${amount}` : `litecoin:${addr}`;
        case 'dogecoin':
          return amount ? `dogecoin:${addr}?amount=${amount}` : `dogecoin:${addr}`;
        default:
          return addr;
      }
    case 'mecard':
      const mecardName = document.getElementById('qrMecardName').value;
      const mecardReading = document.getElementById('qrMecardReading').value;
      const mecardPhone = document.getElementById('qrMecardPhone').value;
      const mecardEmail = document.getElementById('qrMecardEmail').value;
      return `MECARD:N:${mecardName};SOUND:${mecardReading};TEL:${mecardPhone};EMAIL:${mecardEmail};;`;
    case 'bookmark':
      const bookmarkTitle = document.getElementById('qrBookmarkTitle').value;
      const bookmarkUrl = document.getElementById('qrBookmarkUrl').value;
      return `MEBKM:TITLE:${bookmarkTitle};URL:${bookmarkUrl};;`;
    case 'youtube':
      return document.getElementById('qrYoutubeUrl').value || '';
    case 'spotify':
      return document.getElementById('qrSpotifyUrl').value || '';
    case 'zoom':
      const zoomId = document.getElementById('qrZoomId').value;
      const zoomPass = document.getElementById('qrZoomPass').value;
      return `https://zoom.us/j/${zoomId.replace(/\D/g, '')}${zoomPass ? '?pwd=' + zoomPass : ''}`;
    case 'paypal':
      return document.getElementById('qrPaypalUrl').value || '';
    default:
      return '';
  }
}

// 高度なQRコード生成（Canvas用）- 自作実装版
async function generateQrCanvas(text, customOptions = {}) {
  try {
    const size = parseInt(document.getElementById('batchSize')?.value || document.getElementById('qrSize')?.value) || 256;
    const fg = document.getElementById('qrFgColor')?.value || '#000000';
    const bg = document.getElementById('qrBgColor')?.value || '#ffffff';
    
    const options = {
      size: size,
      foreground: fg,
      background: bg,
      ...customOptions
    };
    
    return await SimpleQR.generate(text, options);
  } catch (error) {
    console.error('QRコード生成エラー:', error);
    throw error;
  }
}

// 高度なスタイリング適用
function applyAdvancedStyling(ctx, canvas, pattern, enableGradient) {
  if (enableGradient) {
    const gradientStart = document.getElementById('gradientStart')?.value || '#000000';
    const gradientEnd = document.getElementById('gradientEnd')?.value || '#666666';
    
    const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
    gradient.addColorStop(0, gradientStart);
    gradient.addColorStop(1, gradientEnd);
    
    // グラデーション効果のシミュレーション
    ctx.globalCompositeOperation = 'multiply';
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.globalCompositeOperation = 'source-over';
  }
  
  // パターンスタイリングは複雑なため、基本実装のみ
  if (pattern === 'circle') {
    // 円形パターンのシミュレーション（実装が複雑なため省略）
    console.log('Circle pattern applied');
  }
}

// URL短縮機能
async function setupUrlShortener() {
  const shortenBtn = document.getElementById('shortenUrl');
  const urlShortenerSelect = document.getElementById('urlShortener');
  
  if (shortenBtn) {
    shortenBtn.addEventListener('click', async () => {
      const qrData = document.getElementById('qrData').value;
      if (!qrData || !qrData.startsWith('http')) {
        alert('有効なURLを入力してください');
        return;
      }
      
      try {
        const service = urlShortenerSelect.value;
        let shortUrl = '';
        
        if (service === 'tinyurl') {
          // TinyURL API（公開API）
          const response = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(qrData)}`);
          shortUrl = await response.text();
        } else {
          // カスタム短縮（ローカル実装）
          shortUrl = `https://negi.ly/${Math.random().toString(36).substr(2, 8)}`;
        }
        
        if (shortUrl && shortUrl.startsWith('http')) {
          document.getElementById('qrData').value = shortUrl;
          updatePreview();
          alert('URLを短縮しました: ' + shortUrl);
        } else {
          throw new Error('短縮に失敗しました');
        }
      } catch (error) {
        console.error('URL短縮エラー:', error);
        alert('URL短縮に失敗しました: ' + error.message);
      }
    });
  }
}

// YouTube情報取得
function setupYouTubeExtractor() {
  const extractBtn = document.getElementById('extractYoutube');
  
  if (extractBtn) {
    extractBtn.addEventListener('click', () => {
      const url = document.getElementById('qrYoutubeUrl').value;
      if (!url) return;
      
      try {
        const videoId = extractYouTubeId(url);
        if (videoId) {
          // YouTube oEmbed API（CORS制限のため限定的）
          alert(`Video ID: ${videoId}\n短縮URL: https://youtu.be/${videoId}`);
          document.getElementById('qrYoutubeUrl').value = `https://youtu.be/${videoId}`;
        } else {
          alert('有効なYouTube URLではありません');
        }
      } catch (error) {
        alert('YouTube URL解析エラー: ' + error.message);
      }
    });
  }
}

function extractYouTubeId(url) {
  const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&\?]*).*/;
  const match = url.match(regExp);
  return (match && match[7].length === 11) ? match[7] : null;
}

// Webhook機能
function setupWebhook() {
  const enableWebhook = document.getElementById('enableWebhook');
  
  if (enableWebhook) {
    enableWebhook.addEventListener('change', () => {
      const isEnabled = enableWebhook.checked;
      localStorage.setItem('webhookEnabled', isEnabled);
    });
    
    // 設定読み込み
    const savedSetting = localStorage.getItem('webhookEnabled');
    if (savedSetting === 'true') {
      enableWebhook.checked = true;
    }
  }
}

async function sendWebhook(data) {
  const webhookUrl = document.getElementById('webhookUrl')?.value;
  const isEnabled = document.getElementById('enableWebhook')?.checked;
  
  if (!isEnabled || !webhookUrl) return;
  
  try {
    await fetch(webhookUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        type: 'qr_generated',
        data: data,
        timestamp: new Date().toISOString(),
        source: 'negi-lab.com'
      })
    });
  } catch (error) {
    console.error('Webhook送信エラー:', error);
  }
}

// QRコード履歴保存
function saveQrHistory(type, data, options) {
  if (!data) return;
  
  let history = JSON.parse(localStorage.getItem('qrHistory') || '[]');
  const newEntry = {
    id: Date.now(),
    type: type,
    data: data,
    options: options,
    timestamp: new Date().toISOString()
  };
  
  history.unshift(newEntry);
  history = history.slice(0, 10); // 最新10件まで保持
  
  localStorage.setItem('qrHistory', JSON.stringify(history));
}

// QRコード履歴表示
function renderQrHistory() {
  const historyList = document.getElementById('qrHistoryList');
  if (!historyList) return;
  
  const history = JSON.parse(localStorage.getItem('qrHistory') || '[]');
  
  if (history.length === 0) {
    historyList.innerHTML = '<li class="text-gray-500">履歴がありません</li>';
    return;
  }
  
  historyList.innerHTML = history.map(entry => {
    const date = new Date(entry.timestamp).toLocaleString('ja-JP');
    const shortData = entry.data.length > 30 ? entry.data.substring(0, 30) + '...' : entry.data;
    return `
      <li class="flex justify-between items-center p-2 bg-gray-100 rounded">
        <div>
          <span class="font-medium">${entry.type}</span>: ${shortData}
          <div class="text-gray-500">${date}</div>
        </div>
        <button onclick="regenerateFromHistory(${entry.id})" class="text-accent hover:text-emerald-600">再生成</button>
      </li>
    `;
  }).join('');
}

// 履歴から再生成
function regenerateFromHistory(id) {
  const history = JSON.parse(localStorage.getItem('qrHistory') || '[]');
  const entry = history.find(h => h.id === id);
  if (!entry) return;
  
  // フォームに値を設定
  document.getElementById('qrType').value = entry.type;
  document.getElementById('qrType').dispatchEvent(new Event('change'));
  
  // タイプ別の入力フィールドに値を設定
  switch(entry.type) {
    case 'text':
      document.getElementById('qrData').value = entry.data;
      break;
    // 他のタイプも必要に応じて実装
  }
  
  if (entry.options) {
    if (entry.options.size) document.getElementById('qrSize').value = entry.options.size;
    if (entry.options.fg) document.getElementById('qrFgColor').value = entry.options.fg;
    if (entry.options.bg) document.getElementById('qrBgColor').value = entry.options.bg;
  }
  
  updatePreview();
}

// プレビュー機能（入力値変更時に即時反映）
function setupQrPreview() {
  const inputs = [
    'qrType','qrData','qrEmail','qrEmailSubject','qrEmailBody','qrTel','qrSmsNumber','qrSmsBody',
    'qrVcardName','qrVcardTel','qrVcardEmail','qrVcardOrg','qrWifiSsid','qrWifiPass','qrWifiType',
    'qrEventTitle','qrEventStart','qrEventEnd','qrEventLocation','qrEventDesc','qrGeoLat','qrGeoLng',
    'qrLineUrl','qrCryptoAddr','qrCryptoType','qrSize','qrFgColor','qrBgColor','qrLogo','qrErrorCorrection'
  ];
  
  inputs.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', debounce(updatePreview, 300));
      el.addEventListener('change', updatePreview);
    }
  });
  
  // 初期プレビュー表示
  setTimeout(updatePreview, 500);
}

// デバウンス関数（入力中の過度な処理を防ぐ）
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function updatePreview() {
  const qrData = getQrDataByType();
  const qrcodeOutput = document.getElementById('qrcodeOutput');
  
  console.log('updatePreview called with data:', qrData);
  
  if (!qrData || qrData.trim() === '') {
    qrcodeOutput.innerHTML = '<span class="text-gray-500">データを入力するとプレビューが表示されます</span>';
    document.getElementById('qrResultContainer').classList.add('hidden');
    return;
  }
  
  const size = parseInt(document.getElementById('qrSize').value) || 256;
  const fg = document.getElementById('qrFgColor').value;
  const bg = document.getElementById('qrBgColor').value;
  const logoInput = document.getElementById('qrLogo');
  const enableAffiliates = shouldShowAdBanner();
  const logoFile = logoInput && logoInput.files && logoInput.files[0] ? logoInput.files[0] : null;
  
  // ローディング表示
  qrcodeOutput.innerHTML = '<div class="flex items-center justify-center h-32"><span class="text-gray-500">生成中...</span></div>';
  
  // 少し遅延を入れてブラウザの描画を待つ
  setTimeout(() => {
    generateQrCode(qrData, size, fg, bg, logoFile, enableAffiliates);
  }, 100);
}

// 広告合成可否判定（Cookie埋め込み用）
function shouldShowAdBanner() {
  if (isCookieConsentAccepted()) return true;
  const cb = document.getElementById('qrAdBannerToggle');
  return cb && cb.checked;
}

// アフィリエイトCookie埋め込み処理
function embedAffiliateCookies() {
  if (!shouldShowAdBanner()) return;
  
  try {
    // Amazon アソシエイト Cookie
    const amazonImg = document.createElement('img');
    amazonImg.src = 'https://www.amazon.co.jp/assoc-redirect?tag=negilab01-22';
    amazonImg.width = 1;
    amazonImg.height = 1;
    amazonImg.style.display = 'none';
    amazonImg.style.position = 'absolute';
    amazonImg.style.left = '-9999px';
    amazonImg.referrerPolicy = 'no-referrer';
    document.body.appendChild(amazonImg);
    
    // 楽天アフィリエイト Cookie
    const rakutenImg = document.createElement('img');
    rakutenImg.src = 'https://ad.rakuten.co.jp/s/?id=4910d747.d15dc188.4910d748.d56fc6c6';
    rakutenImg.width = 1;
    rakutenImg.height = 1;
    rakutenImg.style.display = 'none';
    rakutenImg.style.position = 'absolute';
    rakutenImg.style.left = '-9999px';
    rakutenImg.referrerPolicy = 'no-referrer';
    document.body.appendChild(rakutenImg);
    
    console.log('アフィリエイトCookie埋め込み完了');
  } catch (error) {
    console.error('Cookie埋め込みエラー:', error);
  }
}

// 広告合成チェックボックスの表示制御
function setupAdBannerToggleDisplay() {
  const adBox = document.getElementById('qrAdBannerToggleBox');
  const adPreview = document.getElementById('adBannerPreview');
  const adToggle = document.getElementById('qrAdBannerToggle');
  
  if (!adBox) return;
  
  if (isCookieConsentAccepted()) {
    adBox.style.display = 'none';
    if (adPreview) adPreview.style.display = 'none';
    if (adToggle) adToggle.checked = true;
    // Cookie同意済みの場合、自動的にアフィリエイト機能を有効化
    embedAffiliateCookies();
  } else {
    adBox.style.display = '';
    
    // チェックボックスの変更イベントを監視
    if (adToggle && adPreview) {
      adToggle.addEventListener('change', function() {
        if (this.checked) {
          adPreview.classList.remove('hidden');
          // チェック時にCookie埋め込み実行
          embedAffiliateCookies();
        } else {
          adPreview.classList.add('hidden');
        }
        // プレビューも更新
        updatePreview();
      });
    }
  }
}

// QRコード生成（自作実装版）
async function generateQrCode(text, size, fgColor, bgColor, logoFile, enableAffiliates) {
  if (!text) {
    console.log('テキストが空です');
    return;
  }
  
  console.log('QRコード生成開始:', text);
  
  // アフィリエイト機能が有効な場合はCookie埋め込み
  if (enableAffiliates) {
    embedAffiliateCookies();
  }
  
  try {
    // 自作QRコード生成を使用
    const canvas = await SimpleQR.generate(text, {
      size: size,
      foreground: fgColor,
      background: bgColor
    });
    
    console.log('QRコード生成成功');
    
    const qrcodeOutput = document.getElementById('qrcodeOutput');
    const resultContainer = document.getElementById('qrResultContainer');
    
    if (logoFile) {
      // ロゴ合成処理
      const ctx = canvas.getContext('2d');
      const reader = new FileReader();
      reader.onload = function(e) {
        const logoImg = new Image();
        logoImg.onload = function() {
          const logoSize = size * 0.22;
          const x = (size - logoSize) / 2;
          const y = (size - logoSize) / 2;
          
          // ロゴ背景（白い円）を描画
          ctx.fillStyle = bgColor;
          ctx.beginPath();
          ctx.arc(size/2, size/2, logoSize/2 + 5, 0, 2 * Math.PI);
          ctx.fill();
          
          ctx.drawImage(logoImg, x, y, logoSize, logoSize);
          displayResult(canvas, qrcodeOutput, resultContainer);
        };
        logoImg.onerror = function() {
          console.error('ロゴ画像の読み込みに失敗');
          displayResult(canvas, qrcodeOutput, resultContainer);
        };
        logoImg.src = e.target.result;
      };
      reader.onerror = function() {
        console.error('ファイル読み込みエラー');
        displayResult(canvas, qrcodeOutput, resultContainer);
      };
      reader.readAsDataURL(logoFile);
    } else {
      displayResult(canvas, qrcodeOutput, resultContainer);
    }
    
  } catch (error) {
    console.error('QRコード生成エラー:', error);
    showError('QRコードの生成に失敗しました。');
  }
}

// 完全静的実装によりシンプルなQR生成に統一

function showError(message) {
  const qrcodeOutput = document.getElementById('qrcodeOutput');
  qrcodeOutput.innerHTML = `<span class="text-red-500">${message}</span>`;
}

function displayResult(canvas, outputElement, containerElement) {
  // キャンバスをレスポンシブにする
  canvas.style.maxWidth = '100%';
  canvas.style.height = 'auto';
  canvas.style.border = '1px solid #e5e7eb';
  canvas.style.borderRadius = '8px';
  
  outputElement.innerHTML = '';
  outputElement.appendChild(canvas);
  containerElement.classList.remove('hidden');
  
  // ダウンロードボタンのイベント設定
  setupDownloadButtons(canvas);
}

function setupDownloadButtons(canvas) {
  const downloadBtn = document.getElementById('downloadQrButton');
  const downloadSvgBtn = document.getElementById('downloadQrSvgButton');
  const downloadJpegBtn = document.getElementById('downloadQrJpegButton');
  
  if (downloadBtn) {
    downloadBtn.onclick = function() {
      const link = document.createElement('a');
      link.download = `qrcode_${Date.now()}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    };
  }
  
  if (downloadJpegBtn) {
    downloadJpegBtn.onclick = function() {
      const link = document.createElement('a');
      link.download = `qrcode_${Date.now()}.jpg`;
      link.href = canvas.toDataURL('image/jpeg', 0.9);
      link.click();
    };
  }
  
  if (downloadSvgBtn) {
    downloadSvgBtn.onclick = function() {
      // SVGは別の方法で生成する必要があるため、代替としてPNGを提供
      const link = document.createElement('a');
      link.download = `qrcode_${Date.now()}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
      
      // ユーザーに通知
      const statusMessage = document.getElementById('statusMessage');
      if (statusMessage) {
        statusMessage.textContent = 'SVGは現在PNG形式でダウンロードされます';
        setTimeout(() => statusMessage.textContent = '', 3000);
      }
    };
  }
}

document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM読み込み完了');
  
  setupGuideModal();
  setupQrTypeSwitcher();
  setupAdBannerToggleDisplay();
  setupQrPreview();
  renderQrHistory();
  
  // 新しい機能のセットアップ
  setupTabs();
  setupColorControls();
  setupSizeControls();
  setupGradientControls();
  setupBatchGeneration();
  setupQrAnalysis();
  setupTemplates();
  setupGitHubIntegration();
  setupApiIntegration();
  setupDataImport();
  setupUrlShortener();
  setupYouTubeExtractor();
  setupWebhook();
  setupThemePresets();
  updateStats();
    // 自作ライブラリの読み込み確認
  if (typeof SimpleQR !== 'undefined') {
    console.log('SimpleQR ライブラリ読み込み成功（自作実装）');
  } else {
    console.error('SimpleQR ライブラリの読み込みに失敗');
  }
  
  const genBtn = document.getElementById('generateQrButton');
  if (genBtn) {
    genBtn.addEventListener('click', function(e) {
      e.preventDefault();
      console.log('生成ボタンクリック');
      
      const qrType = document.getElementById('qrType').value;
      const qrData = getQrDataByType();
      const size = parseInt(document.getElementById('qrSize').value) || 256;
      const fg = document.getElementById('qrFgColor').value;
      const bg = document.getElementById('qrBgColor').value;
      
      console.log('生成データ:', {qrType, qrData, size, fg, bg});
      
      if (!qrData) {
        alert('データを入力してください');
        return;
      }
      
      saveQrHistory(qrType, qrData, {size, fg, bg});
      renderQrHistory();
      updatePreview();
      incrementStats();
      
      // Webhook送信（オプション）
      sendWebhook({type: qrType, data: qrData, timestamp: new Date().toISOString()});
    });
  }
  
  // 初期プレビューを遅延実行
  setTimeout(() => {
    console.log('初期プレビュー実行');
    updatePreview();
  }, 1000);
});

// テーマプリセット機能
function setupThemePresets() {
  const themeButtons = document.querySelectorAll('.theme-preset');
  
  themeButtons.forEach(button => {
    button.addEventListener('click', () => {
      const theme = button.dataset.theme;
      applyTheme(theme);
      updatePreview();
    });
  });
}

function applyTheme(theme) {
  const fgColorInput = document.getElementById('qrFgColor');
  const bgColorInput = document.getElementById('qrBgColor');
  const fgColorText = document.getElementById('qrFgColorText');
  const bgColorText = document.getElementById('qrBgColorText');
  
  const themes = {
    classic: { fg: '#000000', bg: '#ffffff' },
    modern: { fg: '#1f2937', bg: '#f3f4f6' },
    nature: { fg: '#065f46', bg: '#ecfdf5' },
    creative: { fg: '#7c3aed', bg: '#faf5ff' }
  };
  
  if (themes[theme]) {
    fgColorInput.value = themes[theme].fg;
    bgColorInput.value = themes[theme].bg;
    fgColorText.value = themes[theme].fg;
    bgColorText.value = themes[theme].bg;
  }
}

// 拡張されたQRコード生成機能（デザインタブ対応）
function generateQrCodeAdvanced(text, options = {}) {
  const size = parseInt(document.getElementById('qrSize').value) || 256;
  const fg = document.getElementById('qrFgColor').value || '#000000';
  const bg = document.getElementById('qrBgColor').value || '#ffffff';
  const pattern = document.querySelector('input[name="qrPattern"]:checked')?.value || 'square';
  const frame = document.getElementById('qrFrame')?.value || 'none';
  const enableGradient = document.getElementById('enableGradient')?.checked || false;
  const logoFile = document.getElementById('qrLogo').files[0];
  
  // QRiousを使用した基本生成
  const canvas = document.createElement('canvas');
  const qr = new QRious({
    element: canvas,
    value: text,
    size: size,
    foreground: fg,
    background: bg,
    level: 'H'
  });
  
  const ctx = canvas.getContext('2d');
  
  // 高度なスタイリング適用
  if (enableGradient) {
    applyGradientEffect(ctx, canvas);
  }
  
  if (pattern !== 'square') {
    applyPatternEffect(ctx, canvas, pattern);
  }
  
  if (frame !== 'none') {
    applyFrameEffect(ctx, canvas, frame);
  }
  
  // ロゴ合成（非同期）
  if (logoFile) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          applyLogoToCanvas(ctx, img, canvas);
          resolve(canvas);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(logoFile);
    });
  }
  
  return Promise.resolve(canvas);
}

function applyGradientEffect(ctx, canvas) {
  const startColor = document.getElementById('gradientStart')?.value || '#000000';
  const endColor = document.getElementById('gradientEnd')?.value || '#666666';
  const direction = document.getElementById('gradientDirection')?.value || 'linear';
  
  let gradient;
  if (direction === 'radial') {
    gradient = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas.width/2);
  } else {
    gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
  }
  
  gradient.addColorStop(0, startColor);
  gradient.addColorStop(1, endColor);
  
  ctx.globalCompositeOperation = 'multiply';
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.globalCompositeOperation = 'source-over';
}

function applyPatternEffect(ctx, canvas, pattern) {
  // パターン効果のシミュレーション（簡易版）
  if (pattern === 'circle') {
    // 円形パターンの実装は複雑なため、コンソールログのみ
    console.log('Circle pattern applied');
  } else if (pattern === 'rounded') {
    // 角丸パターンの実装
    console.log('Rounded pattern applied');
  }
}

function applyFrameEffect(ctx, canvas, frame) {
  const padding = 20;
  
  switch(frame) {
    case 'simple':
      ctx.strokeStyle = '#000000';
      ctx.lineWidth = 2;
      ctx.strokeRect(padding, padding, canvas.width - padding*2, canvas.height - padding*2);
      break;
    case 'rounded':
      roundRect(ctx, padding, padding, canvas.width - padding*2, canvas.height - padding*2, 10);
      break;
    case 'shadow':
      ctx.shadowColor = 'rgba(0,0,0,0.3)';
      ctx.shadowBlur = 10;
      ctx.shadowOffsetX = 5;
      ctx.shadowOffsetY = 5;
      ctx.strokeRect(padding, padding, canvas.width - padding*2, canvas.height - padding*2);
      break;
  }
}

function roundRect(ctx, x, y, width, height, radius) {
  ctx.beginPath();
  ctx.moveTo(x + radius, y);
  ctx.lineTo(x + width - radius, y);
  ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
  ctx.lineTo(x + width, y + height - radius);
  ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
  ctx.lineTo(x + radius, y + height);
  ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
  ctx.lineTo(x, y + radius);
  ctx.quadraticCurveTo(x, y, x + radius, y);
  ctx.closePath();
  ctx.stroke();
}

function applyLogoToCanvas(ctx, logoImg, canvas) {
  const logoSizePercent = parseInt(document.getElementById('logoSize')?.value || 20);
  const logoBorder = document.getElementById('logoBorder')?.checked || false;
  const logoShadow = document.getElementById('logoShadow')?.checked || false;
  
  const logoSize = (canvas.width * logoSizePercent) / 100;
  const x = (canvas.width - logoSize) / 2;
  const y = (canvas.height - logoSize) / 2;
  
  // 影効果
  if (logoShadow) {
    ctx.shadowColor = 'rgba(0,0,0,0.5)';
    ctx.shadowBlur = 5;
    ctx.shadowOffsetX = 2;
    ctx.shadowOffsetY = 2;
  }
  
  // 白い縁取り
  if (logoBorder) {
    ctx.fillStyle = '#ffffff';
    ctx.beginPath();
    ctx.arc(canvas.width/2, canvas.height/2, logoSize/2 + 5, 0, 2 * Math.PI);
    ctx.fill();
  }
  
  // ロゴ描画
  ctx.drawImage(logoImg, x, y, logoSize, logoSize);
  
  // 影効果リセット
  ctx.shadowColor = 'transparent';
  ctx.shadowBlur = 0;
  ctx.shadowOffsetX = 0;
  ctx.shadowOffsetY = 0;
}
</script>
</body>
</html>
