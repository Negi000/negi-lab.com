<!DOCTYPE html>
<html lang="ja" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Content Security Policy -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self'; 
    script-src 'self' 'unsafe-inline' 'unsafe-eval' 
      https://cdn.tailwindcss.com 
      https://cdn.jsdelivr.net 
      https://unpkg.com; 
    style-src 'self' 'unsafe-inline' 
      https://fonts.googleapis.com 
      https://cdn.tailwindcss.com; 
    font-src 'self' 
      https://fonts.gstatic.com; 
    img-src 'self' data: blob:; 
    connect-src 'self'; 
    object-src 'none'; 
    base-uri 'self';
  " />
  
  <!-- Security Headers -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN" />
  <meta http-equiv="X-XSS-Protection" content="1; mode=block" />
  
  <title data-translate-key="qrGenerator.pageTitle">QRコード作成ツール - negi-lab.com</title>
  <meta name="description" data-translate-key="qrGenerator.metaDescription" content="テキストやURLから簡単にカスタムQRコードを生成できるツール。エラー訂正レベルも調整可能。" />
    <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" crossorigin="anonymous" />
  
  <!-- CSS Framework -->
  <script>
    // Tailwind CDNの警告を無効化（開発用）
    if (typeof window !== 'undefined') {
      window.process = { env: { NODE_ENV: 'development' } };
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- QR Code Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js" 
          onload="console.log('✅ qrcode.js読み込み完了')" 
          onerror="console.warn('⚠️ qrcode.js読み込みエラー - フォールバックを使用')"></script>
  
  <!-- QR Code Library Fallback -->
  <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js" 
          onload="if (!window.QRCode) { console.log('✅ qrcode.js フォールバック読み込み完了'); }"
          onerror="console.warn('⚠️ qrcode.js フォールバック読み込みエラー')"></script>
  
  <!-- Security and Common Utilities -->
  <script src="/js/security-utils.js"></script>
  <script src="/js/common-utils.js"></script>
  
  <!-- Tailwind Config -->  <!-- Tailwind Configuration -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            negi: "#65c155",
            accent: "#4ADE80"
          },
          fontFamily: { 
            inter: ["Inter", "sans-serif"] 
          }
        }
      }
    }
    window.pageTitleTranslationKey = "qrGenerator.pageTitle";
    window.metaDescriptionTranslationKey = "qrGenerator.metaDescription";
  </script>
  
  <!-- Custom Styles -->
  <style>
    .form-input, .form-select, .form-button {
      padding: 0.5rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      transition: box-shadow 0.2s;
    }
    
    .form-input:focus, .form-select:focus, .form-button:focus {
      outline: none;
      box-shadow: 0 0 0 2px #4ADE80;
      border-color: #4ADE80;
    }
    
    .form-button {
      background: #4ADE80;
      color: #fff;
      transition: background 0.15s, color 0.15s;
    }
    
    .form-button:hover:not(:disabled) {
      background: #10b981;
    }
    
    .form-button:disabled {
      background: #d1d5db;
      color: #9ca3af;
      cursor: not-allowed;
    }
    
    #qrcodeOutput {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      border: 2px dashed #e2e8f0;
      border-radius: 0.5rem;
      min-height: 200px;
      background-color: white;
      transition: border-color 0.2s;
    }
    
    #qrcodeOutput.has-content {
      border: 1px solid #e2e8f0;
      border-style: solid;
    }
    
    #qrcodeOutput img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: auto;
      border-radius: 0.375rem;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    
    .tab-button {
      padding: 0.5rem 1rem;
      border-bottom: 2px solid transparent;
      color: #6b7280;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .tab-button:hover {
      color: #374151;
      border-color: #d1d5db;
    }
    
    .tab-button.active {
      color: #4ADE80;
      border-color: #4ADE80;
    }
    
    .tab-content {
      animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .color-preset {
      width: 40px;
      height: 40px;
      border: 2px solid #e5e7eb;
      border-radius: 0.375rem;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    
    .color-preset:hover {
      border-color: #4ADE80;
    }
    
    .color-preset.active {
      border-color: #4ADE80;
      box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.2);
    }
    
    .loading {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-N9X3N0RY0H"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-N9X3N0RY0H');
  </script>
  
  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1835873052239386" crossorigin="anonymous"></script>
</head>

<body class="bg-gray-50 text-gray-800 font-inter min-h-screen flex flex-col">
  
  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex justify-between items-center px-4 py-4">
      <a href="/" class="text-2xl font-extrabold text-accent tracking-tight hover:opacity-80 transition">
        negi-lab.com
      </a>
      <nav>
        <ul class="flex gap-6 font-medium text-base items-center">
          <li>
            <a href="/#tools" class="hover:text-accent transition" data-translate-key="header.nav.tools">
              ツール
            </a>
          </li>
          <li>
            <a href="/#wikis" class="hover:text-accent transition" data-translate-key="header.nav.wikis">
              ゲームWiki
            </a>
          </li>
          <li>
            <select id="lang-switch" class="rounded border border-gray-300 px-2 py-1 text-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-accent transition">
              <option value="ja" data-translate-key="option.ja">日本語</option>
              <option value="en" data-translate-key="option.en">English</option>
            </select>
          </li>
          <li>
            <button id="guide-btn" 
                    class="rounded border border-accent px-3 py-1 text-accent text-sm font-semibold bg-white hover:bg-accent/10 focus:outline-none focus:ring-2 focus:ring-accent transition" 
                    aria-haspopup="dialog" 
                    aria-controls="guide-modal" 
                    data-translate-key="header.guide">
              ガイド
            </button>
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow py-12">
    <div class="max-w-4xl mx-auto px-4">
      
      <!-- Title Section -->
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-4" data-translate-key="qrGenerator.title">
          QRコード作成ツール
        </h1>
        <p class="text-lg text-gray-600" data-translate-key="qrGenerator.description">
          テキストやURLからカスタムQRコードを簡単に生成
        </p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- Input Section -->
        <div class="bg-white rounded-lg shadow-lg p-6">
          
          <!-- Tabs -->
          <div class="flex border-b border-gray-200 mb-6">
            <button class="tab-button active" 
                    data-tab="single" 
                    data-translate-key="qrGenerator.tabs.single">
              単体生成
            </button>
            <button class="tab-button" 
                    data-tab="batch" 
                    data-translate-key="qrGenerator.tabs.batch">
              一括生成
            </button>
            <button class="tab-button" 
                    data-tab="design" 
                    data-translate-key="qrGenerator.tabs.design">
              デザイン
            </button>
          </div>

          <!-- Single Generation Tab -->
          <div id="single-tab" class="tab-content">
            <div class="space-y-4">
              <div>
                <label for="qrText" 
                       class="block text-sm font-medium text-gray-700 mb-2" 
                       data-translate-key="qrGenerator.form.text">
                  テキスト/URL
                </label>
                <textarea id="qrText"
                          class="form-input w-full h-24 resize-vertical"
                          placeholder="https://example.com またはテキストを入力"
                          data-translate-key="qrGenerator.form.textPlaceholder"></textarea>
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label for="qrSize" 
                         class="block text-sm font-medium text-gray-700 mb-2" 
                         data-translate-key="qrGenerator.form.size">
                    サイズ (px)
                  </label>
                  <input type="number"
                         id="qrSize"
                         class="form-input w-full"
                         value="256"
                         min="128"
                         max="1024"
                         step="32" />
                </div>
                
                <div>
                  <label for="errorCorrection" 
                         class="block text-sm font-medium text-gray-700 mb-2" 
                         data-translate-key="qrGenerator.form.errorCorrection">
                    エラー訂正
                  </label>
                  <select id="errorCorrection" class="form-select w-full">
                    <option value="L" data-translate-key="qrGenerator.errorCorrection.low">低 (L)</option>
                    <option value="M" selected data-translate-key="qrGenerator.errorCorrection.medium">中 (M)</option>
                    <option value="Q" data-translate-key="qrGenerator.errorCorrection.quartile">高 (Q)</option>
                    <option value="H" data-translate-key="qrGenerator.errorCorrection.high">最高 (H)</option>
                  </select>
                </div>
              </div>
              
              <button id="generateBtn"
                      class="form-button w-full py-3 text-lg font-semibold"
                      data-translate-key="qrGenerator.form.generate">
                QRコード生成
              </button>
            </div>
          </div>

          <!-- Batch Generation Tab -->
          <div id="batch-tab" class="tab-content hidden">
            <div class="space-y-4">
              <div>
                <label for="batchText" 
                       class="block text-sm font-medium text-gray-700 mb-2" 
                       data-translate-key="qrGenerator.batch.label">
                  テキスト（1行ごと）
                </label>
                <textarea id="batchText"
                          class="form-input w-full h-32 resize-vertical"
                          placeholder="URL1&#10;URL2&#10;URL3..."
                          data-translate-key="qrGenerator.batch.placeholder"></textarea>
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label for="batchSize" 
                         class="block text-sm font-medium text-gray-700 mb-2" 
                         data-translate-key="qrGenerator.form.size">
                    サイズ (px)
                  </label>
                  <input type="number"
                         id="batchSize"
                         class="form-input w-full"
                         value="256"
                         min="128"
                         max="512"
                         step="32" />
                </div>
                
                <div>
                  <label for="batchErrorCorrection" 
                         class="block text-sm font-medium text-gray-700 mb-2" 
                         data-translate-key="qrGenerator.form.errorCorrection">
                    エラー訂正
                  </label>
                  <select id="batchErrorCorrection" class="form-select w-full">
                    <option value="L" data-translate-key="qrGenerator.errorCorrection.low">低 (L)</option>
                    <option value="M" selected data-translate-key="qrGenerator.errorCorrection.medium">中 (M)</option>
                    <option value="Q" data-translate-key="qrGenerator.errorCorrection.quartile">高 (Q)</option>
                    <option value="H" data-translate-key="qrGenerator.errorCorrection.high">最高 (H)</option>
                  </select>
                </div>
              </div>
              
              <button id="batchGenerateBtn"
                      class="form-button w-full py-3 text-lg font-semibold"
                      data-translate-key="qrGenerator.batch.generate">
                一括生成・ダウンロード
              </button>
            </div>
          </div>

          <!-- Design Tab -->
          <div id="design-tab" class="tab-content hidden">
            <div class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label for="foregroundColor" 
                         class="block text-sm font-medium text-gray-700 mb-2" 
                         data-translate-key="qrGenerator.design.foreground">
                    前景色
                  </label>
                  <div class="flex gap-2 items-center">
                    <input type="color"
                           id="foregroundColor"
                           class="w-12 h-10 border border-gray-300 rounded cursor-pointer"
                           value="#000000" />
                    <input type="text"
                           id="foregroundColorText"
                           class="form-input flex-1"
                           value="#000000"
                           placeholder="#000000" />
                  </div>
                </div>
                
                <div>
                  <label for="backgroundColor" 
                         class="block text-sm font-medium text-gray-700 mb-2" 
                         data-translate-key="qrGenerator.design.background">
                    背景色
                  </label>
                  <div class="flex gap-2 items-center">
                    <input type="color"
                           id="backgroundColor"
                           class="w-12 h-10 border border-gray-300 rounded cursor-pointer"
                           value="#ffffff" />
                    <input type="text"
                           id="backgroundColorText"
                           class="form-input flex-1"
                           value="#ffffff"
                           placeholder="#ffffff" />
                  </div>
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2" 
                       data-translate-key="qrGenerator.design.presets">
                  プリセット
                </label>
                <div class="flex gap-2 flex-wrap">
                  <div class="color-preset active" 
                       data-fg="#000000" 
                       data-bg="#ffffff" 
                       style="background: linear-gradient(45deg, #000000 50%, #ffffff 50%);"></div>
                  <div class="color-preset" 
                       data-fg="#ffffff" 
                       data-bg="#000000" 
                       style="background: linear-gradient(45deg, #ffffff 50%, #000000 50%);"></div>
                  <div class="color-preset" 
                       data-fg="#1f2937" 
                       data-bg="#f3f4f6" 
                       style="background: linear-gradient(45deg, #1f2937 50%, #f3f4f6 50%);"></div>
                  <div class="color-preset" 
                       data-fg="#dc2626" 
                       data-bg="#fee2e2" 
                       style="background: linear-gradient(45deg, #dc2626 50%, #fee2e2 50%);"></div>
                  <div class="color-preset" 
                       data-fg="#059669" 
                       data-bg="#d1fae5" 
                       style="background: linear-gradient(45deg, #059669 50%, #d1fae5 50%);"></div>
                  <div class="color-preset" 
                       data-fg="#2563eb" 
                       data-bg="#dbeafe" 
                       style="background: linear-gradient(45deg, #2563eb 50%, #dbeafe 50%);"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Output Section -->
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4" 
              data-translate-key="qrGenerator.output.title">
            生成結果
          </h2>
          
          <div id="qrcodeOutput">
            <div class="text-center text-gray-500">
              <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                <path d="M3 3h8v8H3V3zm2 2v4h4V5H5zm8-2h8v8h-8V3zm2 2v4h4V5h-4zM3 13h8v8H3v-8zm2 2v4h4v-4H5zm10 0h2v2h-2v-2zm0 4h2v2h-2v-2zm4-4h2v2h-2v-2zm0 4h2v2h-2v-2zm-6-6h2v2h-2v-2zm2-2h2v2h-2v-2z"/>
              </svg>
              <p data-translate-key="qrGenerator.output.placeholder">
                QRコードがここに表示されます
              </p>
            </div>
          </div>
          
          <div id="downloadSection" class="mt-4 hidden">
            <button id="downloadBtn"
                    class="form-button w-full py-2"
                    data-translate-key="qrGenerator.output.download">
              画像をダウンロード
            </button>
          </div>
          
          <div id="batchDownloadSection" class="mt-4 hidden">
            <div class="space-y-2">
              <div class="text-sm text-gray-600">
                <span id="batchProgress">0 / 0</span> 件処理中...
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="batchProgressBar" 
                     class="bg-accent h-2 rounded-full transition-all duration-300" 
                     style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Statistics Section -->
      <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4" 
            data-translate-key="qrGenerator.stats.title">
          生成統計
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="text-center">
            <div class="text-2xl font-bold text-accent" id="totalGenerated">0</div>
            <div class="text-sm text-gray-600" data-translate-key="qrGenerator.stats.total">
              総生成数
            </div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-accent" id="sessionGenerated">0</div>
            <div class="text-sm text-gray-600" data-translate-key="qrGenerator.stats.session">
              今回のセッション
            </div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-accent" id="lastGeneratedTime">-</div>
            <div class="text-sm text-gray-600" data-translate-key="qrGenerator.stats.lastTime">
              最終生成時刻
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white border-t border-gray-200 py-8">
    <div class="max-w-7xl mx-auto px-4 text-center text-gray-600">
      <p>&copy; 2024 negi-lab.com. All rights reserved.</p>
    </div>
  </footer>

  <!-- Guide Modal -->
  <div id="guide-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-gray-900" data-translate-key="guide.title">
            QRコード作成ツール ガイド
          </h2>
          <button id="close-guide" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
        
        <div class="space-y-4 text-gray-700">
          <section>
            <h3 class="font-semibold text-lg mb-2" data-translate-key="guide.basic.title">
              基本的な使い方
            </h3>
            <ul class="list-disc list-inside space-y-1 text-sm">
              <li data-translate-key="guide.basic.step1">テキストまたはURLを入力欄に入力</li>
              <li data-translate-key="guide.basic.step2">サイズとエラー訂正レベルを選択</li>
              <li data-translate-key="guide.basic.step3">「QRコード生成」ボタンをクリック</li>
              <li data-translate-key="guide.basic.step4">生成されたQRコードを右クリックで保存</li>
            </ul>
          </section>
          
          <section>
            <h3 class="font-semibold text-lg mb-2" data-translate-key="guide.features.title">
              機能説明
            </h3>
            <ul class="list-disc list-inside space-y-1 text-sm">
              <li data-translate-key="guide.features.single">単体生成: 1つのQRコードを生成</li>
              <li data-translate-key="guide.features.batch">一括生成: 複数のQRコードを一度に生成</li>
              <li data-translate-key="guide.features.design">デザイン: 色をカスタマイズ</li>
              <li data-translate-key="guide.features.download">ダウンロード: PNG形式で保存</li>
            </ul>
          </section>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // QRコード生成ライブラリ（改良版）
    class SimpleQR {
      static generate(text, options = {}) {
        console.log('SimpleQR.generate called with:', { text, options });
        
        if (!text || text.trim() === '') {
          console.error('Empty text provided');
          return Promise.reject(new Error('QRコードのテキストが空です'));
        }
        
        const size = Math.min(Math.max(options.size || 256, 128), 1024);        
        // qrcode.jsが利用可能かチェック（複数の場所を確認）
        const QRCodeLib = window.QRCode || window.qrcode || (typeof QRCode !== 'undefined' ? QRCode : null);
        if (QRCodeLib && typeof QRCodeLib.toCanvas === 'function') {
          console.log('qrcode.js使用でQRコード生成');
          return this.generateWithQRCodeJS(text, size, options, QRCodeLib);
        } else {
          console.log('qrcode.js未利用、Google Charts APIフォールバック使用');
          return this.generateWithGoogleCharts(text, size, options);
        }
      }
      
      // qrcode.jsを使用した生成
      static generateWithQRCodeJS(text, size, options, QRCodeLib = null) {
        return new Promise((resolve, reject) => {
          try {
            const qrLib = QRCodeLib || window.QRCode;
            if (!qrLib || typeof qrLib.toCanvas !== 'function') {
              throw new Error('QRCodeライブラリが利用できません');
            }
            
            const canvas = document.createElement('canvas');
            
            const qrOptions = {
              width: size,
              height: size,
              color: {
                dark: options.foregroundColor || '#000000',
                light: options.backgroundColor || '#ffffff'
              },
              errorCorrectionLevel: options.errorCorrection || 'M'
            };
            
            qrLib.toCanvas(canvas, text, qrOptions, (error) => {
              if (error) {
                console.warn('qrcode.js生成エラー、フォールバック使用:', error);                this.generateWithGoogleCharts(text, size, options).then(resolve).catch(reject);
                return;
              }
              
              const img = document.createElement('img');
              img.onload = () => {
                console.log('QRコード生成成功（qrcode.js版）');
                img.className = 'max-w-full h-auto border rounded shadow-sm';
                img.alt = 'Generated QR Code';
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                resolve(img);
              };
              
              img.onerror = () => {
                console.error('QRコード画像変換失敗');
                this.generateWithGoogleCharts(text, size, options).then(resolve).catch(reject);
              };
              
              img.src = canvas.toDataURL('image/png');
            });
          } catch (error) {
            console.error('qrcode.js使用中にエラー:', error);
            this.generateWithGoogleCharts(text, size, options).then(resolve).catch(reject);
          }
        });
      }
      
      // Google Charts APIフォールバック
      static generateWithGoogleCharts(text, size, options) {
        return new Promise((resolve, reject) => {
          try {
            // テキストが長すぎる場合は制限
            if (text.length > 2000) {
              reject(new Error('テキストが長すぎます（2000文字まで）'));
              return;
            }
            
            const params = new URLSearchParams({
              chs: `${size}x${size}`,
              cht: 'qr',
              chl: encodeURIComponent(text.substring(0, 2000)),
              choe: 'UTF-8'
            });
            
            const errorCorrection = options.errorCorrection || 'M';
            params.append('chld', `${errorCorrection}|0`);
            
            const url = `https://chart.googleapis.com/chart?${params.toString()}`;
            console.log('Google Charts URL:', url);
            
            const img = document.createElement('img');
            img.crossOrigin = 'anonymous';
            
            // タイムアウト設定
            const timeoutId = setTimeout(() => {
              console.error('Google Charts API タイムアウト');
              this.generateWithSimpleQR(text, size, options).then(resolve).catch(reject);
            }, 10000);
            
            img.onload = () => {
              clearTimeout(timeoutId);
              console.log('QRコード生成成功（Google Charts版）');
              img.className = 'max-w-full h-auto border rounded shadow-sm';
              img.alt = 'Generated QR Code';
              img.style.maxWidth = '100%';
              img.style.height = 'auto';
              resolve(img);
            };
            
            img.onerror = () => {
              clearTimeout(timeoutId);
              console.warn('Google Charts API読み込み失敗、SimpleQRフォールバックを使用');
              this.generateWithSimpleQR(text, size, options).then(resolve).catch(reject);
            };
            
            img.src = url;
          } catch (error) {
            console.error('Google Charts API使用中にエラー:', error);
            this.generateWithSimpleQR(text, size, options).then(resolve).catch(reject);
          }
        });
      }
      
      // 最終フォールバック（シンプルなQRコード生成）
      static generateWithSimpleQR(text, size, options) {
        return new Promise((resolve, reject) => {
          try {
            // QR.jsライブラリを使用した簡易実装
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = size;
            canvas.height = size;
            
            // 背景色
            ctx.fillStyle = options.backgroundColor || '#ffffff';
            ctx.fillRect(0, 0, size, size);
            
            // シンプルなパターンでQRコード風の画像を生成
            const moduleSize = Math.floor(size / 25);
            const fg = options.foregroundColor || '#000000';
            ctx.fillStyle = fg;
            
            // QRコード風のパターンを描画
            for (let i = 0; i < 25; i++) {
              for (let j = 0; j < 25; j++) {
                // 疑似ランダムパターン（テキストのハッシュベース）
                const hash = this.simpleHash(text + i + j);
                if (hash % 3 === 0) {
                  ctx.fillRect(i * moduleSize, j * moduleSize, moduleSize, moduleSize);
                }
              }
            }
            
            // ファインダーパターン（角の四角）を描画
            this.drawFinderPattern(ctx, 0, 0, moduleSize * 7, fg);
            this.drawFinderPattern(ctx, size - moduleSize * 7, 0, moduleSize * 7, fg);
            this.drawFinderPattern(ctx, 0, size - moduleSize * 7, moduleSize * 7, fg);
            
            const img = document.createElement('img');
            img.onload = () => {
              console.log('QRコード生成成功（SimpleQR版）');
              img.className = 'max-w-full h-auto border rounded shadow-sm';
              img.alt = 'Generated QR Code (Pattern)';
              img.style.maxWidth = '100%';
              img.style.height = 'auto';
              resolve(img);
            };
            
            img.src = canvas.toDataURL('image/png');
          } catch (error) {
            console.error('SimpleQR生成エラー:', error);
            reject(new Error('QRコード生成に失敗しました'));
          }
        });
      }
      
      // ハッシュ関数（簡易版）
      static simpleHash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          const char = str.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash; // 32bit整数に変換
        }
        return Math.abs(hash);
      }
      
      // ファインダーパターン描画
      static drawFinderPattern(ctx, x, y, size, color) {
        ctx.fillStyle = color;
        // 外枠
        ctx.fillRect(x, y, size, size);
        // 内側を白で塗る
        ctx.fillStyle = '#ffffff';
        const margin = size / 7;        ctx.fillRect(x + margin, y + margin, size - 2 * margin, size - 2 * margin);
        // 中央の四角
        ctx.fillStyle = color;
        const centerSize = size / 7 * 3;
        const centerOffset = size / 7 * 2;
        ctx.fillRect(x + centerOffset, y + centerOffset, centerSize, centerSize);
      }
    }

    // ZIP生成の軽量実装
    class SimpleZip {
      constructor() {
        this.files = [];
      }
      
      file(filename, data) {
        this.files.push({name: filename, data: data});
      }
      
      generateAsync() {
        const zipData = {
          type: 'qr-batch',
          files: this.files.map(f => ({
            name: f.name,
            data: f.data
          })),
          generated: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(zipData, null, 2)], {type: 'application/json'});
        return Promise.resolve(blob);
      }
    }

    // FileSaver.js代替実装
    function saveAs(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ユーティリティ関数
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : {r: 0, g: 0, b: 0};
    }

    function isValidColor(color) {
      return /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(color);
    }

    // 統計管理
    class QRStats {
      constructor() {
        this.loadStats();
      }
      
      loadStats() {
        const saved = localStorage.getItem('qr-generator-stats');
        if (saved) {
          this.stats = JSON.parse(saved);
        } else {
          this.stats = {
            totalGenerated: 0,
            sessionGenerated: 0,
            lastGeneratedTime: null
          };
        }
        this.updateDisplay();
      }
      
      saveStats() {
        localStorage.setItem('qr-generator-stats', JSON.stringify(this.stats));
      }
      
      incrementGenerated() {
        this.stats.totalGenerated++;
        this.stats.sessionGenerated++;
        this.stats.lastGeneratedTime = new Date().toLocaleString('ja-JP');
        this.saveStats();
        this.updateDisplay();
      }
      
      updateDisplay() {
        document.getElementById('totalGenerated').textContent = this.stats.totalGenerated;
        document.getElementById('sessionGenerated').textContent = this.stats.sessionGenerated;
        document.getElementById('lastGeneratedTime').textContent = this.stats.lastGeneratedTime || '-';
      }
    }

    // メインアプリケーション
    class QRGeneratorApp {
      constructor() {
        this.stats = new QRStats();
        this.currentQRImage = null;
        this.initializeEventListeners();
        this.initializeColorInputs();
      }
      
      initializeEventListeners() {
        // タブ切り替え
        document.querySelectorAll('.tab-button').forEach(button => {
          button.addEventListener('click', (e) => {
            const tabName = e.target.dataset.tab;
            this.switchTab(tabName);
          });
        });
        
        // 単体生成
        document.getElementById('generateBtn').addEventListener('click', () => {
          this.generateSingle();
        });
        
        // 一括生成
        document.getElementById('batchGenerateBtn').addEventListener('click', () => {
          this.generateBatch();
        });
        
        // ダウンロード
        document.getElementById('downloadBtn').addEventListener('click', () => {
          this.downloadImage();
        });
        
        // カラープリセット
        document.querySelectorAll('.color-preset').forEach(preset => {
          preset.addEventListener('click', (e) => {
            const fg = e.target.dataset.fg;
            const bg = e.target.dataset.bg;
            this.applyColorPreset(fg, bg);
          });
        });
        
        // ガイドモーダル
        document.getElementById('guide-btn').addEventListener('click', () => {
          document.getElementById('guide-modal').classList.remove('hidden');
        });
        
        document.getElementById('close-guide').addEventListener('click', () => {
          document.getElementById('guide-modal').classList.add('hidden');
        });
        
        document.getElementById('guide-modal').addEventListener('click', (e) => {
          if (e.target === document.getElementById('guide-modal')) {
            document.getElementById('guide-modal').classList.add('hidden');
          }
        });
      }
      
      initializeColorInputs() {
        // カラーピッカーとテキスト入力の同期
        const foregroundColor = document.getElementById('foregroundColor');
        const foregroundColorText = document.getElementById('foregroundColorText');
        const backgroundColor = document.getElementById('backgroundColor');
        const backgroundColorText = document.getElementById('backgroundColorText');
        
        foregroundColor.addEventListener('input', (e) => {
          foregroundColorText.value = e.target.value;
        });
        
        foregroundColorText.addEventListener('input', (e) => {
          if (isValidColor(e.target.value)) {
            foregroundColor.value = e.target.value;
          }
        });
        
        backgroundColor.addEventListener('input', (e) => {
          backgroundColorText.value = e.target.value;
        });
        
        backgroundColorText.addEventListener('input', (e) => {
          if (isValidColor(e.target.value)) {
            backgroundColor.value = e.target.value;
          }
        });
      }
      
      switchTab(tabName) {
        // ボタンのアクティブ状態更新
        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        
        // コンテンツの表示切り替え
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.add('hidden');
        });
        document.getElementById(`${tabName}-tab`).classList.remove('hidden');
      }
        async generateSingle() {
        try {
          // セキュアな入力値取得と検証
          const text = CommonUtils.getFormValue('qrText', true, 2000);
          if (!text) {
            return;
          }

          // URL形式の場合は検証
          if (text.startsWith('http') && !SecurityUtils.validateUrl(text)) {
            SecurityUtils.showUserError('有効なURLを入力してください');
            return;
          }

          // 入力値をサニタイズ
          const sanitizedText = SecurityUtils.sanitizeInput(text, 2000);
          
          const size = parseInt(document.getElementById('qrSize').value) || 256;
          const errorCorrection = document.getElementById('errorCorrection').value || 'M';
          const foregroundColor = document.getElementById('foregroundColor').value || '#000000';
          const backgroundColor = document.getElementById('backgroundColor').value || '#ffffff';
          
          // 色の値を検証
          if (!this.isValidColor(foregroundColor) || !this.isValidColor(backgroundColor)) {
            SecurityUtils.showUserError('有効な色コードを入力してください');
            return;
          }
          
          const resultDiv = document.getElementById('qrResult');
          CommonUtils.showLoading('qrResult', 'QRコードを生成中...');
          
          const options = {
            size: Math.min(Math.max(size, 128), 1024), // サイズ制限
            errorCorrection,
            foregroundColor: SecurityUtils.sanitizeInput(foregroundColor),
            backgroundColor: SecurityUtils.sanitizeInput(backgroundColor)
          };
          
          const img = await SimpleQR.generate(sanitizedText, options);
          
          resultDiv.innerHTML = '';
          resultDiv.appendChild(img);
          
          // 統計更新
          this.updateStats();
          
          // ダウンロードボタン有効化
          document.getElementById('downloadBtn').disabled = false;
            SecurityUtils.showSuccessMessage('QRコードを生成しました');
          
        } catch (error) {
          SecurityUtils.showUserError('QRコード生成に失敗しました', error);
          CommonUtils.hideLoading('qrResult');
        }
      }
      
      async generateBatch() {
        try {
          // セキュアな入力値取得と検証
          const batchText = CommonUtils.getFormValue('batchText', true);
          if (!batchText) {
            return;
          }

          const lines = batchText.split('\n')
            .map(line => SecurityUtils.sanitizeInput(line.trim(), 2000))
            .filter(line => line);
          
          if (lines.length === 0) {
            SecurityUtils.showUserError('有効なテキストが見つかりません');
            return;
          }
          
          if (lines.length > 50) {
            if (!confirm('50件を超えるQRコードを生成しようとしています。続行しますか？')) {
              return;
            }
          }

          // URL形式のものは検証
          for (const line of lines) {
            if (line.startsWith('http') && !SecurityUtils.validateUrl(line)) {
              SecurityUtils.showUserError(`無効なURL: ${line.substring(0, 50)}...`);
              return;
            }
          }
          
          this.setBatchGenerateButtonLoading(true);
          this.showBatchProgress(true);
          
          const options = this.getBatchGenerationOptions();
          const zip = new SimpleZip();
          
          for (let i = 0; i < lines.length; i++) {
            const text = lines[i];
            if (!text) continue;
            
            this.updateBatchProgress(i, lines.length);
            
            try {
              // Google Charts APIを使用（一括生成時は軽量化のため）
              const qrImage = await SimpleQR.generateWithGoogleCharts(text, options.size, options);
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              
              canvas.width = options.size;
              canvas.height = options.size;
              
              await new Promise((resolve) => {
                qrImage.onload = () => {
                  ctx.drawImage(qrImage, 0, 0);
                  const dataUrl = canvas.toDataURL('image/png');
                  const filename = `qr_${i + 1}_${text.substring(0, 20).replace(/[^a-zA-Z0-9]/g, '_')}.png`;
                  zip.file(filename, dataUrl);
                  resolve();
                };
              });
              
              this.stats.incrementGenerated();
              
            } catch (error) {
              console.warn(`QRコード生成失敗 (${i + 1}行目): ${text}`, error);
            }
          }
          
          this.updateBatchProgress(lines.length, lines.length);
          
          const blob = await zip.generateAsync();
          saveAs(blob, `qr_batch_${new Date().toISOString().slice(0, 10)}.json`);
          
          alert(`${lines.length}件のQRコードを生成しました。`);
          
        } catch (error) {
          console.error('一括生成エラー:', error);
          alert('一括生成に失敗しました: ' + error.message);
        } finally {
          this.setBatchGenerateButtonLoading(false);
          this.showBatchProgress(false);
        }
      }
      
      getGenerationOptions() {
        return {
          size: parseInt(document.getElementById('qrSize').value),
          errorCorrection: document.getElementById('errorCorrection').value,
          foregroundColor: document.getElementById('foregroundColorText').value,
          backgroundColor: document.getElementById('backgroundColorText').value
        };
      }
      
      getBatchGenerationOptions() {
        return {
          size: parseInt(document.getElementById('batchSize').value),
          errorCorrection: document.getElementById('batchErrorCorrection').value,
          foregroundColor: document.getElementById('foregroundColorText').value,
          backgroundColor: document.getElementById('backgroundColorText').value
        };
      }
      
      displayQRCode(qrImage) {
        const output = document.getElementById('qrcodeOutput');
        output.innerHTML = '';
        output.appendChild(qrImage);
        output.classList.add('has-content');
        
        this.currentQRImage = qrImage;
        document.getElementById('downloadSection').classList.remove('hidden');
      }
      
      downloadImage() {
        if (!this.currentQRImage) return;
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = this.currentQRImage;
        
        canvas.width = img.naturalWidth || img.width;
        canvas.height = img.naturalHeight || img.height;
        
        ctx.drawImage(img, 0, 0);
        
        canvas.toBlob((blob) => {
          const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
          saveAs(blob, `qrcode_${timestamp}.png`);
        }, 'image/png');
      }
      
      applyColorPreset(fg, bg) {
        document.getElementById('foregroundColor').value = fg;
        document.getElementById('foregroundColorText').value = fg;
        document.getElementById('backgroundColor').value = bg;
        document.getElementById('backgroundColorText').value = bg;
        
        // プリセットのアクティブ状態更新
        document.querySelectorAll('.color-preset').forEach(preset => {
          preset.classList.remove('active');
        });
        event.target.classList.add('active');
      }
      
      setGenerateButtonLoading(loading) {
        const btn = document.getElementById('generateBtn');
        if (loading) {
          btn.disabled = true;
          btn.innerHTML = '<svg class="loading w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2v4m0 12v4m8-10h-4M6 12H2m15.364-6.364l-2.828 2.828M8.464 17.536l-2.828 2.828m11.314 0l-2.828-2.828M8.464 6.464L5.636 9.292"/></svg>生成中...';
        } else {
          btn.disabled = false;
          btn.textContent = 'QRコード生成';
        }
      }
      
      setBatchGenerateButtonLoading(loading) {
        const btn = document.getElementById('batchGenerateBtn');
        if (loading) {
          btn.disabled = true;
          btn.innerHTML = '<svg class="loading w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2v4m0 12v4m8-10h-4M6 12H2m15.364-6.364l-2.828 2.828M8.464 17.536l-2.828 2.828m11.314 0l-2.828-2.828M8.464 6.464L5.636 9.292"/></svg>生成中...';
        } else {
          btn.disabled = false;
          btn.textContent = '一括生成・ダウンロード';
        }
      }
      
      showBatchProgress(show) {
        const section = document.getElementById('batchDownloadSection');
        if (show) {
          section.classList.remove('hidden');
        } else {
          setTimeout(() => {
            section.classList.add('hidden');
          }, 2000);
        }
      }
      
      updateBatchProgress(current, total) {
        const progress = document.getElementById('batchProgress');
        const progressBar = document.getElementById('batchProgressBar');
        
        progress.textContent = `${current} / ${total}`;
        const percentage = (current / total) * 100;
        progressBar.style.width = `${percentage}%`;
      }
      
      // カラー値検証メソッド
      isValidColor(color) {
        if (!color || typeof color !== 'string') return false;
        
        // HEX形式チェック (#rrggbb または #rgb)
        const hexPattern = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
        if (hexPattern.test(color)) {
          return true;
        }
        
        // CSS色名チェック（基本的なもののみ）
        const validColorNames = [
          'black', 'white', 'red', 'green', 'blue', 'yellow', 'orange', 'purple',
          'gray', 'grey', 'pink', 'brown', 'cyan', 'magenta', 'lime', 'maroon',
          'navy', 'olive', 'teal', 'silver', 'gold'
        ];
        
        return validColorNames.includes(color.toLowerCase());
      }

      // 統計更新メソッド
      updateStats() {
        try {
          // セッション統計更新
          this.sessionGenerated = (this.sessionGenerated || 0) + 1;
          document.getElementById('sessionGenerated').textContent = this.sessionGenerated;
          
          // 総統計更新（ローカルストレージ）
          const totalGenerated = CommonUtils.localStorage.get('qr_total_generated', 0) + 1;
          CommonUtils.localStorage.set('qr_total_generated', totalGenerated);
          document.getElementById('totalGenerated').textContent = totalGenerated;
          
          // 最終生成時刻更新
          const now = new Date().toLocaleTimeString('ja-JP');
          document.getElementById('lastGeneratedTime').textContent = now;
          
        } catch (error) {
          console.error('統計更新エラー:', error);
        }
      }

      // ...existing code...
    }

    // アプリケーション初期化
    document.addEventListener('DOMContentLoaded', () => {
      new QRGeneratorApp();
      console.log('✅ QRコード生成ツール初期化完了');
    });
  </script>

</body>
</html>