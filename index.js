// index.js (transpiled from index.tsx)
// SPDX-License-Identifier: Apache-2.0

window.translations = {
  ja: {
    "page.title": "negi-lab.com - 便利ツール＆ゲーム情報ポータル",
    "meta.description": "日々の作業をもっとラクに、遊びも快適に。便利なウェブツールやゲーム攻略Wikiが見つかる、negi-lab.comの公式ポータル。",
    "header.nav.tools": "ツール",
    "header.nav.wikis": "ゲームWiki",
    "option.ja": "日本語",
    "option.en": "英語",
    "hero.title_html": "毎日に<b class=\"text-accent\">“ちょうどいい”</b>便利さと<br>楽しさを。",
    "hero.subtitle_html": "negi-lab.comは、<b class=\"text-accent\">作業効率化</b>や<b class=\"text-accent\">ちょっとした手助け</b>がほしい人、<br><b class=\"text-accent\">ゲームを深く楽しみたい人</b>に向けた<br class=\"hidden md:inline\">ウェブツール＆情報サービスのポータルです。",
    "hero.cta": "ツールを使ってみる",
    "tools.sectionTitle": "便利ツール集",
    "tools.unitConverter.title": "単位変換ツール",
    "tools.unitConverter.description": "長さ・重さ・温度などの単位を日常や学習、仕事に合わせて簡単に変換。",
    "tools.unitConverter.open": "開く",
    "tools.imageConverter.title": "画像変換ツール",
    "tools.imageConverter.description": "画像をJPEG/PNG/WebP形式に変換。品質やサイズも調整可能。",
    "tools.imageConverter.open": "開く",
    "tools.qrGenerator.title": "QRコード作成",
    "tools.qrGenerator.description": "URLやテキストからQRコードを即時生成。エラー訂正レベルや色、サイズもカスタマイズ可能。",
    "tools.qrGenerator.open": "開く",
    "tools.urlShortener.title": "URL短縮ツール",
    "tools.urlShortener.description": "長いURLをワンクリックで短縮。統計ログ機能も利用可能。",
    "tools.urlShortener.open": "開く",
    "tools.adPlaceholder": "AD / サポートバナー表示枠",
    "wikis.sectionTitle": "ゲーム攻略Wiki",
    "wikis.shingetsu.title": "新月同行 Wiki",
    "wikis.shingetsu.description": "話題のスマホRPG「新月同行」の最新情報・データベース・攻略・ランキングなどを掲載。",
    "wikis.shingetsu.languageBadge": "日本語限定",
    "wikis.shingetsu.open": "Wikiを見る",
    "about.sectionTitle": "negi-lab.com について",
    "about.paragraph1": "このサイトは「誰でも気軽に使える」「ちょっと楽しい」をコンセプトに、管理人が個人で制作・運営しています。",
    "about.paragraph2_html": "ツールや情報はこれからも随時追加・改善予定。<br>「こんな機能がほしい」「使ってみた感想」など、気軽にご意見・ご要望をお寄せください。",
    "about.copyrightLine": "Copyright © 2025 negi-lab.com",
    "footer.copyrightLine": "© 2025 negi-lab.com",
    "footer.contactPrefix": "お問い合わせ:",
    // --- Unit Converter ---
    "unitConverter.error.invalidTempInput": "ケルビンは0以上の値を入力してください。",
    "unitConverter.error.generic": "変換エラーが発生しました。",
    // --- Image Converter ---
    "imageConverter.imageTooLarge": "ファイルサイズが大きすぎます。",
    "imageConverter.error.fileType": "対応していないファイル形式です。",
    "imageConverter.error.generic": "変換エラーが発生しました。",
    "imageConverter.error.invalidDimensions": "無効なサイズです。正の数を入力してください。",
    "imageConverter.noImageSelected": "変換する画像を選択してください。",
    "imageConverter.convertingMessage": "変換中...",
    "imageConverter.dropInstructions": "ここにファイルをドラッグ＆ドロップ<br>またはクリックして選択",
    // --- QR Generator ---
    "qrGenerator.error.emptyInput": "QRコード用のデータを入力してください。",
    "qrGenerator.error.generic": "QRコード生成エラーが発生しました。",
    "qrGenerator.generatingMessage": "生成中...",
    "qrGenerator.qrAlt": "生成されたQRコード",
    // --- URL Shortener ---
    "urlShortener.shorteningMessage": "短縮中...",
    "urlShortener.error.invalidUrl": "有効なURLを入力してください。",
    "urlShortener.error.apiError": "URLの短縮に失敗しました。しばらくしてから再度お試しください。",
    "urlShortener.copiedMessage": "コピーしました！",
    "urlShortener.copyButton": "コピー",
    "urlShortener.statsLinkText": "統計ページを見る",
    "urlShortener.statsNotEnabled": "このURLでは統計ログが有効になっていません。",
    "urlShortener.statsInfo": "注意: 統計はis.gdによって提供され、反映に時間がかかる場合があります。"
  },
  en: {
    "page.title": "negi-lab.com - Utility Tools & Game Info Portal",
    "meta.description": "Make your daily tasks easier and gaming more enjoyable. Find useful web tools and game strategy wikis on the official negi-lab.com portal.",
    "header.nav.tools": "Tools",
    "header.nav.wikis": "Game Wikis",
    "option.ja": "Japanese",
    "option.en": "English",
    "hero.title_html": "The <b>“just right”</b> convenience and <br>fun for your everyday.",
    "hero.subtitle_html": "negi-lab.com is a portal for web tools & information services <br>for those who want to <b>improve work efficiency</b>, need a <b>little help</b>, <br class=\"hidden md:inline\">or want to <b>enjoy games more deeply</b>.",
    "hero.cta": "Try Tools",
    "tools.sectionTitle": "Useful Tool Collection",
    "tools.unitConverter.title": "Unit Converter",
    "tools.unitConverter.description": "Easily convert units like length, weight, and temperature for daily life, study, or work.",
    "tools.unitConverter.open": "Open",
    "tools.imageConverter.title": "Image Converter",
    "tools.imageConverter.description": "Convert images to JPEG/PNG/WebP format. Adjust quality and dimensions with an easy upload interface.",
    "tools.imageConverter.open": "Open",
    "tools.qrGenerator.title": "QR Code Generator",
    "tools.qrGenerator.description": "Instantly generate QR codes from URLs or text. Customize error correction level, colors, and size.",
    "tools.qrGenerator.open": "Open",
    "tools.urlShortener.title": "URL Shortener",
    "tools.urlShortener.description": "Shorten long URLs with a single click. Get simple, shareable links with optional stats logging.",
    "tools.urlShortener.open": "Open",
    "tools.adPlaceholder": "AD / Support Banner Area",
    "wikis.sectionTitle": "Game Wikis",
    "wikis.shingetsu.title": "Shingetsu Wiki",
    "wikis.shingetsu.description": "Latest info, database, guides, and rankings for the popular mobile RPG 'Shingetsu'.",
    "wikis.shingetsu.languageBadge": "Japanese Only",
    "wikis.shingetsu.open": "View Wiki",
    "about.sectionTitle": "About negi-lab.com",
    "about.paragraph1": "This site is personally created and managed by the admin, with the concept of 'easy for anyone' and 'a little fun'.",
    "about.paragraph2_html": "Tools and info will be added and improved over time.<br>Feel free to send your feedback or requests!",
    "about.copyrightLine": "Copyright © 2025 negi-lab.com",
    "footer.copyrightLine": "© 2025 negi-lab.com",
    "footer.contactPrefix": "Contact:",
    // --- Unit Converter ---
    "unitConverter.error.invalidTempInput": "Please enter a value of 0 or higher for Kelvin.",
    "unitConverter.error.generic": "A conversion error occurred.",
    // --- Image Converter ---
    "imageConverter.imageTooLarge": "File is too large.",
    "imageConverter.error.fileType": "Unsupported file type.",
    "imageConverter.error.generic": "A conversion error occurred.",
    "imageConverter.error.invalidDimensions": "Invalid dimensions. Please enter positive numbers.",
    "imageConverter.noImageSelected": "Please select an image to convert.",
    "imageConverter.convertingMessage": "Converting...",
    "imageConverter.dropInstructions": "Drag & drop your file here<br>or click to select",
    // --- QR Generator ---
    "qrGenerator.error.emptyInput": "Please enter data for QR code.",
    "qrGenerator.error.generic": "Error generating QR code.",
    "qrGenerator.generatingMessage": "Generating...",
    "qrGenerator.qrAlt": "Generated QR Code",
    // --- URL Shortener ---
    "urlShortener.shorteningMessage": "Shortening...",
    "urlShortener.error.invalidUrl": "Please enter a valid URL.",
    "urlShortener.error.apiError": "Failed to shorten URL. Please try again later.",
    "urlShortener.copiedMessage": "Copied!",
    "urlShortener.copyButton": "Copy",
    "urlShortener.statsLinkText": "View Stats Page",
    "urlShortener.statsNotEnabled": "Statistics logging was not enabled for this URL.",
    "urlShortener.statsInfo": "Note: Statistics are provided by is.gd and may take a few moments to update."
  }
};

function applyTranslations(lang) {
  var langTranslations = window.translations[lang];
  var pageTitleKey = document.title_translation_key || window.pageTitleTranslationKey || "page.title";
  var metaDescKey = document.meta_description_translation_key || window.metaDescriptionTranslationKey || "meta.description";
  var titleElement = document.querySelector('title');
  if (titleElement && langTranslations[pageTitleKey]) {
    titleElement.textContent = langTranslations[pageTitleKey];
  } else if (titleElement && langTranslations["page.title"]) {
    titleElement.textContent = langTranslations["page.title"];
  }
  var metaDescElement = document.querySelector('meta[name="description"]');
  if (metaDescElement && langTranslations[metaDescKey]) {
    metaDescElement.setAttribute('content', langTranslations[metaDescKey]);
  } else if (metaDescElement && langTranslations["meta.description"]) {
    metaDescElement.setAttribute('content', langTranslations["meta.description"]);
  }
  document.querySelectorAll('[data-translate-key]').forEach(function(element) {
    var key = element.dataset.translateKey;
    if (key && langTranslations[key]) {
      element.textContent = langTranslations[key];
    }
  });
  document.querySelectorAll('[data-translate-html-key]').forEach(function(element) {
    var key = element.dataset.translateHtmlKey;
    if (key && langTranslations[key]) {
      element.innerHTML = langTranslations[key];
    }
  });
  document.querySelectorAll('[data-translate-placeholder-key]').forEach(function(element) {
    var key = element.dataset.translatePlaceholderKey;
    if (key && langTranslations[key]) {
      element.placeholder = langTranslations[key];
    }
  });
  document.querySelectorAll('[data-translate-title-key]').forEach(function(element) {
    var key = element.dataset.translateTitleKey;
    if (key && langTranslations[key]) {
      element.title = langTranslations[key];
    }
  });
}

function setLanguage(lang) {
  if (!window.translations[lang]) {
    lang = 'ja';
  }
  document.title_translation_key = window.pageTitleTranslationKey || document.title_translation_key;
  document.meta_description_translation_key = window.metaDescriptionTranslationKey || document.meta_description_translation_key;
  applyTranslations(lang);
  document.documentElement.lang = lang;
  localStorage.setItem('selectedLanguage', lang);
  var langSwitch = document.getElementById('lang-switch');
  if (langSwitch) {
    langSwitch.value = lang;
  }
}

document.addEventListener('DOMContentLoaded', function() {
  var langSwitch = document.getElementById('lang-switch');
  var detectedLang = 'ja';
  var savedLang = localStorage.getItem('selectedLanguage');
  if (savedLang && window.translations[savedLang]) {
    detectedLang = savedLang;
  } else if (navigator.language) {
    if (navigator.language.startsWith('en')) detectedLang = 'en';
    else if (navigator.language.startsWith('ja')) detectedLang = 'ja';
  }
  if (langSwitch) {
    langSwitch.value = detectedLang;
    langSwitch.addEventListener('change', function(e) {
      setLanguage(e.target.value);
    });
    setLanguage(detectedLang);
  } else {
    setLanguage(detectedLang);
  }
});

// --- 動的広告表示ロジック ---
function getUserToolHistory() {
  try {
    return JSON.parse(localStorage.getItem('toolHistory') || '[]');
  } catch { return []; }
}
function addUserToolHistory(tool) {
  let h = getUserToolHistory();
  if (!h.includes(tool)) h.push(tool);
  localStorage.setItem('toolHistory', JSON.stringify(h));
}
function getBestAd() {
  // ツール履歴からカテゴリ推定
  const history = getUserToolHistory();
  // 例: ツール名→カテゴリ
  const tool2cat = {
    'unit-converter': 'science',
    'image-converter': 'gadget',
    'qr-code-generator': 'gadget',
    'url-shortener': 'it',
    'date-calculator': 'office',
  };
  let cat = 'general';
  for (let i = history.length - 1; i >= 0; i--) {
    if (tool2cat[history[i]]) { cat = tool2cat[history[i]]; break; }
  }
  // カテゴリ別バナーリスト
  const ads = {
    science: [
      {type:'amazon', url:'https://www.amazon.co.jp/s?field-keywords=理系+便利グッズ&tag=negiab-22', img:'https://images-fe.ssl-images-amazon.com/images/G/09/associates/banners/amazon_banner_468x60.jpg', alt:'Amazon理系グッズ'},
      {type:'rakuten', url:'https://hb.afl.rakuten.co.jp/hsc/xxxxxx/?pc=https://www.rakuten.co.jp/', img:'https://hbb.afl.rakuten.co.jp/hgb/xxxxxx/banner/468x60.png', alt:'楽天理系グッズ'}
    ],
    gadget: [
      {type:'amazon', url:'https://www.amazon.co.jp/s?field-keywords=ガジェット&tag=negiab-22', img:'https://images-fe.ssl-images-amazon.com/images/G/09/associates/banners/amazon_banner_468x60.jpg', alt:'Amazonガジェット'},
      {type:'rakuten', url:'https://hb.afl.rakuten.co.jp/hsc/xxxxxx/?pc=https://www.rakuten.co.jp/', img:'https://hbb.afl.rakuten.co.jp/hgb/xxxxxx/banner/468x60.png', alt:'楽天ガジェット'}
    ],
    it: [
      {type:'amazon', url:'https://www.amazon.co.jp/s?field-keywords=IT+書籍&tag=negiab-22', img:'https://images-fe.ssl-images-amazon.com/images/G/09/associates/banners/amazon_banner_468x60.jpg', alt:'Amazon IT書籍'},
      {type:'rakuten', url:'https://hb.afl.rakuten.co.jp/hsc/xxxxxx/?pc=https://www.rakuten.co.jp/', img:'https://hbb.afl.rakuten.co.jp/hgb/xxxxxx/banner/468x60.png', alt:'楽天IT書籍'}
    ],
    office: [
      {type:'amazon', url:'https://www.amazon.co.jp/s?field-keywords=文房具&tag=negiab-22', img:'https://images-fe.ssl-images-amazon.com/images/G/09/associates/banners/amazon_banner_468x60.jpg', alt:'Amazon文房具'},
      {type:'rakuten', url:'https://hb.afl.rakuten.co.jp/hsc/xxxxxx/?pc=https://www.rakuten.co.jp/', img:'https://hbb.afl.rakuten.co.jp/hgb/xxxxxx/banner/468x60.png', alt:'楽天文房具'}
    ],
    general: [
      {type:'amazon', url:'https://www.amazon.co.jp/?tag=negiab-22', img:'https://images-fe.ssl-images-amazon.com/images/G/09/associates/banners/amazon_banner_468x60.jpg', alt:'Amazonバナー'},
      {type:'rakuten', url:'https://hb.afl.rakuten.co.jp/hsc/xxxxxx/?pc=https://www.rakuten.co.jp/', img:'https://hbb.afl.rakuten.co.jp/hgb/xxxxxx/banner/468x60.png', alt:'楽天バナー'}
    ]
  };
  // cookie同意判定
  const consent = localStorage.getItem('consentAccepted');
  let adList = ads[cat] || ads.general;
  if (!consent) {
    // 未同意ならランダム
    adList = [adList[Math.floor(Math.random()*adList.length)]];
  }
  // 複数候補からランダムで1つ選択（同意済みならカテゴリ最適化）
  return adList[Math.floor(Math.random()*adList.length)];
}
function renderDynamicAd(targetId) {
  const ad = getBestAd();
  const el = document.getElementById(targetId);
  if (el && ad) {
    el.innerHTML = `<a href="${ad.url}" target="_blank" rel="noopener noreferrer"><img src="${ad.img}" alt="${ad.alt}" style="height:60px;max-width:100%;" loading="lazy"></a>`;
  }
}

// --- Amazon・楽天バナー型動的最適化 ---
const AMAZON_ASSOC_ID = "negilab01-22";
const RAKUTEN_AFFILIATE_ID = "492cd2bc.3580938a.4910d748.d56fc6c6";
function renderSmartAds(targetId) {
  // cookie同意・履歴からカテゴリ推定
  const consent = localStorage.getItem('consentAccepted');
  let cat = 'general';
  if (consent) {
    const history = getUserToolHistory();
    const tool2cat = {
      'unit-converter': 'science',
      'image-converter': 'gadget',
      'qr-code-generator': 'gadget',
      'url-shortener': 'it',
      'date-calculator': 'office',
    };
    for (let i = history.length - 1; i >= 0; i--) {
      if (tool2cat[history[i]]) { cat = tool2cat[history[i]]; break; }
    }
  } else {
    // 未同意ならランダム
    const cats = ['science','gadget','it','office','general'];
    cat = cats[Math.floor(Math.random()*cats.length)];
  }
  // Amazon・楽天バナー型（img+a）をカテゴリ最適化で2つ横並び表示
  const banners = {
    science: [
      {type:'amazon', url:`https://www.amazon.co.jp/s?field-keywords=理系+便利グッズ&tag=${AMAZON_ASSOC_ID}`, img:'https://images-fe.ssl-images-amazon.com/images/G/09/associates/banners/amazon_banner_468x60.jpg', alt:'Amazon理系グッズ'},
      {type:'rakuten', url:`https://hb.afl.rakuten.co.jp/hsc/${RAKUTEN_AFFILIATE_ID}/?pc=https://www.rakuten.co.jp/`, img:'https://hbb.afl.rakuten.co.jp/hgb/${RAKUTEN_AFFILIATE_ID}/banner/468x60.png', alt:'楽天理系グッズ'}
    ],
    gadget: [
      {type:'amazon', url:`https://www.amazon.co.jp/s?field-keywords=ガジェット&tag=${AMAZON_ASSOC_ID}`, img:'https://images-fe.ssl-images-amazon.com/images/G/09/associates/banners/amazon_banner_468x60.jpg', alt:'Amazonガジェット'},
      {type:'rakuten', url:`https://hb.afl.rakuten.co.jp/hsc/${RAKUTEN_AFFILIATE_ID}/?pc=https://www.rakuten.co.jp/`, img:'https://hbb.afl.rakuten.co.jp/hgb/${RAKUTEN_AFFILIATE_ID}/banner/468x60.png', alt:'楽天ガジェット'}
    ],
    it: [
      {type:'amazon', url:`https://www.amazon.co.jp/s?field-keywords=IT+書籍&tag=${AMAZON_ASSOC_ID}`, img:'https://images-fe.ssl-images-amazon.com/images/G/09/associates/banners/amazon_banner_468x60.jpg', alt:'Amazon IT書籍'},
      {type:'rakuten', url:`https://hb.afl.rakuten.co.jp/hsc/${RAKUTEN_AFFILIATE_ID}/?pc=https://www.rakuten.co.jp/`, img:'https://hbb.afl.rakuten.co.jp/hgb/${RAKUTEN_AFFILIATE_ID}/banner/468x60.png', alt:'楽天IT書籍'}
    ],
    office: [
      {type:'amazon', url:`https://www.amazon.co.jp/s?field-keywords=文房具&tag=${AMAZON_ASSOC_ID}`, img:'https://images-fe.ssl-images-amazon.com/images/G/09/associates/banners/amazon_banner_468x60.jpg', alt:'Amazon文房具'},
      {type:'rakuten', url:`https://hb.afl.rakuten.co.jp/hsc/${RAKUTEN_AFFILIATE_ID}/?pc=https://www.rakuten.co.jp/`, img:'https://hbb.afl.rakuten.co.jp/hgb/${RAKUTEN_AFFILIATE_ID}/banner/468x60.png', alt:'楽天文房具'}
    ],
    general: [
      {type:'amazon', url:`https://www.amazon.co.jp/?tag=${AMAZON_ASSOC_ID}`, img:'https://images-fe.ssl-images-amazon.com/images/G/09/associates/banners/amazon_banner_468x60.jpg', alt:'Amazonバナー'},
      {type:'rakuten', url:`https://hb.afl.rakuten.co.jp/hsc/${RAKUTEN_AFFILIATE_ID}/?pc=https://www.rakuten.co.jp/`, img:'https://hbb.afl.rakuten.co.jp/hgb/${RAKUTEN_AFFILIATE_ID}/banner/468x60.png', alt:'楽天バナー'}
    ]
  };
  const el = document.getElementById(targetId);
  if (el) {
    const [amazon, rakuten] = banners[cat] || banners.general;
    el.innerHTML = `<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;align-items:center;">
      <a href="${amazon.url}" target="_blank" rel="noopener sponsored"><img src="${amazon.img}" alt="${amazon.alt}" style="height:60px;max-width:100%;" loading="lazy"></a>
      <a href="${rakuten.url}" target="_blank" rel="noopener sponsored"><img src="${rakuten.img}" alt="${rakuten.alt}" style="height:60px;max-width:100%;" loading="lazy"></a>
    </div>`;
  }
}
